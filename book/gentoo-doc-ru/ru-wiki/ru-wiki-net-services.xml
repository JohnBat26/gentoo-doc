<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbookxi.rng" type="xml"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0">
    <info>
        <title>Сетевые сервисы</title>
    </info>
    <section>
        <info>
            <title>Установка Apache2</title>
        </info>
        <section>
            <info>
                <title>Установка </title>
            </info>
            <para>Apache2 сейчас работает на большинстве системах без проблем, если у вас возникли
                проблемы прочтите раздел Common Problems это может помочь. </para>
            <para>Начнем установку apache2: добавьте "apache2" к вашим USE флагу в файле
                    <filename>/etc/make.conf</filename> и выполните: </para>
            <screen><prompt>#</prompt> <userinput>emerge apache</userinput></screen>
        </section>
        <section>
            <info>
                <title>Запуск Apache </title>
            </info>
            <para>Запустите Apache2: </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/apache2 start</userinput></screen>
            <para>Если вы хотите запускать apache2 при запуске системы выполните комманду: </para>
            <screen><prompt>#</prompt> <userinput>rc-update add apache2 default</userinput></screen>
            <para>Посмотрите <link xlink:href="#">Сценарии инициализации</link> для дополнительной
                информации. </para>
            <para>Теперь у вас есть работующий веб сервер Apache2. Перейдите в вашем браузере на
                страницу <link xlink:href="http://localhost/">http://localhost/</link> и вы должны
                увидеть страницу приветствия. </para>
            <para>Вы найдете в <filename>/var/www/localhost/htdocs/index.html</filename> HTML код
                страницы приветствия которую вы видите на <link xlink:href="http://localhost/"
                    >http://localhost/</link>. Замечаем что Apache отображает htdocs/index.html
                когда вы пытаетесь открыть htdocs/ . Это особенность протокола HTTP. Apache не может
                передать директорию но может показать содержимое. Список (index) файлов в директории
                может быть передан. Apache ищет страницу со специальным именем index либо генерирует
                список файлов в директории. Если у вас есть страница с именем 'index' то будет
                отображена она; в этом случае вы не сможете посмотреть список файлов в директории.
            </para>
        </section>
        <section>
            <info>
                <title>Модули </title>
            </info>
            <para>Apache очень гибок. Он может сёрфить файлы используя HTTP либо серфить файлы и
                помощью FTP. Он может передать файл с жесткого диска, либо вывод PHP скрипта. Для
                реализации этого Apache использует модули. Другие приложения используют для этого
                плагины. При добавлении модули добавляют функциональность. Их также можно
                инсталлировать, удалять, пересобирать (перекомпилировать). </para>
            <para>Модули Apache обычно называются
                    <code>mod_<replaceable>something</replaceable></code>. Некоторые уже включены в
                Апач а некоторые нужно добавлять отдельно. В портежах содержатся множество модулей.
                Процесс установки выглядит примерно так: </para>
            <orderedlist>
                <listitem>
                    <para><command>emerge module</command>;</para>
                </listitem>
                <listitem>
                    <para>отредактируйте <filename>/etc/conf.d/apache2</filename> для активации
                        добавьте -D MOD;</para>
                </listitem>
                <listitem>
                    <para>опционально <filename>/etc/apache2/modules.d/xy_module</filename>;</para>
                </listitem>
                <listitem>
                    <para>добавьте директивы конфигурации в <filename>httpd.conf</filename> либо
                            <filename>.htaccess</filename>;</para>
                </listitem>
            </orderedlist>
            <screen><prompt>#</prompt> <userinput>emerge mod_perl</userinput>
<prompt>#</prompt> <userinput>nano /etc/conf.d/apache2</userinput>
<lineannotation>change APACHE_OPTS="" to APACHE_OPTS="-D PERL"</lineannotation></screen>
            <para>Документацию по конкретным модулям вы найдете Apache Index in this wiki. Вы также
                можете почитать <link xlink:href="http://httpd.apache.org/docs/2.0/mod/"
                    >документацию</link> для дополнительной информации о модулях Apache. </para>
        </section>
        <section>
            <info>
                <title>Конфигурация </title>
            </info>
            <para>В файле <filename>httpd.conf</filename>
                    (<filename>/etc/apache2/httpd.conf</filename>), который поставляется с Gentoo
                хранятся большинство настроек Apache. However, it probably does both more and less
                than you need it to. Apache configuration files have a consistent syntax. </para>
            <para>Любые строки начинающиеся с <code>#</code> игнорируются </para>
            <programlisting># Apache не анализирует написанное здесь
# это комментарии</programlisting>
            <para>Некоторые строки начинаются с директивы и могут иметь один или несколько
                аргументов. </para>
            <programlisting>SomeDirective one or more arguments</programlisting>
            <para>Директивы могут быть объединены в секции. Разделы обычно заключены в угловые
                скобки. </para>
            <programlisting>&lt;Section>
  # Will only apply when the section matches
  AnotherDirective
&lt;/Section></programlisting>
            <para>В разделе могут быть подразделы. Вот часть файла
                <filename>httpd.conf</filename>:</para>
            <programlisting># If mod_alias is loaded
&lt;IfModule mod_alias.c>
    # Alias is a directive and it only applies if mod_alias is loaded
    Alias /icons/ "/usr/share/httpd/icons/"
    # If the file is in the directory
    &lt;Directory "/usr/share/httpd/icons">
        # Options will only apply if:
        #   mod_alias is loaded AND
        #   the file is in the directory
        Options Indexes MultiViews
    &lt;/Directory>
&lt;/IfModule></programlisting>
            <para>Вы можете прочитать подробнее configuration files и sections в оффициальная
                документация Apache. </para>
        </section>
        <section>
            <title>Common Problems </title>
            <section>
                <title>SSI Not Working </title>
                <para>When configuring for SSI (Server Side Includes), an error may occur: </para>
                <programlisting>mod_include: Options +Includes (or IncludesNoExec) wasn't set, INCLUDES filter removed</programlisting>
                <para>The problem is that setting Options +Includes in either .htaccess or
                    httpd.conf is overwritten by the additional configuration file as defined at the
                    end of httpd.conf. </para>
                <programlisting>Include /etc/apache2/vhosts.d/*.conf</programlisting>
                <para>You need to edit this additional configuration file such that </para>
                <programlisting>AllowOverride None</programlisting>
                <para>Is replaced by </para>
                <programlisting>AllowOverride Options</programlisting>
            </section>
            <section>
                <title>Could Not Open Error Log </title>
                <para>While starting Apache, it prints: </para>
                <screen>Error while starting apache: (2)No such file or directory: apache2: could not open error log file /usr/lib/apache2/logs/error_log.</screen>
                <para><filename>/usr/lib/apache2/logs</filename> should be a symlink pointing to
                        <filename>/var/log/apache2</filename>. Check it using: </para>
                <screen><prompt>#</prompt> <userinput>ls -la /usr/lib/apache2/logs</userinput></screen>
                <para>(note the lack of a slash on the end). If
                        <filename>/var/log/apache2</filename> is missing, create it and make sure
                    you give apache ownership: </para>
                <screen><prompt>#</prompt> <userinput>mkdir /var/log/apache2</userinput>
<prompt>#</prompt> <userinput>chown apache:apache /var/log/apache2</userinput></screen>
                <para>If the symlink <filename>/usr/lib/apache2/logs</filename> is missing, you can
                    create it: </para>
                <screen><prompt>#</prompt> <userinput>ln -s /var/log/apache2 /usr/lib/apache2/logs</userinput></screen>
                <para>You don't need to set permissions on the symlink. </para>
            </section>
            <section>
                <title>Check the Logs </title>
                <para>See <filename>/var/log/apache2/error_log</filename> for errors, especially
                    towards the end of the file. You may find tail useful because it displays only
                    the last few lines of a file: </para>
                <screen><prompt>#</prompt> <userinput>tail /var/log/apache2/error_log</userinput></screen>
                <para>If you wish to keep an eye one the log the -f option for tail may be useful: </para>
                <screen><prompt>#</prompt> <userinput>tail -f /var/log/apache2/error_log</userinput></screen>
                <para>Here's one error you might see: </para>
                <screen>Error: [alert] (EAI 2)Name or service not known: mod_unique_id: unable to find IPv4 address of ""</screen>
                <para>With the base installation "mod_unique_id" is turned on, this can cause
                    problems, notably the server not starting. Simply comment out this module in
                    /etc/apache2/httpd.conf and the problem will be solved. </para>
                <para>(Your config file might be
                    <filename>/etc/apache2/conf/apache2.conf</filename>) </para>
            </section>
            <section>
                <title>Forbidden User Directories </title>
                <para>If the server is returning "403 Forbidden" while accessing
                    http://server/~username/ Make sure Apache (usually user apache and group apache)
                    has read access to username's home directory and public_html (or equivalent).
                    You can grant everyone read access using: </para>
                <screen><prompt>#</prompt> <userinput>chmod 755 ~username/ ~username/public_html/</userinput></screen>
            </section>
            <section>
                <title>Not Enough Entropy </title>
                <para>If Apache2 </para>
                <itemizedlist>
                    <listitem>
                        <para>accepts connections</para>
                    </listitem>
                    <listitem>
                        <para>does not respond to clients</para>
                    </listitem>
                    <listitem>
                        <para>creates exactly one process</para>
                    </listitem>
                    <listitem>
                        <para>is not stopped by</para>
                        <screen><prompt>#</prompt> <userinput>/etc/init.d/apache2 stop</userinput></screen>
                    </listitem>
                </itemizedlist>
                <para>Check to see how much entropy is available using: </para>
                <screen><prompt>#</prompt> <userinput>cat /proc/sys/kernel/random/entropy_avail</userinput></screen>
                <para>If little entropy (less than 100) is available, Apache2 is probably waiting
                    for more so it can generate the secret for digest authentication
                    (mod_auth_digest). To generate more entropy, just do something else for a little
                    while. Grepping the kernel or emerging a package usually works well. </para>
                <para>The <link xlink:href="http://www.vanheusden.com/ved/">video-entropyd</link>
                    and <link xlink:href="http://www.vanheusden.com/aed/">audio-entropyd</link>
                    supply <filename>/dev/random</filename> with entropy gathered from your video
                    and audio devices, respectively. If you have a hardware random number generator
                    (RNG), you can <command>emerge rng-tools</command> and run
                        <command>rngd</command>. </para>
                <para>If there's still a shortage of entropy, you can enable the urandom USE flag
                    and re-emerge APR and Apache2. This makes APR use /dev/urandom, which falls back
                    to a pseudorandom number generator when there isn't enough entropy. The program
                    gets a number immediately, but it is cryptographically weaker. This is okay for
                    some things (e.g. solitaire), but completely unacceptable for others (like PGP
                    key generation). </para>
            </section>
            <section>
                <title>Confusing config files </title>
                <para>If you start the Apache2 server with the startup script
                        <filename>/etc/init.d/apache2</filename> check to see if the line </para>
                <programlisting>local myconf="/etc/apache2/httpd.conf" </programlisting>
                <para>from <filename>/etc/init.d/apache2</filename> points to your configuration
                    script. If it points to <filename>apache.conf</filename> and you use
                        <filename>httpd.conf</filename>, make the necessary adjustments. </para>
            </section>
        </section>
        <section>
            <info>
                <title>See Also </title>
            </info>
            <para><link xlink:href="http://blog.eukhost.com/2006/10/11/apache-installation/">Apache
                    Installation &amp; Configuration</link></para>
            <para><link
                    xlink:href="http://blog.webhosting.uk.com/2006/04/28/how-to-install-mod_security-for-apache/"
                    >How to install mod_security for Apache</link></para>
        </section>
    </section>
    <section>
        <info>
            <title>Настройка iptables для начинающих</title>
        </info>
        <section>
            <title>Введение </title>
            <para><indexterm>
                    <primary>iptables</primary>
                </indexterm>В сети мало документации по iptables рассчитанной на новичков. Мы же
                попытаемся восполнить этот пробел. Рассмотрим основы составления правил, а также
                некоторые дополнительные модули которые помогут сделать жизнь легче. </para>
            <section>
                <title>Прежде чем двигаться дальше — убедитесь, что ... </title>
                <orderedlist>
                    <listitem>
                        <para>Всё ваше аппаратное обеспечение работоспособно. То есть Вы подключили
                            все оборудование, модули грузятся, устройства видны в системе. Полезно в
                            начале проверить, что соединение с интернетом возможно и без всяких там
                            iptables. Нет ничего хуже, чем в течении многих часов возиться с упрямой
                            программой, ругая её почём зря, а потом понять, что сетевая карта не
                            работает или модем сконфигурирован неправильно. </para>
                    </listitem>
                    <listitem>
                        <para>Вы имеете представление о сетевых технологиях и Вы знакомы с
                            администрированием Linux и Gentoo Linux в частности. То есть необходимы
                            навыки работы с такими базовыми вещами как ifconfig, rc-update,
                                <filename>/etc/conf.d/net</filename>, и так далее. Если для Вас это
                            пока пустые звуки, то, пожалуйста предварительно изучите <link
                                xlink:href="#">Настольную книгу Gentoo</link> и <link
                                xmlns:xlink="http://www.w3.org/1999/xlink"
                                xlink:href="http://www.linuxhelp.ca/guides/networkbasics/">Linux
                                Help's Networking Basics 101</link>
                        </para>
                    </listitem>
                </orderedlist>
            </section>
            <section>
                <title>Конфигурация ядра ОС Linux </title>
                <para>Все что вам нужно — это включить поддержку iptables.</para>
                <screen>Networking --->
  Networking Options---->
   Network Packet Filtering (replace Ipchains)--->
    Netfilter Configuration</screen>
                <para>Включим все опции как модули (хотя с точки зрения безопасности модули следует
                    вообще отключить, монолитное ядро надежнее, хотя и медленнее). </para>
            </section>
            <section>
                <title>Установка iptables </title>
                <para>Далее вы должны установить пакет iptables:</para>
                <screen><prompt>#</prompt> <userinput>emerge iptables </userinput></screen>
            </section>
            <section>
                <title>Проверка сети </title>
                <para>Предположим, что у нас есть 2 сетевых интерфейса: eth0 — локальная сеть и ppp0
                    — интернет соединение.</para>
                <para>Проверим работоспособность сети командой ping:</para>
                <example>
                    <title>ping</title>
                    <screen><prompt>#</prompt> <userinput>ping www.google.com</userinput>
<prompt>#</prompt> <userinput>ping 192.168.1.78</userinput>
<prompt>#</prompt> <userinput>ping 192.168.2.77</userinput></screen>
                </example>
            </section>
            <section>
                <title>Запуск iptables </title>
                <para>Запустим iptables:</para>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/iptables start</userinput></screen>
                <para>Эта команда загрузит основные модули и создаст цепочки в ядре Linux. Теперь
                    добавим iptables в автозагрузку:</para>
                <screen><prompt>#</prompt> <userinput>rc-update add iptables default </userinput></screen>
            </section>
            <section>
                <title>Использование /etc/init.d/iptables </title>
                <para>Скрипт <filename>/etc/init.d/iptables</filename> понимает несколько команд
                        (<command>/etc/init.d/iptables
                        <replaceable>&lt;команда&gt;</replaceable></command>), некоторые из них: </para>
                <itemizedlist>
                    <listitem>
                        <para>start — запуск iptables. Восстанавливает все правила (правила хранятся
                            в <filename>/var/lib/iptables/rules-save</filename>); </para>
                    </listitem>
                    <listitem>
                        <para>stop — сброс всех цепочек; </para>
                    </listitem>
                    <listitem>
                        <para>save — сохранение всех правил. </para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section>
            <title>Создание правил </title>
            <para>Практически все правила можно привести к виду:</para>
            <screen><prompt>#</prompt> <userinput>iptables -A <replaceable>ЦЕПОЧКА</replaceable> <replaceable>ПАРАМЕТРЫ_ПАКЕТА</replaceable> -j <replaceable>ДЕЙСТВИЕ</replaceable></userinput></screen>
            <section>
                <title>Цепочки</title>
                <para>Все изменения будем проводить над таблицей filter, именно она отвечает за
                    фильтрацию пакетов. В таблице filter существует 3 цепочки: <code>INPUT</code>,
                        <code>OUTPUT</code> и <code>FORWARD</code>. В каждой цепочки свой "тип"
                    пакетов: </para>
                <itemizedlist>
                    <listitem>
                        <para><code>INPUT</code> — пакеты пришедшие к Вам. То есть входящий трафик.
                        </para>
                    </listitem>
                    <listitem>
                        <para><code>FORWARD</code> — пакеты которые предназначены для другого узла,
                            то есть транзитный трафик. </para>
                    </listitem>
                    <listitem>
                        <para><code>OUTPUT</code> — пакеты, которые уходят от нас, или исходящий
                            трафик. </para>
                    </listitem>
                </itemizedlist>
                <para>Работают с цепочками так:</para>
                <screen><prompt>#</prompt> <userinput>iptables <replaceable>&lt;опция&gt;</replaceable> <replaceable>&lt;цепочка&gt;</replaceable></userinput></screen>
                <para>Для работы с цепочками предусмотрены следующие опции: </para>
                <itemizedlist>
                    <listitem>
                        <para><option>-A</option> — добавление нового правила в цепочку. Правило
                            будет добавлено в конец цепочки. </para>
                    </listitem>
                    <listitem>
                        <para><option>-I</option> — добавление правила не в конец,а туда куда вы
                            укажите. Например команда: </para>
                        <para><command>iptables -I INPUT 2 bla-bla-bla</command> — сделает наше
                            правило вторым. </para>
                    </listitem>
                    <listitem>
                        <para><option>-D</option> — удаление правила. Например для удаления пятого
                            правила введите: </para>
                        <para><command>iptables -D INPUT 5</command></para>
                    </listitem>
                    <listitem>
                        <para><option>-F</option> — сброс всех правил цепочки. Нужно, например,при
                            удалении ненужной цепочки. </para>
                    </listitem>
                    <listitem>
                        <para><option>-N</option> — создание пользовательской цепочки. Если не
                            хотите создавать кашу в каждой цепочке, то создайте несколько
                            дополнительных цепочек. Синтаксис такой: iptables -N ЦЕПОЧКА. Только
                            русские буквы, конечно, использовать нельзя. </para>
                    </listitem>
                    <listitem>
                        <para><option>-X</option> — удаление пользовательской цепочки. </para>
                        <note>
                            <para>Удалить цепочки INPUT, OUTPUT и FORWARD нельзя. </para>
                        </note>
                    </listitem>
                    <listitem>
                        <para>-P — установка политики для цепочки. Например: </para>
                        <para>iptables -P ЦЕПОЧКА ПОЛИТИКА </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>Параметры пакетов </title>
                <para>Итак по каким параметрам можно фильтровать пакеты? Рассмотрим самые основные. </para>
                <section>
                    <title>Источник пакета</title>
                    <para>Для фильтрации по источнику используется опция -s. Например запретим все
                        входящие пакеты с узла 192.168.133.133:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s 192.168.133.133 -j DROP</userinput></screen>
                    <para>Можно использовать доменное имя для указания адреса хоста. То есть:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s test.host.jp -j DROP </userinput></screen>
                    <para>Также можно указать целую подсеть:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s 192.168.133.0/24 -j DROP</userinput></screen>
                    <para>Также вы можете использовать отрицание (знак <code>!</code>). Например так
                        — все пакеты с хостов отличных от 192.168.133.156 будут уничтожаться:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s ! 192.168.133.156 -j DROP</userinput></screen>
                </section>
                <section>
                    <title>Адрес назначения </title>
                    <para>Для этого нужно использовать опцию <option>-d</option>. Например запретим
                        все исходящие пакеты на хост 192.168.156.156:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A OUTPUT -d 192.168.156.156 -j DROP</userinput></screen>
                    <para>Как и в случае с источником пакета можно использовать адреса подсети и
                        доменные имена. Отрицание также работает. </para>
                </section>
                <section>
                    <title>Протокол </title>
                    <para>Опция <option>-p</option> указывает на протокол. Можно использовать
                            <code>all</code>, <code>icmp</code>, <code>tcp</code>, <code>udp
                        </code>или номер протокола (из <filename>/etc/protocols</filename>).</para>
                </section>
                <section>
                    <title>Порт источника </title>
                    <para>Указывает на порт с которого был прислан пакет. Вот синтаксис:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -p tcp --sport 80 -j ACCEPT</userinput></screen>
                    <para>Для указания порта необходимо указать протокол (tcp или udp). Можно
                        использовать отрицание. </para>
                </section>
                <section>
                    <title>Порт назначения </title>
                    <para>Порт назначения. Синтаксис:</para>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -p tcp --dport 80 -j ACCEPT</userinput></screen>
                    <para>Как и в случае с портом источника нужно указать протокол. Можно
                        использовать отрицание. </para>
                </section>
            </section>
        </section>
        <section>
            <title>Действия над пакетами </title>
            <para>Проку от того,что мы укажем параметры пакета нет.Нужно указать,что надо с ним
                делать. Для этого служит опция <option>-j</option>. Рассмотрим основные действия: </para>
            <orderedlist>
                <listitem>
                    <para><code>ACCEPT</code> — разрешить пакет. </para>
                </listitem>
                <listitem>
                    <para><code>DROP</code> — уничтожить пакет. </para>
                </listitem>
                <listitem>
                    <para><code>REJECT</code> — будет отправлено ICMP сообщение, что порт
                        недоступен. </para>
                </listitem>
                <listitem>
                    <para><code>LOG</code> — информация об этом пакете будет добавлена в системный
                        журнал (<link xmlns:xlink="http://www.w3.org/1999/xlink"
                            xlink:href="http://ru.gentoo-wiki.com/index.php?title=Man_syslog&amp;action=edit"
                            >syslog</link>). </para>
                </listitem>
            </orderedlist>
            <para>В качестве действия можно указать и имя пользовательской цепочки. Например
                перекинем все пакеты с локальной сети в цепочку, где будет производиться
                дополнительная проверка:</para>
            <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s 192.168.200.0/24 -j LOCAL_NET</userinput></screen>
        </section>
        <section>
            <title>Пример правил </title>
            <para>В большистве случаев пользователю достаточно выполнить такую последовательность
                комманд:</para>
            <screen><prompt>#</prompt> <userinput>iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</userinput>
<prompt>#</prompt> <userinput>iptables -A INPUT -i lo -j ACCEPT</userinput>
<prompt>#</prompt> <userinput>iptables -P INPUT DROP</userinput></screen>
            <para>Вот собственно и вся настройка. На первый взгляд непонятно, что мы тут вообще
                сделали. Поэтому ознакомимся с основами составления правил. </para>
        </section>
        <section>
            <title>Модули </title>
            <para>Может сложиться впечатление, что возможностей у iptables маловато. Однако с
                использованием модулей iptables получит просто безграничные возможности. Для
                указания модуля используется опция <option>-m</option>. Например:</para>
            <screen><prompt>#</prompt> <userinput>iptables -A INPUT -m модуль bla-bla </userinput></screen>
            <section>
                <title>-m owner </title>
                <para>Добавляет следующие опции (опции только для цепочки OUTPUT): </para>
                <itemizedlist>
                    <listitem>
                        <para><option>--uid-owner <replaceable>UID</replaceable></option> — UID
                            программы пославшей пакет. </para>
                    </listitem>
                    <listitem>
                        <para><option>--gid-owner <replaceable>GID</replaceable></option> — GID
                            прораммы пославшей пакет. </para>
                    </listitem>
                    <listitem>
                        <para><option>--pid-owner <replaceable>PID</replaceable></option> — PID
                            программы пославшей пакет. </para>
                    </listitem>
                    <listitem>
                        <para><option>--sid-owner <replaceable>SID</replaceable></option> — SID
                            (идентификатор сессии) производится проверка SID пакета, значение SID
                            наследуются дочерними процессами от "родителя". </para>
                    </listitem>
                    <listitem>
                        <para><option>--cmd-owner <replaceable>NAME</replaceable></option> — имя
                            программы пославшей пакет. </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>-m multiport </title>
                <para>Позволяет указывать не по одному порту, а сразу несколько: </para>
                <itemizedlist>
                    <listitem>
                        <para><option>--source-ports
                                    <replaceable>порт1</replaceable>,<replaceable>порт2</replaceable></option>
                            — список портов, с которых пришел пакет; </para>
                    </listitem>
                    <listitem>
                        <para><option>--sports
                                    <replaceable>порт1</replaceable>,<replaceable>порт2</replaceable></option>
                            — укороченый аналог <option>--source-ports</option>; </para>
                    </listitem>
                    <listitem>
                        <para><option>--destination-ports
                                    <replaceable>порт1</replaceable>,<replaceable>порт2</replaceable></option>
                            — список портов назначения; </para>
                    </listitem>
                    <listitem>
                        <para><option>--dports
                                    <replaceable>порт1</replaceable>,<replaceable>порт2</replaceable></option>
                            — укороченый аналог <option>--destination-ports</option>; </para>
                    </listitem>
                    <listitem>
                        <para><option>--ports
                                    <replaceable>порт1</replaceable>,<replaceable>порт2</replaceable></option>
                            — проверяет как исходящий так и входящий порт пакета. </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>-m state </title>
                <para>Предназначен для указания состояния пакета с помощью опции --state. Доступны
                    следующие типы пакетов: </para>
                <itemizedlist>
                    <listitem>
                        <para><code>NEW</code> — пакет устанавливающий новое соединение. </para>
                    </listitem>
                    <listitem>
                        <para><code>ESTABLISHED</code> — пакет от уже установленного соединения.
                        </para>
                    </listitem>
                    <listitem>
                        <para><code>RELATED</code> — новый пакет уже установленном соединении.
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>-m mac </title>
                <para>Проверяет соответствие MAC-адреса в пакете с помощью опции --mac-source,
                    например: </para>
                <screen><prompt>#</prompt> <userinput>iptables -A INPUT -s 192.168.0.1 -m mac --mac-source 00:65:3F:ED:12:98 -j DROP</userinput></screen>
                <para>Получено с <link xmlns:xlink="http://www.w3.org/1999/xlink"
                        xlink:href="http://ru.gentoo-wiki.com/Настройка_iptables_для_начинающих"
                        >http://ru.gentoo-wiki.com/Настройка_iptables_для_начинающих</link></para>
            </section>
        </section>
    </section>
    <section>
        <info>
            <title>Подробная настройка iptables</title>
        </info>
        <section>
            <info>
                <title>Введение</title>
            </info>
            <para>Документация по iptables в сети не рассчитана на новичков. В этой статье будет
                сжато и быстро описаны команды, затем, возможно, будут правки и добавления для
                расширенного объяснения. Так что это будет минимальная установка которую мы в
                дальнейшем расширим и упрочим с помощью правил. </para>
            <para>Так же примите во внимание, что будет использовано pppoe соединение и 2.6.x ядро.
                Для настройки сетевой карты надо будет заменить ppp0 на eth0 (или подходящий по
                смыслу ваш сетевой интерфейс глядящий в интернет) </para>
            <para> Прежде чем двигаться дальше — убедитесь, что ...</para>
            <orderedlist>
                <listitem>
                    <para>Всё ваше аппаратное обеспечение работоспособно. То есть вы все подключили,
                        модули грузятся, устройства видны в системе. Полезно вначале проверить, что
                        соединение с интернетом возможно и без всяких там iptables. Нет ничего хуже,
                        чем в течение многих часов возиться с упрямой программой, ругая её почём
                        зря, а потом понять, что сетевая плата не работает или модем сконфигурирован
                        неправильно. </para>
                </listitem>
                <listitem>
                    <para>Вы читали маны по теме. Предполагается, что, пока вы изучаете это
                        руководство, man iptables постоянно открыт в соседнем терминале для точного
                        понимания и уточнения, что же та или иная команда означает на самом деле.
                    </para>
                </listitem>
                <listitem>
                    <para>Вы имеете представление о сетевых технологиях и Вы знакомы с
                        администрированием Linux и Gentoo Linux в частности. То есть необходимы
                        навыки работы с такими базовыми вещами как <link
                            xmlns:xlink="http://www.w3.org/1999/xlink"
                            xlink:href="http://ru.gentoo-wiki.com/index.php?title=Ifconfig&amp;action=edit"
                            >ifconfig</link>, <link xmlns:xlink="http://www.w3.org/1999/xlink"
                            xlink:href="http://ru.gentoo-wiki.com/index.php?title=Rc-update&amp;action=edit"
                            >rc-update</link>, /etc/conf.d/net, и так далее. Если для вас это пока
                        пустые звуки, то, пожалуйста предварительно изучите <link
                            xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#">The Gentoo
                            Handbook</link> и <link xmlns:xlink="http://www.w3.org/1999/xlink"
                            xlink:href="http://www.linuxhelp.ca/guides/networkbasics/">Linux Help's
                            Networking Basics 101</link>
                    </para>
                </listitem>
            </orderedlist>
        </section>
        <section>
            <info>
                <title>Конфигурация ядра</title>
            </info>
            <para>Все что вам нужно — это включить поддержку iptables. </para>
            <example>
                <title>Linux Kernel Configuration: Включение IPTables </title>
                <screen>Device Drivers--->
 Networking Support--->
  Networking Options---->
   Network Packet Filtering (replace Ipchains)--->
    Netfilter Configuration</screen>
            </example>
            <para>Я включил все опции как модули (с тем рассчетом, что я захочу попробовать другие
                опции позже) и добавил ip_tables в modules.autoload. Это загрузит еще несколько
                модулей в качестве зависимостей. Модуль ip_conntrack необходим для "statefull"
                фильтрования, то есть для отслеживания соединений. Для запуска скриптов выполните
                команду : </para>
            <screen><prompt>#</prompt> <userinput>modprobe ip_tables</userinput></screen>
        </section>
        <section>
            <info>
                <title>Необходимые утилиты</title>
            </info>
            <para>Далее вы должны установить пакет iptables: </para>
            <screen><prompt>#</prompt> <userinput>emerge iptables </userinput></screen>
        </section>
        <section>
            <info>
                <title>Конфигурация интерфейсов</title>
            </info>
            <para>
                <link xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс">Сетевые
                    протоколы</link>
            </para>
            <informaltable frame="all">
                <tgroup cols="2">
                    <tbody>
                        <row>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс#.D0.9F.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D1.8B_.D1.83.D1.80.D0.BE.D0.B2.D0.BD.D1.8F_.D0.BF.D1.80.D0.B8.D0.BB.D0.BE.D0.B6.D0.B5.D0.BD.D0.B8.D1.8F"
                                        >Прикладной уровень</link>
                                </para>
                            </entry>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=HTTP&amp;action=edit"
                                        >HTTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=SMTP&amp;action=edit"
                                        >SMTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=SSH&amp;action=edit"
                                        >SSH</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=SNMP&amp;action=edit"
                                        >SNMP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/FTP">FTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=NNTP&amp;action=edit"
                                        >NNTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=NTP&amp;action=edit"
                                        >NTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=LDAP&amp;action=edit"
                                        >LDAP</link>, ...</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс#.D0.9F.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D1.8B_.D1.81.D0.B5.D0.B0.D0.BD.D1.81.D0.BE.D0.B2.D0.BE.D0.B3.D0.BE_.D1.83.D1.80.D0.BE.D0.B2.D0.BD.D1.8F"
                                        >Сеансовый уровень</link>
                                </para>
                            </entry>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=TLS&amp;action=edit"
                                        >TLS</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=SSL&amp;action=edit"
                                        >SSL</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=RPC&amp;action=edit"
                                        >RPC</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=WSP&amp;action=edit"
                                        >WSP</link>...</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс#.D0.9F.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D1.8B_.D1.82.D1.80.D0.B0.D0.BD.D1.81.D0.BF.D0.BE.D1.80.D1.82.D0.BD.D0.BE.D0.B3.D0.BE_.D1.83.D1.80.D0.BE.D0.B2.D0.BD.D1.8F"
                                        >Транспортный уровень</link>
                                </para>
                            </entry>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=TCP&amp;action=edit"
                                        >TCP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=UDP&amp;action=edit"
                                        >UDP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=SCTP&amp;action=edit"
                                        >SCTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/ICMP">ICMP</link>,
                                        <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/OSPF">OSPF</link>,
                                        <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=RSVP&amp;action=edit"
                                        >RSVP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=VRRP&amp;action=edit"
                                        >VRRP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/RTP">RTP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=DCCP&amp;action=edit"
                                        >DCCP</link> ...</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс#.D0.9F.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D1.8B_.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D0.BE.D0.B3.D0.BE_.D1.83.D1.80.D0.BE.D0.B2.D0.BD.D1.8F"
                                        >Сетевой уровень</link>
                                </para>
                            </entry>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/IP">IPv4</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=IPv6&amp;action=edit"
                                        >IPv6</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/ARP">ARP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=RARP&amp;action=edit"
                                        >RARP</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=MPLS&amp;action=edit"
                                        >MPLS</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=IPX&amp;action=edit"
                                        >IPX</link> ...</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/Сетевые_протоколы_индекс#.D0.9F.D1.80.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.BB.D1.8B_.D0.BA.D0.B0.D0.BD.D0.B0.D0.BB.D1.8C.D0.BD.D0.BE.D0.B3.D0.BE_.D1.83.D1.80.D0.BE.D0.B2.D0.BD.D1.8F"
                                        >Канальный уровень</link>
                                </para>
                            </entry>
                            <entry>
                                <para>
                                    <link xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=Ethernet&amp;action=edit"
                                        >Ethernet</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=IEEE_802&amp;action=edit"
                                        >802.11</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=DSL&amp;action=edit"
                                        >xDSL</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=Fibre_Channel&amp;action=edit"
                                        >Fibre Channel</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=FDDI&amp;action=edit"
                                        >FDDI</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=ATM&amp;action=edit"
                                        >ATM</link>, <link
                                        xmlns:xlink="http://www.w3.org/1999/xlink"
                                        xlink:href="http://ru.gentoo-wiki.com/index.php?title=ISDN&amp;action=edit"
                                        >ISDN</link> ...</para>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </informaltable>
            <para>В моем случае имеется 3 сетевых адаптера. Один подключен к <link
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="http://ru.gentoo-wiki.com/WAN">WAN</link> через pppoe. Другие два —
                к моей внутренней сети. Для того, чтобы не было проблем с iptables и маскардингом
                    (<link xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="http://ru.gentoo-wiki.com/NAT">NAT</link>'ом), они должны быть
                сконфигурированы для различных подсетей. Для примера, 2 сетевых адаптера подключены
                к моим внутренним компьютерам (внутренние сетевые интерфейсы). Им присвоены
                IP-адреса: 192.168.1.1 и 192.168.2.1. </para>
            <para>Следует заметить, что будет лучше если подключать эти внутренние адаптеры в любое
                сетевое устройство, такие как свитч и хаб. Для pppoe подключений мы должны
                убедиться, что сетевой адаптер подключен к внешнему миру, то есть внешним
                интерфейсам не присвоены никакие IP-адреса. Его запись в
                    <filename>/etc/conf.d/net</filename> должна оставаться пустой. Это делается
                потому, что pppoe выступает в качестве виртуального устройства, которое включается
                вслед за сетевым интерфейсом. Мы также должны присвоить правильные сетевые маски и
                широковещательные адреса для этих интерфейсов. Ваш conf.d/ должна выглядеть примерно
                так: </para>
            <para>Сервер</para>
            <example>
                <title>Файл: /etc/conf.d/net </title>
                <programlisting># Для pppoe подключений вы не должны указывать значения для [[eth0]], 
# просто добавьте net.ppp0 или rc-pppoe в default уровень загрузки.
iface_eth0="192.168.1.1 broadcast 192.168.1.255 netmask 255.255.255.0"
iface_eth1="192.168.2.1 broadcast 192.168.2.255 netmask 255.255.255.0"</programlisting>
            </example>
            <para>Заметьте, что не было указано никаких шлюзов. </para>
            <para>Клиент1</para>
            <example>
                <title>Файл: <filename>/etc/conf.d/net </filename></title>
                <programlisting>iface_eth0="192.168.1.77 broadcast 192.168.1.255 netmask 255.255.255.0"
gateway="eth0/192.168.1.1"</programlisting>
            </example>
            <para>Клиент2</para>
            <example>
                <title>Файл: <filename>/etc/conf.d/net</filename></title>
                <programlisting>iface_eth0="192.168.2.77 broadcast 192.168.2.255 netmask 255.255.255.0"
gateway="eth0/192.168.2.1"</programlisting>
            </example>
            <para>Шлюз для клиентов установлен на внутренний IP сетевого интерфейса сервера, что и
                логично. Теперь добавьте все интерфейсы в default уровень загрузки и перезапустите
                подключения: </para>
            <screen><prompt>#</prompt> <userinput>rc-update add net.eth1 default &amp;&amp; rc-update add net.eth2 default &amp;&amp; rc-update add net.ppp0 default </userinput></screen>
            <para>и </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/net.eth1 start &amp;&amp; /etc/init.d/net.eth2 start &amp;&amp; /etc/init.d/net.ppp0 start </userinput></screen>
            <orderedlist>
                <listitem>
                    <para>Для клиентов: </para>
                </listitem>
            </orderedlist>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/net.eth0 restart</userinput></screen>
        </section>
        <section>
            <info>
                <title>Проверка настроек</title>
            </info>
            <para>Теперь убедитесь в том, что ваш сервер подключен к интернету, а также все
                интерфейсы могут пинговать друг друга. Для сервера: </para>
            <example>
                <title>ping</title>
                <screen><prompt>#</prompt> <userinput>ping www.google.com</userinput>
<prompt>#</prompt> <userinput>ping 192.168.1.78</userinput>
<prompt>#</prompt> <userinput>ping 192.168.2.78</userinput>
<prompt>#</prompt> <userinput>ping 192.168.1.77</userinput>
<prompt>#</prompt> <userinput>ping 192.168.2.77</userinput></screen>
            </example>
            <para>Убедитесь что у клиентов правильно указаны <link
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="http://ru.gentoo-wiki.com/DNS">DNS</link>-сервера в
                    <filename>/etc/resolv.conf </filename></para>
        </section>
        <section>
            <info>
                <title>Scripting</title>
            </info>
            <para>Теперь интересная часть... iptables и NAT(трансляция адресов). Для начала сделаем
                простое перенаправление адресов с минимальными правилами, чтобы убедиться что можем
                выходить в сеть. </para>
            <warning>
                <para>Если вы параноик, то это не самое секретное, что можно сделать... мы
                    открываемся в сеть с мизерной защитой. Однако будем считать, что сеть
                    настраиваем для дома или для игрового класса. </para>
            </warning>
            <example>
                <title>Файл: <filename>/var/lib/iptables/rules-save</filename></title>
                <programlisting>#!/bin/bash
IPTABLES='/sbin/iptables'
# Определяем интерфейсы
EXTIF='ppp0'
INTIF1='eth1'
INTIF2='eth2'
# Включаем форвардинг ip в ядре.
/bin/echo 1 > /proc/sys/net/ipv4/ip_forward
# Сбросить правила и удалить цепочки 
$IPTABLES -F
$IPTABLES -t nat -F
$IPTABLES -t mangle -F
$IPTABLES -X
$IPTABLES -t nat -X
$IPTABLES -t mangle -X
# Включаем маскарадинг для разрешения доступа в интернет
$IPTABLES -t nat -A POSTROUTING -o $EXTIF -j MASQUERADE
# Форвардить сетевой трафик с $INTIF1 на интернетовский интерфейс $EXTIF
$IPTABLES -A FORWARD -i $INTIF1 -o $EXTIF -m state --state NEW,ESTABLISHED -j ACCEPT
# Форвардить сетевой трафик с $INTIF2 на интернетовский интерфейс $EXTIF
$IPTABLES -A FORWARD -i $INTIF2 -o $EXTIF -m state --state NEW,ESTABLISHED -j ACCEPT
#echo -e "       — Разрешаем доступ к SSH серверу"
$IPTABLES -A INPUT --protocol tcp --dport 22 -j ACCEPT
#echo -e "       — Разрешаем доступ к HTTP серверу"
$IPTABLES -A INPUT --protocol tcp --dport 80 -j ACCEPT
# Блокируем все прочие попытки доступа на $EXTIF
$IPTABLES -A INPUT -i $EXTIF -m state --state NEW,INVALID -j DROP
$IPTABLES -A FORWARD -i $EXTIF -m state --state NEW,INVALID -j DROP</programlisting>
            </example>
        </section>
        <section>
            <info>
                <title>Проверка на работоспособность</title>
            </info>
            <note>
                <para>Этот скрипт написан кем-то в сетевом форуме... Адрес автора утерян, имя... В
                    общем, спасибо ему, пусть и без имени. (Надеюсь, он не обидется). </para>
            </note>
            <para>Теперь проверяем могут ли наши пользователи выйти в интернет или подключиться к
                серверу по ssh. Если все нормально, то можно переходить ниже по тексту. Если нет —
                проверьте синтаксические ошибки и прочее... Удостоверьтесь, что IP-адреса и маски
                клиентов и сервера введены правильно... Ну или... </para>
            <para>Если все работает, как задумали, сохраняем конфигурацию: </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/iptables save</userinput></screen>
            <para>И бэкапим вашу рабочую конфигурацию для возможного восстановления "как было": </para>
            <screen><prompt>#</prompt> <userinput>cp /var/lib/iptables/rules-save /var/lib/iptables/rules.working</userinput></screen>
            <para>Проверим iptables start-up скрипт перед тем как добавить iptables в default
                runlevel: </para>
            <example>
                <title>Проверка скрипта </title>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/iptables start</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/iptables stop</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/iptables start</userinput></screen>
            </example>
            <para>Смысл в запуске-остановке-запуске в том, что у нас нет скрипта запуска iptables...
                поэтому нужно “инициализировать” статус перед остановкой. Остановка, по существу,
                обнуляет настройки и возвращает все к исходному. Перезапуск покажет нам работает ли
                наша сеть после перезагрузки. Если все в порядке, то добавляем iptables в default
                runlevel: </para>
            <screen><prompt>#</prompt> <userinput>rc-update add iptables default</userinput></screen>
            <para>Не забудем также установить в <filename>/etc/sysctl.conf</filename>:</para>
            <programlisting>net.ipv4.ip_forward = 1</programlisting>
        </section>
        <section>
            <info>
                <title>Оборона Firewall</title>
            </info>
            <para>Далее мы сделаем наш, уже работающий файрвол безопасным, т.е. защищающим нашу
                систему от проникновений извне. На самом деле нам придется настроить файрвол таким
                образом, чтобы он не только защищал нас, но и защищал внешнюю сеть от нас. :) Защита
                такого рода является обязательной, она нужна для того, чтобы, в том случае, если
                наша система все-таки была взломана, взломщик не смог воспользоваться нашими
                ресурсами для дальнейшей атаки любого рода. Этот аспект является важнейшим в сетях
                класса SOHO, т.е. небольших офисах. Обыкновенно вирусы не оказывают никакого влияния
                на малые сети и заражение ими редко приводит к потере данных. Для нас, пользователей
                *nix, этой проблемы практически не существует. В любом случае, т.к. небольшие сети,
                как правило, защищены гораздо хуже больших, кракеры стараются использовать их в
                качестве “опорной базы” для DoS атак, или другой своей вредоносной активности. </para>
            <para>В последующем я опишу всю конфигурацию по кусочкам, дабы мы смогли бы проверить
                пошагово каждый фрагмент. Каждый шаг может потребовать от вас вставки чего-либо до,
                после или в середину указываемого скрипта. Все действия производятся так, чтобы (я
                надеюсь) ваша сеть не работала только лишь короткий промежуток времени во время
                настройки. Это сделано мною потому как я предположил что у многих из вас (таких как
                я) выделен сервер под Firewall. И так как я предпочитаю настраивать свой сервер
                через SSH, отключение сети может иметь пренеприятные последствия, такие как ползания
                под столами или хуже того. Если же вы смелы, то вы можете скопировать скрипт в конце
                этого документа и запустить его на своей машине. Этот скрипт должен быть
                работоспособен на все сто, но тестировал я его только на своей машине, так что <link
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="http://lingvo.yandex.ru/en?text=YMMV">ymmv</link>. </para>
        </section>
        <section>
            <info>
                <title>Установка переменных окружения</title>
            </info>
            <para>Вы можете установить необходимые переменные окружения следующим скриптом: </para>
            <programlisting>#!/bin/sh
#
# Внешний интерфейс
EXTIF="ppp0"
# Внутренний интерфейс
INTIF="eth1"
# Loop device/localhost
LPDIF="lo"
LPDIP="127.0.0.1"
LPDMSK="255.0.0.0"
LPDNET="$LPDIP/$LPDMSK"
# Необходимые утилиты
IPT="/sbin/iptables"
IFC="/sbin/ifconfig"
G="/bin/grep"
SED="/bin/sed"
AWK="/usr/bin/awk"
ECHO="/bin/echo"
# Последующие команды могут работать некорректно при локализации.
# Установка переменных окружения внешнего интерфейса
EXTIP="`$IFC $EXTIF | $AWK /$EXTIF/'{next}//{split($0,a,":");split(a[2],a," ");print a[1];exit}'`"
EXTBC="255.255.255.255" 
#EXTMSK="`$IFC $EXTIF | $G Mask:|$SED 's/.*Mask:\([^ ]*\)/\1/'`"
EXTMSK="`$IFC $EXTIF | $AWK /$EXTIF/'{next}//{split($0,a,":");split(a[4],a," ");print a[1];exit}'`"
EXTNET="$EXTIP/$EXTMSK"
$ECHO "EXTIP=$EXTIP EXTBC=$EXTBC EXTMSK=$EXTMSK EXTNET=$EXTNET"
# Due to absence of EXTBC I manually set it to 255.255.255.255
# this (hopefully) will serve the same purpose
# Установка переменных окружения внутреннего интерфейса
INTIP="`$IFC $INTIF | $AWK /$INTIF/'{next}//{split($0,a,":");split(a[2],a," ");print a[1];exit}'`"
INTBC="`$IFC $INTIF | $AWK /$INTIF/'{next}//{split($0,a,":");split(a[3],a," ");print a[1];exit}'`"
INTMSK="`$IFC $INTIF | $AWK /$INTIF/'{next}//{split($0,a,":");split(a[4],a," ");print a[1];exit}'`"
INTNET="$INTIP/$INTMSK"
$ECHO "INTIP=$INTIP INTBC=$INTBC INTMSK=$INTMSK INTNET=$INTNET"</programlisting>
        </section>
        <section>
            <info>
                <title>iptables ACCEPTS</title>
            </info>
            <para>Теперь мы должны установить ACCEPTы, так, чтобы мы могли соединяться с нашим
                сервером. На самом деле это очень больной вопрос. Правила для надежного
                маршрутизатора должны по умолчанию запрещать нежели разрешать. Однако, если вы
                сделаете это, то потеряете все соединения. Продолжайте тестирование пока не будете
                уверены что ваши ACCEPTы работают как надо. Однако думаю, что сперва мы введем
                следующее и это будет предпоследним правилом в окончательном скрипте. </para>
        </section>
        <section>
            <info>
                <title>iptables DROP &amp; REJECT</title>
            </info>
            <para>Теперь мы определим пару цепочек (chains) которые будут фиксировать события DROP и
                REJECT. Таким образом нам не придется вводить отдельные строки для каждой введенной
                команды. Сообщения о событиях будут отправлены сервису syslog, (обычно они
                фиксируются в <filename>/var/log/messages</filename>). Позже я (переводчик не имеет
                к этому никакого отношения) собираюсь написать скрипт на sed/grep по разбору событий
                для облегченного просмотра и установлю его как ежедневную работу для сервиса cron. </para>
            <para>Эти строки следует вставить сразу после текста выше, в тот же скрипт. Когда вы это
                сделаете, запустите скрипт снова. Это не окажет влияния на вашу сеть, вы пока просто
                устанавливаете правила. Но это поможет убедиться что мы не сделали ошибок на данном
                этапе. </para>
            <programlisting># ********** Цепочки журналирования событий **********
#
# Теперь мы определяем несколько цепочек которые служат для записи 
# событий о сбрасываемых пакетах. Это позволит нам избежать ввода 
# команд для каждого правила. Сперва мы фиксируем DROP, а потом REJECT.
# Не жалуйтесь, если цепочки уже существуют (однако это не приведет к ошибкам???)
$IPT -N DROPl   2> /dev/null
$IPT -A DROPl -m limit --limit 3/minute --limit-burst 10 -j LOG --log-prefix 'FIREWALL DROP BLOCKED:'
$IPT -A DROPl   -j DROP
$IPT -N REJECTl 2> /dev/null
$IPT -A REJECTl -m limit --limit 3/minute --limit-burst 10 -j LOG --log-prefix 'FIREWALL REJECT BLOCKED:'
$IPT -A REJECTl -j REJECT
$IPT -N DROP2   2> /dev/null
$IPT -A DROP2 -m limit --limit 3/second --limit-burst 10 -j LOG --log-prefix 'FIREWALL DROP UNKNOWN:'
$IPT -A DROP2   -j DROP
$IPT -N REJECT2 2> /dev/null
$IPT -A REJECT2 -m limit --limit 3/second --limit-burst 10 -j LOG --log-prefix 'FIREWALL REJECT UNKNOWN:'
$IPT -A REJECT2 -j REJECT
# Для тестирования фиксируем события ACCEPT
$IPT -N ACCEPTl   2> /dev/null
$IPT -A ACCEPTl -m limit --limit 10/second --limit-burst 50 -j LOG --log-prefix 'FIREWALL ACCEPT:'
$IPT -A ACCEPTl   -j ACCEPT</programlisting>
        </section>
        <section>
            <info>
                <title>Сброс правил</title>
            </info>
            <para>Теперь, когда мы видим наши устройства, правильно определенные, вставляем команду
                сброса правил. Однако все уже назначенные правила будут сброшены. Эти строки должны
                быть вставлены после определения утилит, которые заканчиваются строкой:
                ECHO='/bin/echo' </para>
            <programlisting># Сброс всех существующих и очистка персональных цепочек.
CHAINS=`cat /proc/net/ip_tables_names 2>/dev/null`
for i in $CHAINS
do
    $IPT -t $i -F
done
for i in $CHAINS
do
    $IPT -t $i -X
done</programlisting>
        </section>
        <section>
            <info>
                <title>Локальные интерфейсы</title>
            </info>
            <para>Теперь мы готовы для того, чтобы описать некоторые правила. Для начала мы разрешим
                все пакеты с loopback интерфейса, имеющие в качестве адреса назначения один из
                адресов наших интерфейсов. </para>
            <programlisting>$IPT -A INPUT   -i $LPDIF -s   $LPDIP  -j ACCEPT
$IPT -A INPUT   -i $LPDIF -s   $EXTIP  -j ACCEPT
$IPT -A INPUT   -i $LPDIF -s   $INTIP1  -j ACCEPT
$IPT -A INPUT   -i $LPDIF -s   $INTIP2  -j ACCEPT</programlisting>
        </section>
        <section>
            <info>
                <title>Блокировка широковещательных пакетов</title>
            </info>
            <para>Теперь мы должны заблокировать все входящие и исходящие широковещательные пакеты.
                Это предотвратит DoS атаки против нас, и не позволит нашим клиентам проводить DoS
                атаки против кого либо другого. Если бы все системные администраторы следовали этим
                правилам, тогда много суровых и дорогих DoS атак не состоялись или были максимально
                ограниченными. </para>
            <example>
                <title>Блокировка широковещательных пакетов </title>
                <programlisting>$IPT -A INPUT   -i $EXTIF -d   $EXTBC  -j DROPl
$IPT -A INPUT   -i $INTIF1 -d  $INTBC1  -j DROPl
$IPT -A INPUT   -i $INTIF2 -d  $INTBC2  -j DROPl
$IPT -A OUTPUT  -o $EXTIF -d   $EXTBC  -j DROPl
$IPT -A OUTPUT  -o $INTIF1 -d  $INTBC1  -j DROPl
$IPT -A OUTPUT  -o $INTIF2 -d  $INTBC2  -j DROPl
$IPT -A FORWARD -o $EXTIF -d   $EXTBC  -j DROPl
$IPT -A FORWARD -o $INTIF1 -d  $INTBC1  -j DROPl
$IPT -A FORWARD -o $INTIF2 -d  $INTBC2  -j DROP</programlisting>
            </example>
            <para>Теперь проверим скрипт еще раз, чтобы убедиться в том, что мы не наделали
                синтаксических ошибок. Также отмечу, что мы используем определенные нами DROP1
                цепочки (chains). Это означает, что отбрасываемые пакеты будут отмечены в журнале
                событий (log file). </para>
        </section>
        <section>
            <info>
                <title>Блокировка доступа в локальную сеть из глобальной</title>
            </info>
            <para>Теперь мы блокируем доступ из глобальной сети в нашу локальную сеть, если мы не
                хотим что бы интернет провайдер назначал IP адреса для нашей внутренней сети. </para>
            <programlisting># Блокировать внешний доступ к локальной сети
# Это позволит остановить боевых кракеров от использования 
# нашей сети как стартовой точки для других атак.
#
# Нижеприведенная строчка на человеческом языке будет выглядеть как
# "если входящий пакет, пришедший на наш внешний интерфейс,
# имеет адрес назначения, отличный от адреса нашего внешнего интерфейса,
# то этот пакет не будет пропущен."
$IPT -A INPUT   -i $EXTIF -d ! $EXTIP  -j DROPl</programlisting>
        </section>
        <section>
            <info>
                <title>Изолирование локальных сетей</title>
            </info>
            <para>Теперь мы предпримем некоторые действия для наших локальных сетей. Другими словами
                — все пакеты не относящиеся к локальным сетям должны быть блокированы. </para>
            <programlisting># Теперь мы должны заблокировать все пакеты не относящиеся к 
# адресному пространству наших локальных сетей.
# Запомните, если вы подключите свой ноутбук к другому разъему, 
# вам надо убедиться, что ваш сетевой адрес соответствует адресам этой сети.
#
# Первая локальная сеть
$IPT -A INPUT   -i $INTIF1 -s ! $INTNET1 -j DROPl
$IPT -A OUTPUT  -o $INTIF1 -d ! $INTNET1 -j DROPl
$IPT -A FORWARD -i $INTIF1 -s ! $INTNET1 -j DROPl
$IPT -A FORWARD -o $INTIF1 -d ! $INTNET1 -j DROPl
# Вторая локальная сеть
$IPT -A INPUT   -i $INTIF2 -s ! $INTNET2 -j DROPl
$IPT -A OUTPUT  -o $INTIF2 -d ! $INTNET2 -j DROPl
$IPT -A FORWARD -i $INTIF2 -s ! $INTNET2 -j DROPl
$IPT -A FORWARD -o $INTIF2 -d ! $INTNET2 -j DROPl</programlisting>
            <para>Дальше мы сделаем некоторые дополнительные проверки исходящих пакетов и остановим
                все icmp пакеты кроме ping. </para>
            <programlisting># Дополнительная проверка
$IPT -A OUTPUT  -o $EXTIF -s ! $EXTNET -j DROPl
# Блокируем исходящие ICMP (кроме PING)
$IPT -A OUTPUT  -o $EXTIF -p icmp --icmp-type ! 8 -j DROPl
$IPT -A FORWARD -o $EXTIF -p icmp --icmp-type ! 8 -j DROPl</programlisting>
            <para>Замечательно. Двигаемся дальше и проверяем скрипт на ошибки. </para>
        </section>
        <section>
            <info>
                <title>Ports</title>
            </info>
            <para>Предполагая что у нас все сработало мы заткнем еще несколько портов, доступ по
                которым может представлять для нас серьезную опасность: </para>
            <programlisting># COMmon ports:
# 0 is tcpmux; SGI had vulnerability, 1 is common attack
# 13 is daytime
# 98 is Linuxconf
# 111 is sunrpc (portmap)
# 137:139, 445 is Microsoft
# SNMP: 161,2
# Squid flotilla: 3128, 8000, 8008, 8080
# 1214 is Morpheus or KaZaA
# 2049 is NFS
# 3049 is very virulent Linux Trojan, mistakable for NFS
# Common attacks: 1999, 4329, 6346
# Common Trojans 12345 65535
 COMBLOCK="0:1 13 98 111 137:139 161:162 445 1214 1999 2049 3049 4329 6346 3128 8000 8008 8080 12345 65535"
# TCP ports:
# 98 is Linuxconf
# 512-5!5 is rexec, rlogin, rsh, printer(lpd)
#   [very serious vulnerabilities; attacks continue daily]
# 1080 is Socks proxy server
# 6000 is X (NOTE X over SSH is secure and runs on TCP 22)
# Block 6112 (Sun's/HP's CDE)
 TCPBLOCK="$COMBLOCK 98 512:515 1080 6000:6009 6112"
# UDP ports:
# 161:162 is SNMP
# 520=RIP, 9000 is Sangoma
# 517:518 are talk and ntalk (more annoying than anything)
 UDPBLOCK="$COMBLOCK 161:162 520 123 517:518 1427 9000 9 6346 3128 8000 8008 8080 12345 65535"</programlisting>
            <para>После определения переменных окружения нам останется только пробежаться по ним
                циклом: </para>
            <programlisting>echo -n "FW: Blocking attacks to TCP port"
for i in $TCPBLOCK;
do
 echo -n "$i "
  $IPT -A INPUT   -p tcp --dport $i  -j DROPl
  $IPT -A OUTPUT  -p tcp --dport $i  -j DROPl
  $IPT -A FORWARD -p tcp --dport $i  -j DROPl
done
echo ""
echo -n "FW: Blocking attacks to UDP port "
for i in $UDPBLOCK;
do
 echo -n "$i "
   $IPT -A INPUT   -p udp --dport $i  -j DROPl
   $IPT -A OUTPUT  -p udp --dport $i  -j DROPl
   $IPT -A FORWARD -p udp --dport $i  -j DROPl
done
echo ""</programlisting>
            <para>Ну что ж, теперь каждый раз, когда мы запускаем скрипт, эти строчки просто
                добавляются к уже существующим... что создаёт небольшой бардак. По этой причине мы
                собираемся перепрыгнуть в начало скрипта... сразу после переменных окружения для sed
                и grep, но перед переменными для EXTIP и EXTBC — там мы добавляем цикл, который
                производит очистку. Так мы будем уверены, что работаем в чистой среде. Нам не
                приходилось задумываться об этом ранее, потому что мы не имели возможности оттестить
                скрипт без обрыва соединения либо закрытия файрвола. Этот скрипт сначала выставляет
                всю политику в DROP, после чего очищает и удаляет наши цепочки. Чтобы убедиться, что
                мы по-прежнему можем залогиниться по ssh на наш сервер после того, как скрипт
                перезапуститься, мы добавим цепочку INPUT для ssh. Пока что поставим её в конец
                скрипта. Это делается для того чтобы избежать открытия дыры в момент установки новых
                правил, что является довольно распространённой ошибкой: </para>
            <programlisting># Отказываем, потом принимаем: это уберёт дыру в момент,
# когда мы закрываем порты
 $IPT        -P INPUT       DROP
 $IPT        -P OUTPUT      DROP
 $IPT        -P FORWARD     DROP
# Очищаем все существуещие цепочки и стираем дополнительные
 CHAINS=`cat /proc/net/ip_tables_names 2>/dev/null`
 for i in $CHAINS;
 do
   $IPT -t $i -F
 done
 for i in $CHAINS;
 do
   $IPT -t $i -X
 done
 $IPT -A INPUT   -i $INTIF1 -p tcp --dport 22 --syn -m state --state NEW -j ACCEPT</programlisting>
        </section>
        <section>
            <info>
                <title>Sysctl'ы</title>
            </info>
            <para>Сразу после этого мы запустим sysctl'ы для tcp_syncookies,
                icmp_echo_ignore_broadcasts, rp_filter и accept_source_routе. До этого момента
                многие правила, которые мы "проверяли", фактически не выполнялись. По сути, мы
                просто делали проверку синтаксических ошибок. Теперь наши правила будут выполняться
                в полной мере: </para>
            <programlisting>echo 1 > /proc/sys/net/ipv4/tcp_syncookies
echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts
# Проверка адреса источника
for f in /proc/sys/net/ipv4/conf/*/rp_filter;
do
 echo 1 > $f
done
# Отключаем роутинг источника IP и ICMP-редиректы
for f in /proc/sys/net/ipv4/conf/*/accept_source_route;
do
 echo 0 > $f
done
for f in /proc/sys/net/ipv4/conf/*/accept_redirects;
do
 echo 0 > $f
done
echo 1 > /proc/sys/net/ipv4/ip_forward</programlisting>
            <para>Теперь мы собираемся добавить трекинг ftp-соединения, так что нам не доведётся
                наблюдать ошибки PASV при установке паков: </para>
            <programlisting># Запускаем трекинг ftp-соединения
MODULES="ip_nat_ftp ip_conntrack_ftp"
for i in $MODULES;
do
 echo "Добавляем модуль $i"
 modprobe $i
done</programlisting>
        </section>
        <section>
            <info>
                <title>Базовая конфигурация NAT</title>
            </info>
            <para>А сейчас возвратимся к концу нашего скрипта, поскольку мы собираемся открыть
                сервисы для хостов, находящихся за файерволом. Я включил следующие сервисы: IRC,
                MSN, ICQ, and NFS, FTP, domain,time и некоторые другие. Самое главное здесь то, что
                эти сервисы могут использоваться ТОЛЬКО ЗА файерволом.Таким образом никто не сможет
                их использовать по ftp внутри Вашей локальной сетки: </para>
            <programlisting>IRC='ircd'
MSN=1863
ICQ=5190
NFS='sunrpc'
# Мы пользуемся sync!!
PORTAGE='rsync'
OpenPGP_HTTP_Keyserver=11371
# Все порты сервисов считываются из /etc/services
TCPSERV="domain ssh http https ftp ftp-data mail pop3 pop3s imap3 imaps imap2 time $PORTAGE $IRC $MSN $ICQ $OpenPGP_HTTP_Keyserver"
UDPSERV="domain time"
echo -n "FW: Allowing inside systems to use service:"
for i in $TCPSERV;
do
 echo -n "$i "
 $IPT -A OUTPUT  -o $EXTIF -p tcp -s $EXTIP --dport $i --syn -m state --state NEW -j ACCEPT
 $IPT -A FORWARD -i $INTIF1 -p tcp -s $INTNET1 --dport $i --syn -m state --state NEW -j ACCEPT
 $IPT -A FORWARD -i $INTIF2 -p tcp -s $INTNET2 --dport $i --syn -m state --state NEW -j ACCEPT
done
echo ""
echo -n "FW: Allowing inside systems to use service:"
for i in $UDPSERV;
do
 echo -n "$i "
 $IPT -A OUTPUT  -o $EXTIF -p udp -s $EXTIP --dport $i -m state --state NEW -j ACCEPT
   $IPT -A FORWARD -i $INTIF1 -p udp -s $INTNET1 --dport $i -m state --state NEW -j ACCEPT
   $IPT -A FORWARD -i $INTIF2 -p udp -s $INTNET2 --dport $i -m state --state NEW -j ACCEPT
done
echo ""</programlisting>
            <para>Теперь сделаем так, чтобы файервол позволил нам пинговать внешний мир. Для этого
                разрешим прохождение icmp-пакетов через внешний интерфейс: </para>
            <programlisting># Разрешаем внешнее пингование
$IPT -A OUTPUT  -o $EXTIF -p icmp -s $EXTIP --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A FORWARD -i $INTIF1 -p icmp -s $INTNET1 --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A FORWARD -i $INTIF2 -p icmp -s $INTNET2 --icmp-type 8 -m state --state NEW -j ACCEPT
                                                                              
# Разрешим файерволу пинговать наши внутренние сетки:
$IPT -A OUTPUT  -o $INTIF1 -p icmp -s $INTNET1 --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A OUTPUT  -o $INTIF2 -p icmp -s $INTNET2 --icmp-type 8 -m state --state NEW -j ACCEPT</programlisting>
            <para>Теперь мы по умолчанию будем записывать в журнал все прочие запросы, но никак не
                будем на них реагировать. Все что нам надо было принять мы описали в начале наших
                правил. Так что заканчиваем правила блокировкой всего, что специально не разрешено: </para>
            <programlisting># Заблокируем все, что осталось:
 $IPT -A INPUT             -j DROPl
 $IPT -A OUTPUT            -j REJECTl
 $IPT -A FORWARD           -j DROPl</programlisting>
            <para>Итак, все сделано. я имею дружественные nmap и nessus для моих соединений с
                вышеописанным набором правил и ничего не препятствует использованию IRC, MSN, ICQ, и
                emerge sync. </para>
        </section>
        <section>
            <info>
                <title>The full script</title>
            </info>
            <para>А сейчас, полноценный скрипт во всей своей красе (Заодно я поместил форвардинг ssh
                в более подходящее для него место): </para>
            <programlisting> 
# Внешний интерфейс
 EXTIF=ppp0
# Внутренний интерфейс
 INTIF1=eth1
 INTIF2=eth2
# Loop-устройство/localhost
 LPDIF=lo
 LPDIP=127.0.0.1
 LPDMSK=255.0.0.0
 LPDNET="$LPDIP/$LPDMSK"
# Переменные текстовых инструментов
 IPT='/sbin/iptables'
 IFC='/sbin/ifconfig'
 G='/bin/grep'
 SED='/bin/sed'
# Последнее (но немаловажное) - пользователи
 JAMES=192.168.1.77
 TERESA=192.168.2.77
# Deny вместо accept: предотвращает открытие "дыр"
# в то время, как мы закрываем порты и все такое
 $IPT        -P INPUT       DROP
 $IPT        -P OUTPUT      DROP
 $IPT        -P FORWARD     DROP
# Сброс всех существующих цепочек и стирание персональных цепочек
 CHAINS=`cat /proc/net/ip_tables_names 2>/dev/null`
 for i in $CHAINS
 do
  $IPT -t $i -F
  $IPT -t $i -X
 done
 echo 1 > /proc/sys/net/ipv4/tcp_syncookies
 echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts
# Проверка адреса источника
 for f in /proc/sys/net/ipv4/conf/*/rp_filter;
 do
  echo 1 > $f
 done
# Запрет маршрутизации IP от источника и редиректов ICMP
 for f in /proc/sys/net/ipv4/conf/*/accept_source_route;
 do
  echo 0 > $f
 done
 for f in /proc/sys/net/ipv4/conf/*/accept_redirects;
 do
  echo 0 > $f
 done
 echo 1 > /proc/sys/net/ipv4/ip_forward
# Установка переменных среды для внешнего интерфейса
 EXTIP="`$IFC $EXTIF|$G addr:|$SED 's/.*addr:\([^ ]*\) .*/\1/'`"
 #EXTBC="`$IFC $EXTIF|$G Bcast:|$SED 's/.*Bcast:\([^ ]*\) .*/\1/'`"
 EXTBC="255.255.255.255"
 EXTMSK="`$IFC $EXTIF|$G Mask:|$SED 's/.*Mask:\([^ ]*\)/\1/'`"
 EXTNET="$EXTIP/$EXTMSK"
 #echo "EXTIP=$EXTIP EXTBC=$EXTBC EXTMSK=$EXTMSK EXTNET=$EXTNET"
 echo "EXTIP=$EXTIP EXTBC=$EXTBC EXTMSK=$EXTMSK EXTNET=$EXTNET"
# Так как EXTBC отсутствует, я устанавливаю ее вручную как it to 255.255.255.255
# Это (надеюсь) послужит тем же целям
# Устанвка переменных среды для первого внутреннего интерфейса
 INTIP1="`$IFC $INTIF1|$G addr:|$SED 's/.*addr:\([^ ]*\) .*/\1/'`"
 INTBC1="`$IFC $INTIF1|$G Bcast:|$SED 's/.*Bcast:\([^ ]*\) .*/\1/'`"
 INTMSK1="`$IFC $INTIF1|$G Mask:|$SED 's/.*Mask:\([^ ]*\)/\1/'`"
 INTNET1="$INTIP1/$INTMSK1"
 echo "INTIP1=$INTIP1 INTBC1=$INTBC1 INTMSK1=$INTMSK1 INTNET1=$INTNET1"
# Установка переменных среды для второго внутреннего интерфейса
 INTIP2="`$IFC $INTIF2|$G addr:|$SED 's/.*addr:\([^ ]*\) .*/\1/'`"
 INTBC2="`$IFC $INTIF2|$G Bcast:|$SED 's/.*Bcast:\([^ ]*\) .*/\1/'`"
 INTMSK2="`$IFC $INTIF2|$G Mask:|$SED 's/.*Mask:\([^ ]*\)/\1/'`"
 INTNET2="$INTIP2/$INTMSK2"
 echo "INTIP2=$INTIP2 INTBC2=$INTBC2 INTMSK2=$INTMSK2 INTNET2=$INTNET2"
# Сейчас мы собираемся создать несколько собственных цепочек, результатом работы 
# которых будет логгинг отброшенных пакетов. Это поможет нам избежать необходимости
# вводить команду log перед каждым отбрасыванием пакета, что мы хотим запротоколировать.
# Первыми идут лог отброшенных пакетов и собственно отброс, затем лог пакетов с отказами
# и собственно отказы.
# Отключаем сообщения о том, что цепочки уже существуют (чтобы перезапуск был без мусора)
 $IPT -N DROPl   2> /dev/null
 $IPT -A DROPl   -j LOG --log-prefix 'DROPl:'
 $IPT -A DROPl   -j DROP
 $IPT -N REJECTl 2> /dev/null
 $IPT -A REJECTl -j LOG --log-prefix 'REJECTl:'
 $IPT -A REJECTl -j REJECT
# Весь траффик от устройства loopback принимается
# если IP совпадает с любым из наших интерфейсов.
 $IPT -A INPUT   -i $LPDIF -s   $LPDIP  -j ACCEPT
 $IPT -A INPUT   -i $LPDIF -s   $EXTIP  -j ACCEPT
 $IPT -A INPUT   -i $LPDIF -s   $INTIP1  -j ACCEPT
 $IPT -A INPUT   -i $LPDIF -s   $INTIP2  -j ACCEPT
# Широковещательные пакеты блокируем
 $IPT -A INPUT   -i $EXTIF -d   $EXTBC  -j DROPl
 $IPT -A INPUT   -i $INTIF1 -d   $INTBC1  -j DROPl
 $IPT -A INPUT   -i $INTIF2 -d   $INTBC2  -j DROPl
 $IPT -A OUTPUT  -o $EXTIF -d   $EXTBC  -j DROPl
 $IPT -A OUTPUT  -o $INTIF1 -d   $INTBC1  -j DROPl
 $IPT -A OUTPUT  -o $INTIF2 -d   $INTBC2  -j DROPl
 $IPT -A FORWARD -o $EXTIF -d   $EXTBC  -j DROPl
 $IPT -A FORWARD -o $INTIF1 -d   $INTBC1  -j DROPl
 $IPT -A FORWARD -o $INTIF2 -d   $INTBC2  -j DROPl
# Блокируем доступ к внутренней сети из WAN
# Это также призвано не дать нечестивым крякерам использовать нашу сетку 
# в качестве отправной точки для атак на других людей
# Перевод с языка iptables:
# "если пришедшие на наружный интерфейс пакеты были отправлены не с выданного
# nefarious адреса, выкинуть их как горячую картошку"
 $IPT -A INPUT   -i $EXTIF -d ! $EXTIP  -j DROPl
# А сейчас мы блокируем внутренние адреса, кроме двух, присвоенных нашим двум
# внутренним интерфейсам.....только помните, что если вы воткнете свой лэптоп или
# какой другой pc в напрямую в одну из этих сетевых карт, то нужно удостовериться,
# что они имеют именно эти IP-адреса или добавить соответствующий адрес отдельно.               
# Первый интерфейс/первая внутренняя сеть
 $IPT -A INPUT   -i $INTIF1 -s ! $INTNET1 -j DROPl
 $IPT -A OUTPUT  -o $INTIF1 -d ! $INTNET1 -j DROPl
 $IPT -A FORWARD -i $INTIF1 -s ! $INTNET1 -j DROPl
 $IPT -A FORWARD -o $INTIF1 -d ! $INTNET1 -j DROPl
# Второй интерфейс/вторая внутренняя сеть
 $IPT -A INPUT   -i $INTIF2 -s ! $INTNET2 -j DROPl
 $IPT -A OUTPUT  -o $INTIF2 -d ! $INTNET2 -j DROPl
 $IPT -A FORWARD -i $INTIF2 -s ! $INTNET2 -j DROPl
 $IPT -A FORWARD -o $INTIF2 -d ! $INTNET2 -j DROPl
# Дополнительная Egress-проверка
 $IPT -A OUTPUT  -o $EXTIF -s ! $EXTNET -j DROPl
# Блокируем исходящиие пакеты ICMP (за исключением PING)
 $IPT -A OUTPUT  -o $EXTIF -p icmp --icmp-type ! 8 -j DROPl
 $IPT -A FORWARD -o $EXTIF -p icmp --icmp-type ! 8 -j DROPl
# печально известные порты:
# 0 - tcpmux; у SGI есть уязвимость, через которую можно атаковать
# 13 - daytime
# 98 - Linuxconf
# 111 - sunrpc (portmap)
# 137:139, 445 - Microsoft
# SNMP: 161,2
# Флотилия Squid: 3128, 8000, 8008, 8080
# 1214 - Morpheus или KaZaA
# 2049 - NFS
# 3049 - очень заразный троян для Linux, часто путаемый с NFS
# Часто атакуемые: 1999, 4329, 6346
# Частые трояны 12345 65535
 COMBLOCK="0:1 13 98 111 137:139 161:162 445 1214 1999 2049 3049 4329 6346 3128 8000 8008 8080 12345 65535"
# Порты TCP:
# 98 - Linuxconf
# 512-5!5 - rexec, rlogin, rsh, printer(lpd)
#   [очень серьезеные уязвимости; продолжаются ежедневные атаки]
# 1080 - прокси-серверы Socks
# 6000 - X (ЗАМЕЧАНИЕ. X через SSH - безопасен, и работает на порту TCP 22)
# Блокировка 6112 (CDE у Sun и HP)
 TCPBLOCK="$COMBLOCK 98 512:515 1080 6000:6009 6112"
# Порты UDP:
# 161:162 - SNMP
# 520=RIP, 9000 - Sangoma
# 517:518 - talk и ntalk (самые надоедливые)
 UDPBLOCK="$COMBLOCK 161:162 520 123 517:518 1427 9000"
echo -n "FW: Blocking attacks to TCP port"
for i in $TCPBLOCK;
do
 echo -n "$i "
  $IPT -A INPUT   -p tcp --dport $i  -j DROPl
  $IPT -A OUTPUT  -p tcp --dport $i  -j DROPl
  $IPT -A FORWARD -p tcp --dport $i  -j DROPl
done
echo ""
echo -n "FW: Blocking attacks to UDP port "
for i in $UDPBLOCK;
do
 echo -n "$i "
  $IPT -A INPUT   -p udp --dport $i  -j DROPl
  $IPT -A OUTPUT  -p udp --dport $i  -j DROPl
  $IPT -A FORWARD -p udp --dport $i  -j DROPl
done
echo ""
# Открываем отлеживание соединений по ftp
 MODULES="ip_nat_ftp ip_conntrack_ftp"
 for i in $MODULES;
 do
  echo "Inserting module $i"
  modprobe $i
 done
# Защищаем некоторые распространенные клиенты для чата.
# Уберите из списка допустимых для пущей безопасности.
 IRC='ircd'
 MSN=1863
 ICQ=5190
 NFS='sunrpc'
# Нам нужно синхронизировать данные!!
 PORTAGE='rsync'
 OpenPGP_HTTP_Keyserver=11371
# Все порты сервисов читаются из /etc/services
 TCPSERV="domain ssh http https ftp ftp-data mail pop3 pop3s imap3 imaps imap2 time $PORTAGE $IRC $MSN $ICQ  $OpenPGP_HTTP_Keyserver" UDPSERV="domain time"
echo -n "FW: Allowing inside systems to use service:"
for i in $TCPSERV;
do
 echo -n "$i "
  $IPT -A OUTPUT  -o $EXTIF -p tcp -s $EXTIP --dport $i --syn -m state --state NEW -j ACCEPT
  $IPT -A FORWARD -i $INTIF1 -p tcp -s $INTNET1 --dport $i --syn -m state --state NEW -j ACCEPT
  $IPT -A FORWARD -i $INTIF2 -p tcp -s $INTNET2 --dport $i --syn -m state --state NEW -j ACCEPT
done
echo ""
echo -n "FW: Allowing inside systems to use service:"
for i in $UDPSERV;
do
 echo -n "$i "
  $IPT -A OUTPUT  -o $EXTIF -p udp -s $EXTIP --dport $i -m state --state NEW -j ACCEPT
  $IPT -A FORWARD -i $INTIF1 -p udp -s $INTNET1 --dport $i -m state --state NEW -j ACCEPT
  $IPT -A FORWARD -i $INTIF2 -p udp -s $INTNET2 --dport $i -m state --state NEW -j ACCEPT
done
echo ""
# Разрешается ping наружу
$IPT -A OUTPUT  -o $EXTIF -p icmp -s $EXTIP --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A FORWARD -i $INTIF1 -p icmp -s $INTNET1 --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A FORWARD -i $INTIF2 -p icmp -s $INTNET2 --icmp-type 8 -m state --state NEW -j ACCEPT
# Файерволу разрешается ping внутренних систем
$IPT -A OUTPUT  -o $INTIF1 -p icmp -s $INTNET1 --icmp-type 8 -m state --state NEW -j ACCEPT
$IPT -A OUTPUT  -o $INTIF2 -p icmp -s $INTNET2 --icmp-type 8 -m state --state NEW -j ACCEPT                                                                                                                                                             
$IPT -A INPUT   -i $INTIF1 -p tcp --dport 22 --syn -m state --state NEW -j ACCEPT
$IPT -t nat -A PREROUTING -j ACCEPT
$IPT -t nat -A POSTROUTING -o $EXTIF -s $INTNET1 -j MASQUERADE
$IPT -t nat -A POSTROUTING -o $EXTIF -s $INTNET2 -j MASQUERADE
$IPT -t nat -A POSTROUTING -j ACCEPT
$IPT -t nat -A OUTPUT -j ACCEPT
$IPT -A INPUT -p tcp --dport auth --syn -m state --state NEW -j ACCEPT
$IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
# Заблокировать и запротоколировать все, что мы могли забыть.
$IPT -A INPUT -j DROPl
$IPT -A OUTPUT -j REJECTl
$IPT -A FORWARD -j DROPl
</programlisting>
        </section>
    </section>
    <section>
        <info>
            <title>Установка почтовой системы</title>
        </info>
        <para>Установка почтовой системы на Gentoo linux для небольшой конторы </para>
        <para>Используется postfix + cyrus-imap, авторизация пользователей через cyrus-sasl без
            прикручивания какой-либо БД (подходит для контор с несколькими десятками почтовых ящиков
            — хранить что-либо в mysql или postgress в данном случае нет смысла). Пользователи
            хранятся в базе sasldb, поэтому нет нужды заводить в системе реальных
            пользователей.</para>
        <para>Возможно при установке указанных пакетов понадобится установить все зависимости,
            которые они за собой тянут. Предоставим системе самой разобраться, что же ей не хватает
            — она с этим вполне успешно справляется. </para>
        <para>Предпочитаю использовать для /var reiserfs, но это сугубо личные предпочтения. </para>
        <screen><prompt>#</prompt> <userinput>emerge -pv cyrus-sasl</userinput>
[ebuild   N   ] dev-libs/cyrus-sasl-2.1.20  -authdaemond +berkdb -debug +gdbm +java -kerberos -ldap +mysql  +pam -postgres +ssl -static 0 kB</screen>
        <para>На всякий случай проверяем флаги — все ОК </para>
        <screen><prompt>#</prompt> <userinput>emerge cyrus-sasl</userinput></screen>
        <para>Этот пакет поставили, едем дальше </para>
        <screen><prompt>#</prompt> <userinput>emerge -pv postfix</userinput>
These are the packages that I would merge, in order:
Calculating dependencies ...done!
[ebuild   N   ] mail-mta/postfix-2.1.5-r1  +ipv6 -ldap -mailwrapper -mbox +mysql +pam -postgres -sasl*(-selinux) +ssl -vda 0 kB</screen>
        <para>Здесь нам может пригодиться флаг sasl, хотя в моем случае пока нет нужды
            авторизоваться на smtp, возможно в дальнейшем здесь будет описана авторизация через
            cyrus-sasl на smtp — вообщем выставляйте флаги по вкусу кому что надо </para>
        <screen><prompt>#</prompt> <userinput>USE="sasl" emerge postfix</userinput></screen>
        <para>Постфикс собрался </para>
        <screen><prompt>#</prompt> <userinput>emerge -pv cyrus-imapd</userinput>
These are the packages that I would merge, in order:
Calculating dependencies ...done!
[ebuild   N   ] net-mail/cyrus-imapd-2.2.10  -afs -drac -idled -kerberos +pam -snmp +ssl +tcpd 0 kB</screen>
        <para>После проверки и установки нужных нам флагов пересобираем openssl и imap-сервер </para>
        <screen><prompt>#</prompt> <userinput>emerge cyrus-imapd</userinput></screen>
        <para>Программа для администрирования имаповских ящиков </para>
        <screen><prompt>#</prompt> <userinput>emerge cyrus-imap-admin</userinput></screen>
        <para>После того как все нужные нам пакеты поставлены, можно приступать к настройке </para>
        <para>сначала cyrus-sasl </para>
        <screen> passwd cyrus
 chown -R cyrus:mail /etc/sasl - доступ cyrus к базе /etc/sasl2/sasldb2
 saslpasswd2 cyrus - заводим в sasldb2 
 sasldblistusers2 - для проверки</screen>
        <section>
            <info>
                <title>Разбираемся с postfix </title>
            </info>
            <para>Cодержимое <filename>/etc/postfix/main.cf</filename>, ниже приведена примерная
                конфигурация почтового сервера подключенного напрямую к инету (не через relayhost),
                естественно для этого случая должна быть MX-запись в ДНС. Подчеркиваю, что умышленно
                опускаю многие параметры в main.cf, чтобы не раздувать описание. Добавьте все
                остальное руководствуясь документацией postfix. </para>
            <programlisting>queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/lib/postfix
mail_owner = postfix
myhostname = mail.domain.tld
mydomain = mail.domain.tld
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
local_recipient_maps =
unknown_local_recipient_reject_code = 550
mynetworks_style = subnet
mynetworks = 192.168.1.0/24, 127.0.0.0/8
relay_domains = $mydestination
<lineannotation>НА ЭТУ СТРОЧКУ ОБРАТИТЕ ВНИМАНИЕ!!!</lineannotation>
mailbox_transport = lmtp:unix:/var/imap/socket/lmtp</programlisting>
            <para>Если надо подключить procmail то вместо нее пишем</para>
            <programlisting>mailbox_transport = procmail</programlisting>
            <para>Когда добавили все, что нужно в main.cf, идем в <filename>/etc/postfix/master.cf
                </filename></para>
            <para>Ищем такую строку </para>
            <programlisting> # Also specify in main.cf: cyrus_destination_recipient_limit=1
cyrus     unix  -       n       n       -       -       pipe
 user=cyrus argv=/cyrus/bin/deliver -e -r ${sender} -m ${extension} ${user}  </programlisting>
            <para>И заменяем путь на </para>
            <programlisting> # Also specify in main.cf: cyrus_destination_recipient_limit=1
cyrus     unix  -       n       n       -       -       pipe
 user=cyrus argv=/cyrus/deliver -e -r ${sender} -m ${extension} ${user}</programlisting>
            <para>При использовании procmail, добавляем </para>
            <programlisting>procmail unix  -       n      n       —        -       pipe
 flags=R user=cyrus argv=/usr/bin/procmail -p /etc/procmailrc  USER=${user}
Где файл /etc/procmailrc : 
DELIVERMAIL=/usr/lib/cyrus/deliver
LOGFILE=/var/log/procmaillog
IMAP="$DELIVERMAIL -e -a $USER -m user.$USER"
(если надо подключить spamassassin)
:0fw : spamassassin.lock
* &lt; 90000
| /usr/bin/spamassassin
и далее обязательно
:0
| $IMAP
:0w
{
EXITCODE=$?
HOST
}  </programlisting>
            <para>Все, с постфиксом разобрались, теперь cyrus-imapd </para>
            <para>Редактируем <filename>/etc/cyrus.conf</filename>
            </para>
            <programlisting># $Header: /var/cvsroot/gentoo-x86/net-mail/cyrus-imapd/files/cyrus.conf,v 1.4 2004/07/18 04:02:23
 dragonheart  Exp $
 # Standard standalone server configuration.
 START {
  # Do not delete this entry!
  recover       cmd="ctl_cyrusdb -r"
  # This is only necessary if using idled for IMAP IDLE.
  #idled                cmd="idled"
 }
 # UNIX sockets start with a slash and are put into /var/imap/socket.
 SERVICES {
   # Add or remove based on preferences.
   imap         cmd="imapd" listen="imap2" prefork=0
   pop3         cmd="pop3d" listen="pop-3" prefork=0
    # Don't forget to generate the needed keys for SSL or TLS
   # (see doc/html/install-configure.html).
   imaps                cmd="imapd -s" listen="imaps" prefork=0
   pop3s                cmd="pop3d -s" listen="pop3s" prefork=0
   sieve                cmd="timsieved" listen="sieve" prefork=0
   # at least one LMTP is required for delivery
   #lmtp                cmd="lmtpd" listen="lmtp" prefork=0
    ##ОБРАТИТЕ ВНИМАНИЕ НА ЭТУ СТРОКУ
   lmtpunix     cmd="lmtpd" listen="/var/imap/socket/lmtp" prefork=0
      # this is only necessary if using notifications
   #notify      cmd="notifyd" listen="/var/imap/socket/notify" proto="udp" prefork=1
 }
 EVENTS {
   # This is required.
   checkpoint   cmd="ctl_cyrusdb -c" period=30
   # This is only necessary if using duplicate delivery suppression.
   delprune     cmd="ctl_deliver -E 3" period=1440
   # This is only necessary if caching TLS sessions.
   tlsprune     cmd="tls_prune" period=1440
 }</programlisting>
            <para>Вот так делаем сертификаты </para>
            <screen><prompt>#</prompt> <userinput>openssl req -new -nodes -out req.pem -keyout key.pem</userinput>
<prompt>#</prompt> <userinput>openssl rsa -in key.pem -out new.key.pem</userinput>
<prompt>#</prompt> <userinput>openssl x509 -in req.pem -out ca-cert -req \
 -signkey new.key.pem -days 999 </userinput>
<prompt>#</prompt> <userinput>cp new.key.pem /etc/ssl/cyrus/server.pem</userinput>
<prompt>#</prompt> <userinput>rm new.key.pem</userinput>
<prompt>#</prompt> <userinput>cat ca-cert >> /etc/ssl/cyrus/server.pem</userinput>
<prompt>#</prompt> <userinput>chown cyrus:mail /etc/ssl/cyrus/server.pem</userinput>
<prompt>#</prompt> <userinput>chmod 600 /etc/ssl/cyrus/server.pem</userinput> <lineannotation># Your key should be protected</lineannotation></screen>
            <para>Проверяем все-ли директории созданы </para>
            <screen>/var/imap
cd /var
mkdir imap
chown cyrus:mail imap
chmod 750 imap
/var/spool/imap 
cd /var/spool
mkdir imap
chown cyrus:mail imap
chmod 750 imap
/usr/sieve
cd /usr
mkdir sieve
chown cyrus:mail sieve
chmod 750 sieve</screen>
            <para>Далее редактируем <filename>/etc/imapd.conf</filename>
            </para>
            <programlisting>configdirectory:      /var/imap
partition-default:    /var/spool/imap
auto_transition:      yes
tls_ca_path:          /etc/ssl/certs
tls_cert_file:        /etc/ssl/cyrus/server.crt
tls_key_file:         /etc/ssl/cyrus/server.key
admins:               cyrus
hashimapspool:        yes
allowanonymouslogin:  no
allowplaintext:       yes
sasl_pwcheck_method:  auxprop
sasl_auxprop_plugin:  sasldb
sasldb_path:          /etc/sasl2/sasldb2
sasl_mech_list:       LOGIN PLAIN</programlisting>
            <para>Авторизация через базу sasldb, механизмы авторизации LOGIN,PLAIN Если мы будем
                использовать обычные открытые пароли, без шифрования (например внутри организации)
                то изменим в <filename>/etc/imapd.conf</filename>
            </para>
            <programlisting>allowanonymouslogin: yes</programlisting>
            <para>вроде бы с настройкой cyrus покончено </para>
            <para>Теперь займемся почтовыми ящиками юзеров, для этого используем программу cyradm </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/cyrus start</userinput>
<prompt>#</prompt> <userinput>cyradm -user cyrus -server localhost</userinput>
<prompt>localhost></prompt> <userinput>cm user.testuser</userinput>
<prompt>localhost></prompt> <userinput>help</userinput> <lineannotation>- выводит все команды для руления юзерскими ящиками</lineannotation>
<prompt>localhost></prompt> <userinput>exit</userinput></screen>
            <para>Не забудьте забить в sasldb2 нового юзера: </para>
            <screen><prompt>#</prompt> <userinput>saslpasswd2 testuser </userinput></screen>
            <para>Поднимаем сервисы </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/postfix start</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/cyrus start</userinput></screen>
            <para>Настраиваем почтового клиента (проверено с thunderbird 1.0 и с KMail 1.7.1, с
                Outlook Express тоже не должно быть проблем). </para>
            <para>Пробуем отправить письмо, если что-то не работает — смотрим логи, прежде всего
                проверьте права на доступ в /var/imap/socket/lmtp для пользователей postfix и cyrus,
                чаще всего проблемы связаны именно с этим. Также проверьте права на доступ к
                /etc/sasl2/sasldb2 для пользователя cyrus, который должен быть в группе mail. </para>
            <para>Желательно поставить антивирус например clamav используем для этого связку clamav
                + clamsmtp хотя возможны и другие варианты например amavisd-new. Установка прекрасно
                описана здесь <link xlink:href="http://www.nixp.ru/articles/clamav_postfix"
                    >http://www.nixp.ru/articles/clamav_postfix</link>, необходимо руководствоваться
                ей,естественно с адаптацией под реалии Gentoo </para>
            <screen><prompt>#</prompt> <userinput>emerge clamav</userinput>
<prompt>#</prompt> <userinput>ACCEPT_KEYWORDS="~x86" emerge clamsmtp (пока замаскирован в портаджах)</userinput></screen>
            <para>Затем в файле <filename>/etc/conf.d/clamd</filename>
                <code>START_CLAMD = yes</code> (для версии старше 0.85 уже не актуально — все
                настройки только в <filename>clamd.conf</filename> и
                    <filename>clamsmtpd.conf</filename>)</para>
            <para>Редактируем файлы <filename>/etc/clamd.conf</filename> и
                    <filename>/etc/clamsmtpd.conf</filename> в соответствии с рекомендациями
                приведенными выше по ссылке Обратите внимание на параметры <code>LocalSocket:
                    /var/run/clamav/clamd.sock</code> в <filename>/etc/clamav.conf</filename> и
                    <code>ClamAddress: /var/run/clamav/clamd.sock</code> в
                    <filename>/etc/clamsmtpd.conf</filename> — путь и имя файла должен одинаковым
                для обоих конфигов </para>
            <para>В файл <filename>main.cf</filename> необходимо добавить две строчки: </para>
            <programlisting>content_filter = scan:127.0.0.1:10025
receive_override_options = no_address_mappings</programlisting>
            <para>Первая говорит postfix'у о том, что необходимо пересылать всю почту через сервис
                (фильтр) 'scan' на 10025-ый порт, который, как раз, открыт clamsmtpd. Вторая строчка
                говорит о том, чтобы postfix не делал никаких манипуляций с адресами до того, как
                они дойдут до content_filter. Так что получается, что фильтр работает с реальными
                почтовыми адресами, а не с результатами перевода в виртуальные псевдонимы,
                маскарадингом и т.п. </para>
            <para>В файл <filename>master.cf</filename> необходимо добавить следующие строки: </para>
            <programlisting># AV scan filter (used by content_filter)
scan      unix  -       -       n       -       16      smtp
       -o smtp_send_xforward_command=yes
# For injecting mail back into postfix from the filter
127.0.0.1:10026 inet  n -       n       -       16      smtpd
       -o content_filter=
       -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
       -o smtpd_helo_restrictions=
        -o smtpd_client_restrictions=
       -o smtpd_sender_restrictions=
       -o smtpd_recipient_restrictions=permit_mynetworks,reject
       -o mynetworks_style=host
       -o smtpd_authorized_xforward_hosts=127.0.0.0/8</programlisting>
            <note>
                <para>Вокруг знака '=' пробелы не ставить. Значение 127.0.0.1:10026 открывает
                    10026-порт для возвращения почты обратно от clamsmtpd. </para>
            </note>
            <screen><prompt>#</prompt> <userinput>rc-update add clamd default</userinput>
<prompt>#</prompt> <userinput>rc-update add clamsmtpd default</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/postfix reload</userinput></screen>
            <para>все — антивирус должен проверять всю почту проходящую через Ваш почтовик </para>
            <para>P.S. Все вышеописанное проверялось на моей рабочей машине и на серваке небольшой
                конторы. Автор (или авторы) не несут ответственности за безграмотное и необдуманное
                применение данного руководства. Ваша безопасность в ваших руках и в голове! Данное
                описание не претендует на полное и развернутое и не является единственно возможным
                вариантом конфигурации. Также выражаю признательность разработчикам вышеописанных
                замечательных программ за прекрасное исполнение и хорошую документацию. Практически
                все вышенаписанное подчерпнуто из документации к самим пакетам, а также некоторые
                мысли родились из отрывочных данных, блуждающих в рунете — большое спасибо за это их
                авторам. </para>
            <para>PS. Некоторая путаница возникает с переадресацией почты — самый простой вариант
                использование файла aliases — но до его использования в отличие от sendmail, ящик
                который должен быть переадресован должен быть все-таки создан в системе через
                    <command>cyradm -user cyrus -auth login -server localhost</command> команда cm и
                не забыть что <filename>/etc/postfix/main.cf</filename>
            </para>
            <programlisting>alias_maps = hash:/usr/local/etc/postfix/aliases
alias_database = hash:/usr/local/etc/postfix/aliases</programlisting>
        </section>
    </section>
    <section>
        <info>
            <title>Настройка vsftpd</title>
        </info>
        <section>
            <info>
                <title>Введение </title>
            </info>
            <para>Это перевод статьи en:HOWTO vsftpd. Кое-что изменено и добавлено от себя для более
                понятного, как мне кажется, изложения.</para>
            <para>Взято из en:HOWTO Plan, setup and run a high school Gentoo Club и модифицировано. </para>
            <para>Это руководство описывает процесс установки VSFTP и настройки его для анонимного
                доступа с правами только для чтения. FTP (File Transfer Protocol) — старый, но
                надежный протокол, используемый для быстрой передачи файлов в сети. </para>
        </section>
        <section>
            <info>
                <title>Установка VSFTPD </title>
            </info>
            <para>Зайдите в систему под пользователем root и введите комманду:</para>
            <screen><prompt>#</prompt> <userinput>emerge vsftpd</userinput></screen>
            <para>Настройка </para>
            <para>Это очень легко. Откройте файл <filename>/etc/vsftpd/vsftpd.conf</filename> вашим
                любимым текстовым редактором и внесите в него вот эти изменения: </para>
            <para>Общие настройки </para>
            <example>
                <title>Файл: <filename>/etc/vsftpd/vsftpd.conf</filename></title>
                <programlisting>dirmessage_enable=YES
# banner_file=/etc/vsftpd/vsftpd.banner # edit banner first
chown_uploads=NO
xferlog_enable=YES
idle_session_timeout=600
data_connection_timeout=120
ascii_upload_enable=NO
ascii_download_enable=NO
chroot_list_enable=YES
background=YES
listen=YES
ls_recurse_enable=NO</programlisting>
            </example>
            <para>Анонимный пользователь (Anonymous), только для чтения</para>
            <example>
                <title>Файл: /etc/vsftpd/vsftpd.conf </title>
                <programlisting>anonymous_enable=YES
anon_upload_enable=NO
anon_mkdir_write_enable=NO</programlisting>
            </example>
        </section>
        <section>
            <info>
                <title>Отключаем локальных пользователей </title>
            </info>
            <para>Это плохая идея разрешать локальным пользователям доступ через ftp (проще
                sftp/ssh), потому мы отключаем им доступ.</para>
            <example>
                <title>Файл: <filename>/etc/vsftpd/vsftpd.conf</filename></title>
                <programlisting>local_enable=NO
write_enable=NO</programlisting>
            </example>
        </section>
        <section>
            <info>
                <title>Запуск службы </title>
            </info>
            <para>Gentoo предоставляет централизированное место для служб, которые называються init
                scripts или скрипты инициализации. Эти скрипты находяться в каталоге
                    <filename>/etc/init.d/</filename> и имеют имя сервиса, который они стартуют.
                Инит скрипты используються для управления сервисами. Для запуска VSFTPD сервера
                наберите Code: Запуск vsftpd как службы </para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/vsftpd start</userinput></screen>
            <para>Вы можете узнать больше о том что вы можете сделать этим скриптом инициализации
                набрав <command>/etc/init.d/vsftpd</command> без аргументов ("start" это аргумент,
                еще есть "stop" и "restart"). </para>
        </section>
        <section>
            <info>
                <title>Настройка скриптов конфигурации </title>
            </info>
            <para>Вы не хотите набирать <command>/etc/init.d/vsftpd start</command> каждый раз когда
                вы включаете свой компьютер? Gentoo предоставляет простой путь запуска скриптов
                инициализации при включении вашего компьютера. Чтобы настроить VSFTPD для запуска
                при каждой загрузке, наберите: Code: запуск vsftpd как службы загрузке </para>
            <screen><prompt>#</prompt> <userinput>rc-update add vsftpd default</userinput></screen>
            <para>Если вы хотите узнать больше о rc-update наберите <command>man
                rc-update</command>. </para>
            <para>Также можно и через chkconfig:</para>
            <example>
                <title>Запуск vsftpd как службы загрузке </title>
                <screen>chkconfig vsftpd on</screen>
            </example>
            <para> </para>
        </section>
        <section>
            <info>
                <title>Где размещать файлы </title>
            </info>
            <para>Файлы анонимного пользователя находятся в домашнем каталоге специального
                пользоватьля ftp (пользователя в системе). По умолчанию это —
                    <filename>/home/ftp</filename>. Если вы хотите сменить его например на
                    <code>/var/ftp</code>, вам нужно сделать следущие действия:</para>
            <example>
                <title>Смена размещения </title>
                <screen><prompt>#</prompt> <userinput>rmdir /home/ftp</userinput>
<prompt>#</prompt> <userinput>mkdir /var/ftp</userinput>
<prompt>#</prompt> <userinput>chown ftp:ftp /var/ftp</userinput>
<prompt>#</prompt> <userinput>ln -s /var/ftp /home/</userinput></screen>
            </example>
            <para>Теперь можно что-то разместить в этом каталоге. Например, если вы хотите сделать
                доступными для других каталоги disfiles и packages, можно сделать следущие
                действия:</para>
            <screen><prompt>#</prompt> <userinput>mv /usr/portage/disfiles /var/ftp/</userinput>
<prompt>#</prompt> <userinput>ln -s /var/ftp/disfiles /usr/portage/</userinput>
<prompt>#</prompt> <userinput>mv /usr/portage/packages /var/ftp/</userinput>
<prompt>#</prompt> <userinput>ln -s /var/ftp/packages /usr/portage/</userinput></screen>
            <note>
                <para>VSFTPD автоматически запусается в chroot окружении, поэтому символические
                    ссылки не работают. Именно для этого пришлось перенести каталоги
                    /usr/portage/disfiles и usr/portage/packages и создать символические ссылки в
                    тех местах где они должны находится. </para>
            </note>
            <para>Но можно например монтировать нужные каталоги в .../ftp при помощи fstab. Для
                этого нужно создать каталоги: <filename>/var/ftp/distfiles</filename> и
                    <filename>/var/ftp/packages</filename>.</para>
            <screen><prompt>#</prompt> <userinput>mkdir /var/ftp/distfiles</userinput>
<prompt>#</prompt> <userinput>mkdir /var/ftp/packages</userinput></screen>
            <para>После чего пропишите в <filename>/etc/fstab</filename> следущее:</para>
            <programlisting>/usr/portage/distfiles /var/ftp/distfiles none ro,bind 0 0
/usr/portage/packages /var/ftp/packages none ro,bind 0 0</programlisting>
        </section>
        <section>
            <info>
                <title>Клиенты </title>
            </info>
            <para>Есть множеcтво программ, которые позволяют получать доступ к ftp серверу. Вот
                некоторые из них: </para>
            <itemizedlist>
                <listitem>
                    <para>ftp </para>
                </listitem>
                <listitem>
                    <para>lftp — лучшый консольный клиент </para>
                </listitem>
                <listitem>
                    <para>mozilla-firefox </para>
                </listitem>
                <listitem>
                    <para>nautilus </para>
                </listitem>
                <listitem>
                    <para>gftp</para>
                </listitem>
            </itemizedlist>
        </section>
    </section>
    <section>
        <info>
            <title>Jabber Server</title>
        </info>
        <section>
            <info>
                <title>Введение</title>
            </info>
            <para><indexterm>
                    <primary>Jabber</primary>
                </indexterm><firstterm>Jabber</firstterm> — это открытый протокол, использующий XML,
                для быстрого обмена сообщениями и информацией о присутствии между любыми двумя
                абонентами в интернете. Благодаря своей уникальной расширяемости и гибкости, jabber
                способен поддерживать множество протоколов — ICQ, IRQ, MSN, RSS, Yahoo и др. </para>
        </section>
        <section>
            <info>
                <title>Установка пакетов</title>
            </info>
            <para>В качестве платформы для развертывания протокола jabber возьмем пакет jabberd. Он
                поддерживает множество возможностей — основные IM-протоколы ICQ, MSN, Yahoo,
                поддержку SSL-соединений и даже IPv6.</para>
            <para>Сначала посмотрим, какие USE-флаги требует jabber: </para>
            <example>
                <title>Зависимости</title>
                <screen><prompt>#</prompt> <userinput>emerge -pv jabberd</userinput>
These are the packages that I would merge, in order:
Calculating dependencies ...done!
[ebuild N ] net-im/jabberd-1.4.3-r5 -icq -ipv6 -ldap -msn -oscar -ssl -yahoo 0 kB
Total size of downloads: 0 kB </screen>
            </example>
            <para>Включаем соответсвующие флаги в установку (неважно, через переменную USE или через
                файл make.conf) и собираем:</para>
            <screen><prompt>#</prompt> <userinput>USE="icq ssl" emerge jabberd</userinput></screen>
            <para>В качестве зависимости вытянется пакет jit — Jabber ICQ Transport, необходимый для
                поддержки протокола ICQ. </para>
        </section>
        <section>
            <info>
                <title>Конфигурация</title>
            </info>
            <para>Сначала добавьте пользователей, ответсвенных за администрирование сервера jabber,
                в группу jabber: </para>
            <screen><prompt>#</prompt> <userinput>gpasswd -a <replaceable>имя_пользователя</replaceable> jabber</userinput></screen>
            <para>Все конфигурационные файлы, связанные с jabber, имеют формат XML и находятся в
                каталоге <filename>/etc/jabber</filename>. </para>
            <para>Обязательно надо прописать имя хоста и РАЗРЕШИТЬ регистрации. </para>
        </section>
        <section>
            <info>
                <title>Запуск демона</title>
            </info>
            <para>Добавляем запуск сервера при старте системы: </para>
            <screen><prompt>#</prompt> <userinput>rc-update add jabber default</userinput></screen>
            <para>Стартуем наш сервер:</para>
            <screen><prompt>#</prompt> <userinput>/etc/init.d/jabber start</userinput></screen>
            <para>Все должно работать :)</para>
        </section>
    </section>
    <section>
        <info>
            <title>Выделенный сервер Counter-Strike</title>
        </info>
        <para>Рано или поздно у большинства админов локальных сетей возникает необходимость
            настраивать игровые сервера для пользователей. Одной из самых популярных сетевых игр на
            сегодняшний день является Counter-Strike.CS:Source. Которая, к сожалению пока не
            приобрела достаточной популярности у нас в России. Мы рассмотриму установку сервера для
            игры CS 1.6. Более популярной в среде российских геймеров. </para>
        <section>
            <info>
                <title>Необходимое программное обеспечение</title>
            </info>
            <para>Для установки CS-сервера нам понадобится только одна программа:
                halflife-steam</para>
            <screen># emerge -pv halflife-steam
Calculating dependencies ...done!
[ebuild N ] games-server/halflife-steam-2.0 3,431 kB
Total size of downloads: 3,431 kB </screen>
            <para>Steam — это утилита от Valve,позволяющая обновлять любую их игру через
                steam-network. </para>
        </section>
        <section>
            <title>Установка и настройка</title>
            <section>
                <title>Ставим steam</title>
                <para>Установка сводится к простому <command>emerge halflife-steam</command>.</para>
            </section>
            <section>
                <title>Настройка установка hl</title>
                <para>Steam установится в каталог <filename>/opt/halflife</filename>.</para>
                <important>
                    <para>в ноябре 2006 года в пакете была бага. Что характерно для всех продуктов
                        получаемых через стим, они иногда забывают unix специфику. Непостредственно
                        у меня, на steam не стоял бит исполняемости. И в cs было имя типа
                            <filename>xxx.WAD</filename> (нужно <filename>wad</filename>,
                        различаеться регистр) </para>
                </important>
                <example>
                    <title>Команды</title>
                    <screen><prompt>#</prompt> <userinput>cd /opt/halflife</userinput>
<prompt>#</prompt> <userinput>chmod +x steam</userinput>
<prompt>#</prompt> <userinput>./steam -command update -game cstrike -dir ./</userinput></screen>
                </example>
                <para>Наблюдаем лог. Если никаких слов типа error нет — значит сервер установился. </para>
                <example>
                    <title>output</title>
                    <screen>HLDS installation up to date</screen>
                </example>
                <warning>
                    <para>Этот сервер работает только в LAN (класс С) и только со steam клиентами.
                        Все остальное Варез.</para>
                </warning>
            </section>
        </section>
    </section>
    <section>
        <title>Файл сервер Samba в домене Win2k</title>
        <section>
            <title>Задача</title>
            <para>Организация файлового сервера </para>
            <para>Авторизация пользователей через домен контроллер </para>
        </section>
        <section>
            <title>Дано</title>
            <para>Red Hat 9.0 </para>
            <para>Samba 3.0.13 </para>
            <para>DC win 2003 server </para>
        </section>
        <section>
            <title>Вступление </title>
            <para>Взяться за написание данной статьи меня побудило то, что когда возникла задача о
                которой написано выше , то статьи описывающей решение данной проблемы полностью я не
                нашел вот и решил написать такую статью в которой было бы готовое решение. </para>
        </section>
        <section>
            <info>
                <title>Основная часть </title>
            </info>
            <para>Первым делом устанавливаем самбу. Решено было использовать последнюю версию
                3.0.13. Установлено все это было из стандартного RPM пакета. Думаю с этим сложностей
                ни у кого не возникает, док по данному вопросу полно и потому начнем сразу править
                конфиг самбы. Ниже приведен окончательный работающий конфиг, может там и есть что
                лишнее, но после того как все заработало я убирать оттуда ничего не стал.</para>
            <programlisting>[global]
   realm = bryusov.iasnet.ru
 # Workgroup = имя NT-домена (или рабочей группы): 
   workgroup = DOMAIN  

 # NetBIOS-имя, под которым будет виден сервер остальным машинам сети.
   netbios name = NAU

 # Комментарий, появляющийся рядом с именем машины в "Сетевом окружении" Windows.
   server string = Samba Server

 # Следующий параметр влияет на безопасность. Hosts allow разрешает машинам с 
 # указанными IP-адресами присоединяться к Samba-серверу. 
   hosts allow = 172.18. 172.17.  127.

 # если подставить %m то для каждой машины, подключенной к Samba-серверу будет 
 # использоваться свой log-файл. 
   log file = /var/log/samba/log.smbd   

 # это кому сколько не жалко             
   max log size = 500    

 # определяет, каким образом будет осуществляться проверка пароля (нам надо через DC)                                          
   security = domain

 # Параметр Password server используется только совместно с опцией security = domain
   password server =  &lt;IP домен контролера>

 # для репликации всех доменов входящих в траст с вашим доменом
   allow trusted domains = yes        	

 # включаем  поддержку шифрованных паролей. 
   encrypt passwords = yes

 # Используя следующий параметр можно создать отдельную конфигурацию для каждой машины домена. 
 # Вместо пары символов %m при входе подставляется NetBIOS-имя машины. 
 # Я Такого не делал хотя поэксперементровать можно.
 # include = /usr/local/samba/lib/smb.conf.%m

 # данные строчки можно не включать в работающий конфиг они определяют место
 # хранения, порядок обновления Unix паролей и какой программой все это производится
   smb passwd file = /etc/samba/smbpasswd
   unix password sync = Yes
   passwd program = /usr/bin/passwd %u
   passwd chat = *New*UNIX*password* %n\n *ReType*new*UNIX*password* %n\n *passwd:*all*authentication*tokens*updated*successfully*

 # В документации  говорится, что с помощью этого параметра
 # можно повысить производительность Samba-сервера.
   socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192

 # по дефолту слушаются все интерфейсы, здесь можно указать конкретно
   interfaces = &lt;ip или название интерфейса>

 # строчки которых не было в стандартном конфиге и были добавлены руками для pепликации NT-юзеpов:

  winbind uid = 10000-20000
  winbind gid = 10000-20000
  winbind enum groups = yes
  winbind enum users = yes

 # Если вам нужны русские буквы в именах файлов, то раскоментируйте 
 # следующие 3 строки (заменив KOI8-R на свою локаль)
 # dos charset = CP866       
 # unix charset = KOI8-R     
 # display charset = KOI8-R  



 # описываем шары
 [FILES]
   comment = share
   path = /share/FILES
   public = no
   writable = yes
   valid users = DOMAIN\users
   create mask = 0744

 # настройка кириллицы по желанию
</programlisting>
            <para>Все с конфигом самбы закончили, далее привожу конфиг
                    <filename>/etc/krb5.conf</filename></para>
            <programlisting> [logging]
  default = FILE:/var/log/krb5libs.log
  kdc = FILE:/var/log/krb5kdc.log
  admin_server = FILE:/var/log/kadmind.log

 [libdefaults]
  ticket_lifetime = 24000
  default_realm = PDC.DOMAIN.NAME.RU
  dns_lookup_realm = false
  dns_lookup_kdc = false

 [realms]
  DOMAIN.NAME.RU = {
   kdc = pdc.domain.name.ru:88
   admin_server = kerberos.domain.name.ru:749
   default_domain = domain.name.ru
  }

 [domain_realm]
  .domain.name.ru = DOMAIN.NAME.RU
  domain.name.ru = DOMAIN.NAME.RU

 [kdc]
  profile = /var/kerberos/krb5kdc/kdc.conf

 [appdefaults]
  pam = {
    debug = false
    ticket_lifetime = 36000
    renew_lifetime = 36000
    forwardable = true
    krb4_convert = false
  }</programlisting>
            <para>Все остальное оставлено без изменений. </para>
            <para>Теперь заводим самба сервер в домен, делаем со стороны домен контролера
                двусторонние доверительные отношения, запускаем <command>getent group</command> и
                видим что все работает. </para>
            <para>Вот и все надеюсь полезной инфы достаточно для быстрой и эффективной настройки
                файл сервера. </para>
            <para>Огромное спасибо всем кто писал статьи про самбу почти все их прочитал и почерпнул
                много полезного , в том числе не только для решения своих задач.</para>
        </section>
    </section>
    <section>
        <info>
            <title>Руководство по настройке Samba в режиме PDC с использованием LDAP</title>
        </info>
        <section>
            <info>
                <title>Устанавливаемые пакеты </title>
            </info>
            <para>Установим нужные пакеты: </para>
            <screen><prompt>#</prompt> <userinput>USE="ldap acl ldapsam pam gdbm samba ssl tcpd winbind" emerge samba openldap acl nss_ldap pam_ldap</userinput></screen>
            <important>
                <para>Версия nss_ldap должна быть не ниже 250-r1 (&gt;=sys-auth/nss_ldap-250-r1)
                </para>
            </important>
        </section>
        <section>
            <title>OpenLDAP</title>
            <section>
                <title>Конфигурирование OpenLDAP</title>
                <para>Для примера используется домен amber.global.com который является дочерним
                    доменом домена global.com, который работает под управлением Win2003 Server. </para>
                <note>
                    <para>Не решенной задачей осталось создание доверительных отношений между
                        доменами и включение домена amber в лес global.com </para>
                </note>
                <example>
                    <title>Файл: <filename>/etc/openldap/slapd.conf</filename></title>
                    <programlisting># Включение схем для настройки приложений
 include /etc/openldap/schema/core.schema
 include /etc/openldap/schema/cosine.schema
 include /etc/openldap/schema/inetorgperson.schema
 include /etc/openldap/schema/misc.schema
 include /etc/openldap/schema/nis.schema
 include /etc/openldap/schema/openldap.schema
 include /etc/openldap/schema/samba.schema

 pidfile			/var/run/openldap/slapd.pid
 argsfile		/var/run/openldap/slapd.args

# Подгружаемые модули backend - сервера
 modulepath      /usr/lib/openldap/openldap
 moduleload     back_hdb.so

# Настройка доступа к базе.
 access to dn.base=""
		by self write
		by * auth
 access to attrs=userPassword
		by self write
		by * auth
 access to attrs=shadowLastChange
		by self write
		by * read
access  to attrs=sambaLMPassword,sambaNTPassword
                by dn="dc=amber,dc=global,dc=com" write
                by * auth
 access to *
                by * read
                by anonymous auth


# Уровень отладки. Полезно при настройке смотреть в messages. По окончании можно указать 1
 loglevel        256

 database        bdb # Версия ldmb устаревшая, в версии ldap-2.4 от нее вообще отказались
 suffix          "dc=amber,dc=global,dc=com"
 rootdn          "cn=Manager,dc=amber,dc=global,dc=com"

 # Пароль rootpw лучше всего указывать в зашифрованном виде.
 # Для генерации шифрованного пароля используйте утилиту slappasswd
 # Например: slappasswd -h {MD5}
 # rootpw = secret
 rootpw		{MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==
 directory	/var/lib/openldap-data

# Индексы для приложений
 index objectClass           eq
 index cn                    eq,subinitial
 index sn                    eq,subinitial
 index uid                   eq,subinitial
 index displayName           eq,subinitial
 index uidNumber             eq
 index gidNumber             eq
 index memberUID             eq
# Индексы для SAMBA
 index sambaSID              eq
 index sambaPrimaryGroupSID  eq
 index sambaDomainName       eq</programlisting>
                </example>
                <example>
                    <title>Файл: <filename>/etc/openldap/ldap.conf</filename></title>
                    <programlisting>HOST 127.0.0.1
BASE dc=sanaa,dc=global,dc=com</programlisting>
                </example>
                <para>Проверяем разрешения на каталоги
                    <filename>/var/lib/openldap-*</filename></para>
                <screen><prompt>#</prompt> <userinput>ls -la /var/lib/</userinput>
drwx------   2 ldap     ldap      104 Июн  8 18:31 openldap-data
drwx------   2 ldap     ldap       72 Июн  8 18:31 openldap-ldbm
drwx------   2 ldap     ldap       72 Июн  8 18:31 openldap-slurp</screen>
            </section>
            <section>
                <title>Запуск сервера OpenLDAP</title>
                <para>пока работаем без шифрования трафика, так как сервер LDAP и SAMBA работают на
                    одном сервере, подправляем конфиг чтобы LDAP слушал 389 порт только на
                    localhost. </para>
                <example>
                    <title>Файл: <filename>/etc/conf.d/sldap</filename></title>
                    <programlisting># conf.d file for the openldap-2.1 series
#
# To enable both the standard unciphered server and the ssl encrypted
# one uncomment this line or set any other server starting options
# you may desire.
#
# OPTS="-h 'ldaps:// ldap:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'"
OPTS="-h 'ldap://127.0.0.1'"</programlisting>
                </example>
                <para>и запускаем OpenLDAP </para>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/slapd start</userinput></screen>
            </section>
        </section>
        <section>
            <title>SAMBA</title>
            <section>
                <title>Миграция OpenLDAP</title>
                <para>Существует 2 пути создания учетных записей пользователей: домен уже существует
                    и создание нового домена. В первом случае самбу нужно настроить в режиме BDC,
                    перенести все учетные записи, и потом изолировав PDC, перезапустить самбу в
                    режиме PDC. Во втором случае все еще проще, самбу сразу запускаем в режиме PDC и
                    создаем стандарные учетные записи при помощи замечательного пакета
                    smbldap-tools. </para>
                <screen><prompt>#</prompt> <userinput>emerge smbldap-tools</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/samba start</userinput></screen>
                <example>
                    <title>Code: <filename>configure.pl</filename></title>
                    <programlisting>-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
       smbldap-tools script configuration
       -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
Before starting, check
 . if your samba controller is up and running.
 . if the domain SID is defined (you can get it with the 'net getlocalsid')

 . you can leave the configuration using the Crtl-c key combination
 . empty value can be set with the "." character
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
Looking for configuration files...

Samba Configuration File Path [/etc/samba/smb.conf] > 
The default directory in which the smbldap configuration files are stored is shown.
If you need to change this, enter the full directory path, then press enter to continue.
Smbldap-tools Configuration Directory Path [/etc/smbldap-tools/] > 
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
Let's start configuring the smbldap-tools scripts ...

. workgroup name: name of the domain Samba act as a PDC
  workgroup name [amber] > 
. netbios name: netbios name of the samba controler
  netbios name [neptun] > 
. logon drive: local path to which the home directory will be connected 
 (for NT Workstations). Ex: 'H:'
  logon drive [U:] > 
. logon home: home directory location (for Win95/98 or NT Workstation).
  (use %U as username) Ex:'\\neptun\%U'
  logon home (press the "." character if you don't want homeDirectory) [\\%L\users\%U] > 
. logon path: directory where roaming profiles are stored. Ex:'\\neptun\profiles\%U'
  logon path (press the "." character if you don't 
  want roaming profile) [\\%L\Profiles\%a\%U] > 
. home directory prefix (use %U as username) [/home/%U] > 
. default users' homeDirectory mode [700] > 
. default user netlogon script (use %U as username) [] >
   default password validation time (time in days) [45] > 900
. ldap suffix [dc=amber,dc=global,dc=com] > 
. ldap group suffix [ou=Groups] > 
. ldap user suffix [ou=Users] > 
. ldap machine suffix [ou=Users] > 
. Idmap suffix [ou=Idmap] > 
. sambaUnixIdPooldn: object where you want to store the next uidNumber
  and gidNumber available for new users and groups
  sambaUnixIdPooldn object (relative to ${suffix}) [sambaDomainName=amber] > 
. ldap master server: IP adress or DNS name of the master (writable) ldap server
  ldap master server [127.0.0.1] > 
. ldap master port [389] > 
. ldap master bind dn [cn=Manager,dc=amber,dc=global,dc=com] > 
. ldap master bind password [] >  
. ldap slave server: IP adress or DNS name of the slave ldap server: can also 
  be the master one
  ldap slave server [127.0.0.1] > 
. ldap slave port [389] > 
. ldap slave bind dn [cn=Manager,dc=amber,dc=global,dc=com] > 
. ldap slave bind password [] >  
. ldap tls support (1/0) [0] > 
. SID for domain amber: SID of the domain (can be obtained with 'net getlocalsid neptun')
  SID for domain amber [S-1-5-21-1918777035-593721947-2697221154] > 
. unix password encryption: encryption used for unix passwords
  unix password encryption (CRYPT, MD5, SMD5, SSHA, SHA) [SSHA] > MD5
. default user gidNumber [513] > 
. default computer gidNumber [515] > 
. default login shell [/bin/bash] > 
. default skeleton directory [/etc/skel] > 
. default domain name to append to mail adress [] > 
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
backup old configuration files:
  /etc/smbldap-tools/smbldap.conf->/etc/smbldap-tools/smbldap.conf.old
  /etc/smbldap-tools/smbldap_bind.conf->/etc/smbldap-tools/smbldap_bind.conf.old
writing new configuration file:
  /etc/smbldap-tools/smbldap.conf done.
  /etc/smbldap-tools/smbldap_bind.conf done.</programlisting>
                </example>
                <para>Если мы не хотим, что бы у всех пользователей профили были перемещаемыми, то в
                    файле <filename>/etc/smbldap-tools/smbldap.conf</filename> установим следующее
                    значение:</para>
                <example>
                    <title>Файл: <filename>/etc/smbldap-tools/smbldap.conf</filename></title>
                    <programlisting>...
 userProfile=""
 ...</programlisting>
                </example>
                <para>Инициализируем каталоги самбы в LDAP: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-populate -a Administrator -k 0 -m 0</userinput></screen>
            </section>
            <section>
                <title>Конфигурация SAMBA</title>
                <example>
                    <title>Файл: <filename>/etc/samba/smb.conf</filename></title>
                    <programlisting>[global]
	workgroup = amber
	netbios name = neptun
	realm = amber.global.com
	nt acl support = yes
	acl compatibility = win2k
	map acl inherit = yes
	server string = Samba Server %v
	interfaces = eth0
	bind interfaces only = yes
	hosts allow = 192.168.7. 127.
	log file = /var/log/samba/log.%m
	debug level = 9
	max log size = 500
	socket options = TCP_NODELAY SO_SNDBUF=8192 SO_RCVBUF=8192
	security = user
	os level = 250
	passdb backend = ldapsam:"ldap://127.0.0.1/"
	enable privileges = yes
	
	passwd program = /usr/sbin/smbldap-passwd "%u"
	passwd chat = *new*password* %n\n *new*password* %n\n *successfully*
	passdb expand explicit = no
	unix password sync = no
	ldap passwd sync = no
	
	ldap suffix = dc=amber,dc=global,dc=com
	ldap admin dn = cn=Manager,dc=amber,dc=global,dc=com
	ldap user suffix = ou=Users
	ldap group suffix = ou=Groups
# Т.к. для самбы компьютеры и пользователи - одно и то же,
# и искать она в дальнейшем записи компьютеров будет в пользователях,
# то для избежания дальнейших проблем при добавлении рабочих станций
# к домену мы вместо следующей строки
#
#	ldap machine suffix = ou=Computers
#
# напишем другую:
	ldap machine suffix = ou=Users
	ldap idmap suffix = ou=Idmap
	idmap backend = ldapsam:ldap://127.0.0.1/
	idmap uid = 10000-20000
	idmap gid = 10000-20000
	
	ldap delete dn = Yes
	ldap ssl = no
	
	
	add user script = /usr/sbin/smbldap-useradd -n -a "%u"
	delete user script = /usr/sbin/smbldap-userdel "%u"
	
	add group script = /usr/sbin/smbldap-groupadd -p "%g"
	delete group script = /usr/sbin/smbldap-userdel "%g"
	
	add user to group script = /usr/sbin/smbldap-groupmod -m "%u" "%g"
	delete user from group script = /usr/sbin/smbldap-groupmod -x "%u" "%g"
	set primary group script = /usr/sbin/smbldap-usermod -g "%g" "%u"
	
	
	add machine script = /usr/sbin/smbldap-useradd -w "%u"
	
	#PDC
	domain master = yes
	preferred master = yes
	#BDC
#	domain master = no
#	preferred master = no
	domain logons = Yes
	

	logon script = 
# Если хотите, что бы профили всех пользователей были перемещаемыми
# и хранились на сервере (со всеми гигабайтами фильмов и личных фотографий)
# то укажите такое значение следующего параметра:
#
#	logon path = \\%L\Profiles\%a\%U
#
# Если вы не хотите гонять профили по сети, оставьте значение пустым, 
# (но ни в коем случае не комментируйте эту строку, она просто получит 
# значение по умолчанию), вот так:
	logon path =
	logon drive = U: 
	logon home = \\%L\users\%U
	
	
#============================ Share Definitions ==============================
[netlogon]
    comment = Network Logon Service
    path = /var/lib/samba/netlogon
    browseable = yes
    guest ok = yes
    writable = no
    share modes = no

[Profiles]
    admin users = admin
    create mode = 600
    directory mode = 700
    path = /var/lib/samba/profiles
    browseable = yes
    guest ok = yes
    writable = yes

[homes]
  comment = Home Directories
  browseable = no
  read only = no

[public]
  path = /pub
  guest ok = yes
  read only = no

[users]
  path = /home/users
  writable = yes
  printable = no</programlisting>
                </example>
                <para>Добавим запуск winbind с самбой (если нужно):</para>
                <example>
                    <title>Файл: /etc/conf.d/samba</title>
                    <programlisting> ...
 daemon_list="smbd nmbd winbind"
 ...</programlisting>
                </example>
                <para>Введём пароль рабочей станции: </para>
                <screen><prompt>#</prompt> <userinput>smbpasswd -w secret </userinput></screen>
                <para>Введём контроллёр домена, собственно в домен </para>
                <screen><prompt>#</prompt> <userinput>net rpc join -S neptun -U Administrator </userinput></screen>
            </section>
        </section>
        <section>
            <info>
                <title>Настройка системы на авторизацию в LDAP</title>
            </info>
            <para>--ladserg 14:05, 28 июля 2006 (UTC) У меня честно говоря не получилось сделать
                авторизацию пользователей samba через LDAP без настройки поддержки авторизации
                системных пользователей в LDAP, пришлось настраивать и это. </para>
            <para>Сначала поправим файл <filename>/etc/ldap.conf</filename>, приведя его примерно к
                следующему виду: </para>
            <example>
                <title>Файл: <filename>/etc/ldap.conf</filename>
                </title>
                <programlisting> host 127.0.0.1
 base dc=amber,dc=global,dc=com
 ldap_version 3
 rootbinddn cn=Manager,dc=amber,dc=global,dc=com
 bind_timelimit 10
 bind_policy soft
 pam_filter objectClass=posixAccount
 pam_password exop
 nss_base_passwd         ou=Users,dc=tty,dc=perm,dc=ru?one
 nss_base_shadow         ou=Users,dc=tty,dc=perm,dc=ru?one
 nss_base_group          ou=Groups,dc=tty,dc=perm,dc=ru?one
 nss_base_hosts          ou=Hosts,dc=tty,dc=perm,dc=ru?one
 nss_base_services       ou=Services,dc=tty,dc=perm,dc=ru?one
 nss_base_networks       ou=Networks,dc=tty,dc=perm,dc=ru?one
 nss_base_protocols      ou=Protocols,dc=tty,dc=perm,dc=ru?one
 nss_base_rpc            ou=Rpc,dc=tty,dc=perm,dc=ru?one
 nss_base_ethers         ou=Ethers,dc=tty,dc=perm,dc=ru?one
 nss_base_netmasks       ou=Networks,dc=tty,dc=perm,dc=ru?one
 nss_base_bootparams     ou=Ethers,dc=tty,dc=perm,dc=ru?one
 nss_base_aliases        ou=Aliases,dc=tty,dc=perm,dc=ru?one
 nss_base_netgroup       ou=Netgroup,dc=tty,dc=perm,dc=ru?one
 ssl off
 nss_reconnect_tries 4
 nss_reconnect_sleeptime 1
 nss_reconnect_maxsleeptime 16
 nss_reconnect_maxconntries 2</programlisting>
            </example>
            <para>Сим мы скажем nss_ldap где и как искать зписи пользователей и групп. </para>
            <para>Теперь создадим файл <filename>/etc/ldap.secret</filename> и при помощи любого
                текстого редактора в plain/text виде занесём туда пароль пользователя, который выше
                у нас указан в опции rootbinddn, нпример пароль secret: </para>
            <example>
                <title>Файл: <filename>/etc/ldap.secret</filename></title>
                <programlisting>secret</programlisting>
            </example>
            <para>Затем непременно установим на него нужные права:</para>
            <example>
                <title>Установка прав на файл /etc/ldap.secret</title>
                <screen><prompt>#</prompt> <userinput>chmod 600 /etc/ldap.secret</userinput>
<prompt>#</prompt> <userinput>chown root:wheel /etc/ldap.secret</userinput></screen>
            </example>
            <para>Далее приведём файл <filename>/etc/pam.d/system-auth</filename> к следующему виду: </para>
            <example>
                <title>Файл: /etc/pam.d/system-auth </title>
                <programlisting> auth       required     pam_env.so
 auth       sufficient   pam_unix.so likeauth nullok
 auth       sufficient   pam_ldap.so use_first_pass
 auth       required     pam_deny.so

 account    sufficient   pam_ldap.so
 account    required     pam_unix.so

 password   required     pam_cracklib.so difok=2 minlen=8 dcredit=2 ocredit=2 retry=3
 password   sufficient   pam_unix.so nullok md5 shadow use_authtok
 password   sufficient   pam_ldap.so use_authtok
 password   required     pam_deny.so

 session    required     pam_limits.so
 session    required     pam_unix.so
 session    required     pam_mkhomedir.so skel=/etc/skel/ umask=077
 session    optional     pam_ldap.so</programlisting>
            </example>
            <para>Обратите внимание на строку: </para>
            <programlisting>session required pam_mkhomedir.so skel=/etc/skel/ umask=077 </programlisting>
            <para>Она заставляет систему создавать домашние каталоги для тех пользоватей у которых
                они ещё не созданы, при этом в новый каталог помещается содержимое директории
                    <filename>/etc/skel/</filename> и задаётся маска каталога 0x700 </para>
            <para>После чего правим файл <filename>/etc/nsswitch.conf</filename>, приводя его к
                следующему виду: </para>
            <example>
                <title>Файл: /etc/nsswitch.conf </title>
                <programlisting> passwd:      files ldap
 shadow:      files ldap
 group:       files ldap

 hosts:       files dns
 networks:    files dns

 services:    db files
 protocols:   db files
 rpc:         ldap [NOTFOUND=return] db files
 ethers:      ldap [NOTFOUND=return] db files
 netmasks:    files
 netgroup:    ldap [NOTFOUND=return] files
 bootparams:  files

 automount:   files
 aliases:     files</programlisting>
            </example>
            <warning>
                <para>Ни в коем случае не добавляйте значение ldap к следующим базам: hosts,
                    networks, protocols, services. Иначе вы рискуете не дождаться следующей загрузки
                    системы. </para>
            </warning>
            <para>Всё, теперь мы указали системе брать пользователей как из системных файлов, так и
                из LDAP. </para>
            <para>Перезагрузим наш компьютер, дабы убедиться что система грузится нормально. Если
                система останавливается на загрузке udev, то смотрите ошибки в файле
                    <filename>/etc/nsswitch.conf</filename>, может вы указали использовать ldap не в
                той базе. </para>
        </section>
        <section>
            <info>
                <title>Управление пользователями</title>
            </info>
            <para>Ранее мы установили пакет smbldap-tools, теперь рассмотрим возможность управления
                пользователями с его помощью. </para>
            <section>
                <title>Создание пользователя</title>
                <synopsis>smbldap-useradd [-o] [-a] [-b] [-w] [-i] [-u uid] [-g gid ] [-G groups,,,]
 [-n] [-d home] [-s shell] [-c gecos] [-m [-k]] [-t] [-P] [-A 0|1] [-B 0|1]
 [-C sambaHomePath] [-D sambaHomeDrive] [-E sambaLogonScript] [-F sambaProfilePath]
 [-H sambaAcctFlags] [-N surname] [-S family name] [-M local mailAddress,,,]
 [-T mailToAddress] [-?] user</synopsis>
                <para>Где: </para>
                <para> user — системное имя создаваемого пользователя</para>
                <para> -o   — add the user in the organizational unit (relative to the user
                    suffix)</para>
                <para> -a   — is a Windows User (otherwise, Posix stuff only)</para>
                <para> -b   — is a AIX User</para>
                <para> -w   — is a Windows Workstation (otherwise, Posix stuff only)</para>
                <para> -i   — is a trust account (Windows Workstation)</para>
                <para> -u   — uid</para>
                <para> -g   — gid</para>
                <para> -G   — список групп пользователя, разделённых запятой.</para>
                <para> -n   — do not create a group</para>
                <para> -d   — домашний каталог пользователя (по умолчанию
                    /home/имя_пользователя)</para>
                <para> -s   — оболочка пользователя (по умолчанию /bin/false)</para>
                <para> -c   — отображаемое в Windows имя пользователя</para>
                <para> -m   — создать домашний каталог и скопировать в него файлы из
                    /etc/skel</para>
                <para> -k   — указать иной каталог, из которого будут копироваться файлы при        
                    создании домашнего каталога пользователя (используется с ключём -m)</para>
                <para> -t   — time. Wait 'time' seconds before exiting (when adding Windows
                    Workstation)</para>
                <para> -P   — ends by invoking smbldap-passwd</para>
                <para> -A   — возможность менять пароль пользователем, значение 0 если нет, 1 если
                    да</para>
                <para> -B   — пользователь должен поменять пароль, значение 0 если нет, 1 если
                    да</para>
                <para> -C   — домашний каталог samba (например '\\PDC-SRV\homes')</para>
                <para> -D   — буква диска для монтирования домашнего каталога samba (например
                    'H:')</para>
                <para> -E   — скрипт, выполняемый при входе в систему</para>
                <para> -F   — каталог профиля пользователя (например
                    '\\PDC-SRV\profiles\foo')</para>
                <para> -H   — sambaAcctFlags (samba account control bits like
                    '[NDHTUMWSLKI]')</para>
                <para> -N   — настоящее имя пользователя (для русских ещё и отчество)</para>
                <para> -S   — фамилия пользователя</para>
                <para> -M   — local mailAddress (comma seperated)</para>
                <para> -T   — mailToAddress (forward address) (comma seperated)</para>
                <para> -?   — отобразить помощь</para>
                <para>Например создание пользователя ladserg: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-useradd -a -c 'Serg Alex Lad' -N 'Serg Alex' -S 'Lad' -s /bin/bash ladserg </userinput></screen>
                <para>К сожалению подружить smbldap-tools с русским мне не удалось, даже при
                    использовании кодировки UTF-8. </para>
                <para>Итак, в приведённом выше примере будет создан пользователь с системным именем
                    ladserg, фамилией Lad, именем Serg Alex, оболочкой /bin/bash, домашним каталогом
                    /home/ladserg. Флаг -a укажет, что пользователь также будет являться
                    пользователем домена. </para>
            </section>
            <section>
                <title>Изменение пароля</title>
                <synopsis>smbldap-passwd [-s] [-u] [-h] username</synopsis>
                <para>Где: </para>
                <para> username       — имя пользователя</para>
                <para> -h, -?, --help — показать помощь</para>
                <para> -s             — обновить только samba пароль</para>
                <para> -u             — обновить только UNIX пароль</para>
                <para>Например: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-passwd ladserg </userinput></screen>
                <para>После чего дважды будет запрошен пароль. </para>
                <para>Теперь можно попробовать зайти в систему под учётной записью только что
                    созданного пользователя. </para>
            </section>
            <section>
                <title>Модификация пользователя</title>
                <synopsis>smbldap-usermod [-a] [-c comment] [-d home_dir] [-e expiration_date]
 [-g initial_group] [-r new_login_name] [-p passwd] [-s shell] [-u uid [ -o]] [-x]
 [-A canchange] [-B mustchange] [-C smbhome] [-D homedrive] [-E scriptpath]
 [-F profilepath] [-G group[,...]] [-H acct‐flags] [-N canonical_name]
 [-S surname] [-P] login</synopsis>
                <para>Где: </para>
                <para> -c    - Полное имя</para>
                <para> -d    - Домашний каталог</para>
                <para> -r    - новое имя пользователя (cn, sn и dn будут обновлены)</para>
                <para> -u    - uid</para>
                <para> -o    - uid может быть не уникальным</para>
                <para> -g    - gid</para>
                <para> -G    - список групп пользователя, разделённых запятой.</para>
                <para> -s    - оболочка</para>
                <para> -N    - настоящее имя пользователя (для русских ещё и отчество)</para>
                <para> -S    - фамилия пользователя</para>
                <para> -P    - ends by invoking smbldap-passwd</para>
                <para>For samba users:</para>
                <para> -a    - add sambaSAMAccount objectclass</para>
                <para> -e    - expire date ("YYYY-MM-DD HH:MM:SS")</para>
                <para> -A    - возможность менять пароль пользователем, значение 0 если нет, 1 если
                    да</para>
                <para> -B    - пользователь должен поменять пароль, значение 0 если нет, 1 если
                    да</para>
                <para> -C    - домашний каталог samba (например '\\PDC-SRV\homes')</para>
                <para> -D    - буква диска для монтирования домашнего каталога samba (например
                    'H:')</para>
                <para> -E    - скрипт, выполняемый при входе в систему</para>
                <para> -F    - каталог профиля пользователя (например
                    '\\PDC-SRV\profiles\foo')</para>
                <para> -H    - sambaAcctFlags (samba account control bits like
                    '[NDHTUMWSLKI]')</para>
                <para> -I    - disable an user. Can't be used with -H or -J</para>
                <para> -J    - enable an user. Can't be used with -H or -I</para>
                <para> -M    - mailAddresses (comma seperated)</para>
                <para> -T    - mailToAddress (forward address) (comma seperated)</para>
                <para> -?|-h — отобразить помощь</para>
                <para>Например команда: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-usermod -A 1 ladserg</userinput></screen>
                <para>Позволит пользователю ladserg менять пароль. А команда: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-usermod -a slad-adm</userinput></screen>
                <para>Добавит к учётной записи пользователя slad-adm класс sambaSAMAccount, что
                    сделает его пользователем samba. </para>
            </section>
            <section>
                <title>Удаление пользователя</title>
                <synopsis>smbldap-userdel [-r|-R|-?] username</synopsis>
                <para>Где: </para>
                <para> -r    удалить домашний каталог</para>
                <para> -R    удалить домашний каталог с запросом на удаление каждого файла</para>
                <para> -?    отобразить помощь</para>
                <para>Например команда: </para>
                <screen><prompt>#</prompt> <userinput>smbldap-userdel -r slad-adm</userinput></screen>
                <para>удалит пользователя slad-adm, и его домашний каталог. </para>
            </section>
        </section>
        <section>
            <title>Управление пользователями в оффтопике</title>
            <para>Если вы вводите в домен компьютеры под управлением Windows, то вам пригодятся пара
                утилит, архив которых можно скачать отсюда: </para>
            <para>
                <link xmlns:xlink="http://www.w3.org/1999/xlink"
                    xlink:href="ftp://ftp.microsoft.com/Softlib/MSLFILES/SRVTOOLS.EXE"
                    >ftp://ftp.microsoft.com/Softlib/MSLFILES/SRVTOOLS.EXE</link>
            </para>
        </section>
    </section>
    <section>
        <info>
            <title>Мониторинг работы системы</title>
        </info>
        <section>
            <info>
                <title>Введение</title>
            </info>
            <para>В данной статье описывается, как осуществить мониторинг разных системных и
                физических параметров компьютеров, работающих под GNU/Linux или другими UNIX.
            </para>
        </section>
        <section>
            <title>Постановка задачи</title>
            <para>Нужно осуществлять постоянный мониторинг основных параметров работы компьютеров
                (физических и системных) через сеть, собирать и выдавать эту информацию в удобной
                форме.</para>
            <para>Для примера см: <link xlink:href="http://monitoring.sourceforge.net/example.html"
                    >http://monitoring.sourceforge.net/example.html</link></para>
            <para>К основным системным параметрам относят: загрузка процессоров (пользователями,
                системой, привилегированными программами, свободное процессорное время),
                использования оперативной памяти (и многие другие, всего больше 100), дисков,
                сетевого трафика. Для получения необходимых нам значений параметров работы системы
                используем программы df, sar и iptables или ipfw.</para>
            <para>К физическим параметрам относят: температуру процессора и материнской платы,
                скорость вращения вентиляторов, напряжения питания. Для получения показателей
                датчиков материнских плат используется модуль ядра I2C и программа
                lm_sensors.</para>
            <para>Для передачи информации через сеть используем клент-серверную модель и программу
                Net-Telnet. Базу данных строим пакетом rrdtool, информацию предоставляем через
                сервер apache и/или по почте. С помощью скриптов постараемся максимально упростить и
                автоматизировать поставленную задачу, это избавит вас от рутинной работы.</para>
            <para>Программа работает по клиент-серверной технологии. На компьютерах, которые нужно
                мониторить, размещается часть программы, которая снимает различные показатели работы
                компьютера и выдает их по запросу через сеть. На одном административном компьютере
                осуществляется периодический опрос всех компьютеров, за которыми ведется наблюдение,
                данные записываются в специально созданную базу, и на её основе формируется html
                страница, которая экспортируется через apache для просмотра обычным
                браузером.</para>
            <para>Теперь подробно о том, что нам нужно сделать:</para>
            <para>Загружаем последнюю версию программы для мониторинга с сайта <link
                    xlink:href="http://monitoring.sourceforge.net/"
                    >http://monitoring.sourceforge.net/</link>. Файл
                    <filename>monitoring-*.tar.bz2</filename> размещаем в доступном месте, например
                в папке локального ftp: <filename>/var/ftp/pub/linux</filename>.</para>
        </section>
        <section>
            <title>"Серверная" сторона</title>
            <para>Разархивируйте <filename>monitoring-*.tar.bz2</filename>.</para>
            <para>У Gentoo есть ебилд, для установки программы monitoring со всеми зависимостями. С
                сайта необходимо скачать <filename>monitoring-*.ebuild.tar.bz2</filename> и
                распаковать его в <filename>/usr/local</filename>. Далее выполните: </para>
            <para>
                <screen><prompt>#</prompt> <userinput>emerge -pv monitoring</userinput>
[ebuild N ] net-analyzer/monitoring-0.11 USE="-admin -apache2 -lm_sensors -server"</screen>
            </para>
            <para>Для серверной стороны необходимо добавить <code>USE="server"</code>, а для
                поддержки мониторинга датчиков <code>USE="lm_sensors"</code>.</para>
            <screen><prompt>#</prompt> <userinput>export "USE=lm_sensors server"</userinput>
<prompt>#</prompt> <userinput>emerge monitoring</userinput></screen>
            <para>Компиляция и установка lm_sensors, sysstat, iptables, coreutils, xinetd в случае
                использования Gentoo можно пропустить, потому что эти пакеты уже установлены как
                зависимости, и перейти сразу к их настройке. </para>
            <section>
                <title>Мониторинг физических параметров</title>
                <para>Определяем на базе какого чипсета сделаны платы: материнская, видеокарта
                    (некоторые имеют датчики) и прочие, заходим на страницы: <link
                        xlink:href="http://secure.netroedge.com/~lm78/supported.html"
                        >http://secure.netroedge.com/~lm78/supported.html</link> и <link
                        xlink:href="http://www.lm-sensors.nu/~lm78/newdrivers.html"
                        >http://www.lm-sensors.nu/~lm78/newdrivers.html</link> и ищем, есть ли
                    драйверы для мониторинга этих плат под Линуксом. Если определили, что ваши
                    чипсеты поддерживаются и драйвер стабильный, можете продолжить выполнение этого
                    пункта.</para>
                <para>Внимание, если версия ядра меньше за 2.4.9, нужно обновить ядро или
                    воспользоваться старой версией программы! смотрите: <link
                        xlink:href="http://khali.linux-fr.org/devel/i2c/">i2c</link>. Если ядро
                    версии 2.4.*, вам дополнительно нужен СООТВЕТСТВУЮЩИЙ! модуль i2c-*.*.*.tar.gz,
                    родной Линуксовый не подходит. В версии ядра 2.6.* все хорошо — отлично работает
                    родной модуль ядра i2c. </para>
                <section>
                    <title>Компиляция ядра</title>
                    <para>Подробную инструкцию по сборке нового ядра можно прочесть по ссылке
                        "Ставим ядро 2.6, или Ядерная физика для домохозяйки. Версия 2.0"</para>
                    <para>Обратите особое внимание на пункты, которые добавляют к ядру GNU/Linux
                        поддержку сенсоров:</para>
                    <para>Для поддержания ACPI: </para>
                    <screen>Power management options (ACPI, APM) ---&gt; ACPI (Advanced Configuration and Power Interface) Support ---&gt;</screen>
                    <para>Для поддержки IPMI стандарта управления сенсорами. </para>
                    <screen>Device Drivers ---&gt; Character devices ---&gt; IPMI ---&gt;</screen>
                    <para>Включаем поддержку сенсоров в ядре </para>
                    <screen>Device Drivers ---&gt; I2C support ---&gt;</screen>
                    <para>Выбираем алгоритмы, использующие ваши чипы </para>
                    <screen>Device Drivers ---&gt; I2C support ---&gt; I2C Algorithms ---&gt;</screen>
                    <para>Выбираем ваш чипсет (внимание, здесь нужно указать чипсет именно вашей
                        системной платы, или видеокарты, см. ниже): </para>
                    <screen>Device Drivers ---&gt; I2C support ---&gt; I2C Hardware Bus support ---&gt;
Device Drivers ---&gt; I2C support ---&gt; Miscellaneous I2C Chip support ---&gt;</screen>
                    <para>Выбираем драйверы ко всем вашим сенсорам (внимание, именно тех,
                        соответствующих вашим чипам, предыдущим пунктам): </para>
                    <screen>Device Drivers ---&gt; Hardware Monitoring support ---&gt;</screen>
                    <para>Можно собрать необходимые драйверы как модули, хотя это несколько добавит
                        работы при настройке (нужно будет запустить программу sensors-detect). Для
                        мониторинга сети можно использовать netfilter (iptables) и прочие опции...
                    </para>
                </section>
                <section>
                    <title>Если Ваше аппаратное обеспечения поддерживается, установите
                        lm_sensors</title>
                    <para>Загружаем с: lm_sensors, свеженькую версию
                            <filename>lm_sensors-*.*.*.tar.gz</filename>. Разархивируем
                            <filename>lm_sensors-*.*.*.tar.gz</filename>. Заходим в директорию,
                        какая создалась и выполняем: </para>
                    <screen><prompt>#</prompt> <userinput>make user</userinput>
<prompt>#</prompt> <userinput>make user_install</userinput>
<prompt>#</prompt> <userinput>depmod -a</userinput></screen>
                    <para>Проверяем, есть ли строка <filename>/usr/local/lib</filename> в файле
                            <filename>/etc/ld.so.conf</filename>, если нет, добавляем и выполняем
                        команду: </para>
                    <screen><prompt>#</prompt> <userinput>ldconfig</userinput></screen>
                    <section>
                        <title>Настройка lm_sensors</title>
                        <para>Выполняем команду </para>
                        <screen><prompt>#</prompt> <userinput>prog/mkdev/mkdev.sh</userinput></screen>
                        <para>Чтобы правильно определить ваше оборудование и знать, какие модули
                            нужно загрузить, выполним: </para>
                        <screen><prompt>#</prompt> <userinput>prog/detect/sensors-detect</userinput></screen>
                        <para>именно этот скрипт и указывает, какие у вас чипсеты, и какие в них
                            сенсоры!</para>
                        <para>Добавляем строки, созданные программой для
                                <filename>modules.conf</filename> в
                                <filename>/etc/modules.conf</filename>.</para>
                        <para>Копируем <filename>prog/init/lm_sensors.init</filename> в каталог
                                <filename>/etc/rc.d/init.d/lm_sensors</filename> (назначить права
                            для исполнения).</para>
                        <para>Добавляем строки, которые создала программа
                                <filename>prog/detect/sensors-detect</filename> с modprobe и sensors
                            -s например, в конец файла <filename>/etc/conf.d/local.start</filename>
                            — чтобы они загружались при старте системы</para>
                        <para>или можно запускать как сервис:</para>
                        <para>для Gentoo выполняем: </para>
                        <screen><prompt>#</prompt> <userinput>rc-update -a lm_sensors default</userinput></screen>
                        <para>Только для клонов RedHat выполняем: </para>
                        <screen><prompt>#</prompt> <userinput>chkconfig --add lm_sensors</userinput></screen>
                        <para>копируем <filename>prog/init/lm_sensors.sysconfig</filename> в
                                <filename>/etc/sysconfig/lm_sensors</filename></para>
                        <para>копируем <filename>etc/sensors.conf.eg</filename> в
                                <filename>/etc/sensors.conf</filename></para>
                        <para>копируем <filename>prog/sensors/sensors</filename> в каталог
                                <filename>/usr/bin/sensors</filename> (предоставить права на
                            выполнение) </para>
                        <para>Все теперь выполняют modprobe с параметрами, которые указала программа
                            sensors-detect для загрузки модулей, потом выполняем: </para>
                        <screen><prompt>#</prompt> <userinput>sensors -s</userinput></screen>
                        <para>Корректируем <filename>/etc/sensors.conf</filename> таким образом,
                            чтобы названия напряжений, скорости вентиляторов и температур, именно
                            Ваших чипов содержали соответственно: "Volt", "Fan", "Temp". При этом,
                            названия меток допускают только малые и большие латинские буквы, цифры,
                            знак "_", и не должны содержать знаков „.”, ”/” или ”+”! Выполнение этих
                            условий обязательно!!!</para>
                        <para>Пример <filename>/etc/sensors.conf</filename> можно найти в
                                <filename>server/etc/sensors.conf</filename></para>
                        <para>Например, для lm85*: </para>
                        <screen><prompt>#</prompt> <userinput>cat /etc/sensors.conf</userinput>
...
# Voltage inputs
  label in0   "VoltA1_5"      # AGP on Intel S845WD1-E
  label in1   "Volt1_5"
  label in2   "Volt3_3"
  label in3   "Volt5"
  label in4   "Volt12"
# Temperature inputs
  label temp1  "TempCPU"
  label temp2  "TempMB1"
  label temp3  "TempMB2"
# Fan inputs
  label fan1   "FanCPU"
  label fan2   "FanSys1"
  label fan3   "FanSys2"
  label fan4   "FanSys3"
# PWM Outputs
  label pwm1   "CPUF_PWM"
  label pwm2   "SysF1_PWM"
  label pwm3   "SysF2_PWM"
...</screen>
                        <para>Теперь выполним команду <command>sensors</command>, и если у нас все
                            получилось, то увидим примерно следующее: </para>
                        <screen><prompt>#</prompt> <userinput>sensors</userinput>
lm85b-i2c-0-2e 
Adapter: SMBus I801 adapter at c800 
VoltA1_5:   +1.48 V  (min =  +1.42 V, max =  +1.58 V)
Volt1_5:    +1.50 V  (min =  +1.45 V, max =  +1.60 V)
Volt3_3:    +3.33 V  (min =  +3.13 V, max =  +3.47 V)
Volt5:     +5.10 V  (min =  +4.74 V, max =  +5.26 V)
Volt12:   +12.31 V  (min = +11.38 V, max = +12.62 V)
FanCPU:    3360 RPM  (min = 3000 RPM)
TempCPU:     +36C  (low  =   +10C, high =   +60C)
TempMB1:     +33C  (low  =   +10C, high =   +45C)
TempMB2:     +33C  (low  =   +10C, high =   +45C)
CPUF_PWM:  255
SysF1_PWM: 255
SysF2_PWM:  77
vid:      +1.525 V    (VRM Version  9.1)</screen>
                        <para>Если у вас названия напряжений, скорости вентиляторов и температуры не
                            содержат соответственно: "Volt", "Fan", "Temp" — обязательно
                            отредактируйте файл /etc/sensors.conf как показано выше. </para>
                    </section>
                </section>
            </section>
            <section>
                <title>Мониторинг системных параметров</title>
                <section>
                    <title>Установка sysstat</title>
                    <para>Загружаем последнюю версию пакета sysstat с сайта <link
                            xlink:href="http://perso.wanadoo.fr/sebastien.godard/"
                            >http://perso.wanadoo.fr/sebastien.godard/</link> или <link
                            xlink:href="ftp://ibiblio.org/pub/Linux/system/status/"
                            >ftp://ibiblio.org/pub/Linux/system/status/</link>. </para>
                    <para>Розархивируем файл <filename>sysstat-*.*.*.tar.bz2</filename> в
                            <filename>/usr/src</filename>
                    </para>
                    <para>Заходим в созданный каталог и выполняем: </para>
                    <screen><prompt>#</prompt> <userinput>make config</userinput>       <lineannotation>#Отвечаем на вопросы только 'y' или 'n'</lineannotation>
<prompt>#</prompt> <userinput>make</userinput>
<prompt>#</prompt> <userinput>make install</userinput></screen>
                    <para>Теперь из командной строки пробуем: </para>
                    <screen><prompt>#</prompt> <userinput>sar -A 1 1 |grep Average:</userinput>
Average:       proc/s 
Average:         0.00 
Average:      cswch/s 
Average:       258.00 
Average:          CPU     %user     %nice   %system   %iowait     %idle 
Average:          all      1.90      0.00      0.40      0.00     97.70 
........................................................................
Average:      runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15 
Average:            0        83      0.06      0.15      0.16</screen>
                </section>
                <section>
                    <title>Проверка df</title>
                    <screen><prompt>#</prompt> <userinput>df</userinput>
Filesystem           1K-blocks      Used Available Use% Mounted on
/dev/sda3              2007996    411772   1596224  71% /
/dev/sda1               132206     10981    114399  43% /boot
/dev/sda5               248895      4256    231789   2% /tmp
/dev/sda6              5863496   2556028   3307468  64% /var
/dev/sda7              6843432   5128048   1715384  75% /usr
/dev/sda8              1976492   1048740    827348  56% /home
/dev/sda9              5863496   4479752   1383744  77% /usr/portage/distfiles
none                    254752         0    254752   0% /dev/shm
/usr/portage/distfiles 5863496   4479752   1383744  77% /var/ftp/pub/linux/distfiles
/usr/portage/packages  6843432   5128048   1715384  75% /var/ftp/pub/linux/packages</screen>
                    <para>Если Вам выдало: </para>
                    <screen>bash: df: command not found</screen>
                    <para>установите df из пакета coreutils. </para>
                </section>
            </section>
            <section>
                <title>Мониторинг сети</title>
                <para>Мониторинг сети основывается на подсчете байт, попадающих в правила сетевых
                    экранов — iptables или ipfw, и поэтому они достаточно гибкие, но является
                    зависимым от конфигурации сетевого экрана.</para>
                <para>Если Вы хотите осуществлять мониторинг сети: просмотрите
                        <filename>server/etc/show_network.conf</filename>
                        (<filename>/etc/monitoring/show_network.conf</filename>) – это список
                    графиков, которые Вы получите. Он должен отвечать названиям графиков в
                        <filename>admin/etc/network</filename>
                        (<filename>/etc/monitoring/network</filename>). </para>
                <section>
                    <title>Linux iptables</title>
                    <para>Нужно откорректировать
                            <filename>server/etc/show_iptables_acc.conf</filename>
                            (<filename>/etc/monitoring/show_network.conf</filename>)</para>
                    <para>1 колонка – название графика (должна отвечать show_network.conf, но с
                        “in_*.N” или “out_*.N”, где N – некоторый идентификатор, например
                        число)</para>
                    <para>2 колонка – название таблицы</para>
                    <para>3 колонка – название цепочки с таблицы</para>
                    <para>4 колонка – порядковый номер правила с цепочки</para>
                    <para>Это всё должно отвечать Вашим правилам!</para>
                    <para>Простые примеры экранов находятся в <filename>server/firewall/*</filename>
                        и если подходит Вам, можете использовать их.</para>
                    <para>Проверьте работу <filename>/usr/bin/show_iptables.sh</filename>. Результат
                        найдёте в <filename>/home/monitoring</filename>
                    </para>
                </section>
                <section>
                    <title>FreeBSD ipfw</title>
                    <para>Для BSD, надо откорректировать
                            <filename>server/bin/show_ipf_acc.conf</filename>:</para>
                    <para>1 колонка – название графика</para>
                    <para>2 колонка – номер правила</para>
                    <para>3 колонка – порядковый номер правила в ipfw show</para>
                    <para>Это должно отвечать Вашим правилам!</para>
                    <para>Проверьте работу <filename>/usr/bin/show_ipfw.sh</filename> Результат в
                            <filename>/home/monitoring</filename>
                    </para>
                </section>
            </section>
            <section>
                <title>Некоторые важные системные настройки</title>
                <para>Если нет xinetd – установите его. Загляньте в
                        <filename>server/etc/host.allow</filename>
                        (<filename>/etc/host.allow</filename>): </para>
                <programlisting># BEGIN allow services for monitoring
show_hdisk.sh:127.0.0.1 # IP ком пьютера что мониторит
show_sensors.sh:127.0.0.1 # IP ком пьютера что мониторит
show_info.sh:127.0.0.1 # IP ком пьютера что мониторит
show_system.sh:127.0.0.1 # IP ком пьютера что мониторит
show_network.sh:127.0.0.1 # IP ком пьютера что мониторит
# END allow services for monitoring</programlisting>
                <para>Также некоторые из них вы можете изменить в
                        <filename>server/bin/show_*</filename> и строки "<code>only_from</code>",
                        <code>"bind</code>" и "<code>disable</code>" в
                        <filename>server/xinetd.d/show_*</filename>
                </para>
                <screen><prompt>#</prompt> <userinput>cat server/xinetd.d/show_hdisk</userinput>
# default: on
# description: The showdisk server show disk useg on the server.
#       It dont uses authentication !!!!!!!!!!!!!!!.
service df
{
       socket_type             = stream
       wait                    = no
       user                    = monitoring
       bind                    = 127.0.0.1               # IP сетевого интерфейса, на котором мониторят
       server                  = /usr/bin/show_hdisk.sh
       only_from               = 127.0.0.1               # IP комп'ютера, который мониторит
       disable                 = no                      # Вкл./Выкл.
}</screen>
                <para>Откройте доступ к следующим портам: 9045/tcp 9046/tcp 9047/tcp 9048/tcp
                    9049/tcp с административного компьютера в случае наличия сетевых экранов. Если
                    Вы хотите осуществить установку вручную, пропустите следующий пункт. </para>
            </section>
            <section>
                <title>Автоматическая инсталляция</title>
                <para>Для автоматической установки отредактируйте следующие строки в
                        <filename>monitoringinstall.sh</filename>
                        (<filename>/usr/sbin/monitoringinstall.sh</filename>):</para>
                <programlisting># Edit this first:
# all command will execute user:
runuser=monitoring
rungroup=monitoring
# cron cfg directory
cronpath=/etc/cron.d
# init script locations:
crond=/etc/init.d/crond
# Edit only for server side:
# init script location:
xinetd=/etc/init.d/xinetd
# program location:
dfpath=/bin/df
sarpath=/usr/bin/sar
sensorspath=/usr/bin/sensors</programlisting>
                <para>Теперь с правами суперпользователя выполните: </para>
                <screen><prompt>#</prompt> <userinput>./monitoringinstall.sh --server</userinput></screen>
                <para>В Gentoo просто: </para>
                <screen><prompt>#</prompt> <userinput>monitoringinstall.sh --server</userinput></screen>
                <para>Вы можете пропустить пункт следующий пункт и перейти к „административной”
                    части системы. </para>
            </section>
            <section>
                <title>Ручная установка</title>
                <para>Копируем следующие файлы: </para>
                <screen><prompt>#</prompt> <userinput>cp server/etc/show_iptables_acc.conf /etc/monitoring</userinput>	<lineannotation>#for GNU/Linux</lineannotation>
<prompt>#</prompt> <userinput>cp server/etc/show_ipfw_acc.conf /etc/monitoring</userinput>	    <lineannotation>#for BSD</lineannotation>
<prompt>#</prompt> <userinput>cp server/etc/show_network.conf /etc/monitoring</userinput>
<prompt>#</prompt> <userinput>cp server/xinetd.d/show_hdisk /etc/xinetd.d/</userinput>
<prompt>#</prompt> <userinput>cp server/xinetd.d/show_network /etc/xinetd.d/</userinput>
<prompt>#</prompt> <userinput>cp server/xinetd.d/show_sensors /etc/xinetd.d/</userinput>
<prompt>#</prompt> <userinput>cp server/xinetd.d/show_system /etc/xinetd.d/</userinput>
<prompt>#</prompt> <userinput>cp server/bin/show_hdisk.sh /usr/bin</userinput>
<prompt>#</prompt> <userinput>cp server/bin/show_iptables.sh /usr/bin</userinput>	        	 <lineannotation>#for GNU/Linux</lineannotation>
<prompt>#</prompt> <userinput>cp server/bin/show_ipfw.sh /usr/bin</userinput>	        	 	<lineannotation>#for BSD</lineannotation>
<prompt>#</prompt> <userinput>cp server/bin/show_network.sh /usr/bin</userinput>
<prompt>#</prompt> <userinput>cp server/bin/show_sar.sh /usr/bin</userinput>
<prompt>#</prompt> <userinput>cp server/bin/show_sensors.sh /usr/bin</userinput>
<prompt>#</prompt> <userinput>cp server/bin/show_system.sh /usr/bin</userinput></screen>
                <para>Добавим следующие строки к <filename>/etc/service</filename>:</para>
                <programlisting>network   9045/tcp                        # show network info
info      9046/tcp                        # show server info
df        9047/tcp                        # show disk info
sys       9048/tcp                        # show system info
sensors   9049/tcp                        # show sensors info</programlisting>
                <para>Создадим специального пользователя: </para>
                <screen><prompt>#</prompt> <userinput>groupadd monitoring</userinput>
<prompt>#</prompt> <userinput>useradd -g monitoring -d /home/monitoring -s /bin/bash -c monitoring monitoring</userinput>
<prompt>#</prompt> <userinput>mkdir /home/monitoring</userinput>
<prompt>#</prompt> <userinput>chmod 700 /home/monitoring</userinput>
<prompt>#</prompt> <userinput>chown -R monitoring:monitoring /home/monitoring</userinput></screen>
                <para>В случае использования политик SELinux необходимо также добавить: </para>
                <screen><prompt>#</prompt> <userinput>cat /etc/security/selinux/src/policy/users</userinput>
...
# BEGIN monitoring selinux:
user monitoring roles user_r;
# END monitoring selinux.</screen>
                <para>и дополнительно выполнить: </para>
                <screen><prompt>#</prompt> <userinput>cd /etc/security/selinux/src/policy</userinput>
<prompt>#</prompt> <userinput>make load</userinput></screen>
                <para>Перегрузим xinetd: </para>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/xinetd restart</userinput></screen>
                <para>и добавьте строки в <filename>crontab</filename>: </para>
                <programlisting>*/10 * * * * monitoring /usr/bin/show_iptables.sh	# для GNU/Linux
*/10 * * * * monitoring /usr/bin/show_ipfw.sh		# для BSD
*/1 * * * * monitoring /usr/bin/show_sar.sh</programlisting>
                <para>Перегрузим crond: </para>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/crond restart</userinput></screen>
                <para>Все вышесказанное нужно сделать на КАЖДОМ сервере, который вы хотите
                    мониторить... </para>
            </section>
        </section>
        <section>
            <title>"Административная" сторона</title>
            <section>
                <title>Для начала убедитесь что все хорошо со стороны серверов</title>
                <para>Для каждого сервера проверяем доступность необходимых сервисов: </para>
                <screen><prompt>#</prompt> <userinput>telnet server_name 9045</userinput>
Trying serverIP...
Connected to serverIP.
Escape character is '^]'.
in_ftp    		0
out_ftp   		0
in_http    		0
out_http   		0
in_other    		249
out_other   		27
Connection closed by foreign host.

<prompt>#</prompt> <userinput>telnet server_name 9046</userinput>
Trying serverIP...
Connected to server_name.
Escape character is '^]'.
  Intel(R) Celeron(R) CPU 2.40GHz | 504 Mb
Connection closed by foreign host.

<prompt>#</prompt> <userinput>telnet server_name 9047</userinput>
Trying serverIP...
Connected to server_name.
Escape character is '^]'.
/dev/sda3              2007996    411772   1596224  71% /
/dev/sda1               132206     10981    114399  43% /boot
/dev/sda5               248895      4256    231789   2% /tmp
/dev/sda6              5863496   2556028   3307468  64% /var
/dev/sda7              6843432   5128048   1715384  75% /usr
/dev/sda8              1976492   1048740    827348  56% /home
/dev/sda9              5863496   4479752   1383744  77% /usr/portage/distfiles
Connection closed by foreign host.

<prompt>#</prompt> <userinput>telnet server_name 9048</userinput>
Trying serverIP...
Connected to server_name.
Escape character is '^]'.
Average:       proc/s
Average:         3.98
Average:      cswch/s
Average:       308.00
Average:          CPU     %user     %nice   %system   %iowait     %idle
Average:          all      1.76      0.00      0.47      0.00     97.76
.............................................................
Average:      runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15
Average:            1        88      0.05      0.21      0.21
Connection closed by foreign host.

<prompt>#</prompt> <userinput>telnet server_name 9049</userinput>
Trying serverIP...
Connected to server_name.
Escape character is '^]'.
lm85b-i2c-0-2e
Adapter: SMBus I801 adapter at c800

Volt1_5:    +1.48 V  (min =  +1.42 V, max =  +1.58 V)
VoltCore:   +1.50 V  (min =  +1.45 V, max =  +1.60 V)
Volt3_3:    +3.33 V  (min =  +3.13 V, max =  +3.47 V)
Volt5:     +5.10 V  (min =  +4.74 V, max =  +5.26 V)
Volt12:   +12.25 V  (min = +11.38 V, max = +12.62 V)
CPU_Fan:   3377 RPM  (min = 3000 RPM)
fan2:         0 RPM  (min =    0 RPM)
fan3:         0 RPM  (min =    0 RPM)
fan4:         0 RPM  (min =    0 RPM)
TempCPU:     +32 C  (low  =   +10 C, high =   +50 C)
TempBoard:   +30 C  (low  =   +10 C, high =   +45 C)
TempRemot:   +30 C  (low  =   +10 C, high =   +40 C)
CPU_PWM:   255
Fan2_PWM:  255
Fan3_PWM:   77
vid:      +1.525 V  (VRM Version 9.0)

Connection closed by foreign host.</screen>
            </section>
            <section>
                <title>Установка необходимых программ</title>
                <para>Разархивируйте <filename>monitoring-*.tar.bz2</filename>.</para>
                <para>Для Gentoo есть ебилд, для установления программы monitoring со всеми
                    зависимостями с сайта стоит брать
                        <filename>monitoring-*.ebuild.tar.bz2</filename> и распаковать его в
                        <filename>/usr/local</filename> дальше выполните: </para>
                <screen><prompt>#</prompt> <userinput>emerge -pv monitoring</userinput>
[ebuild N ] net-analyzer/monitoring-0.11 USE="-admin -apache2 -lm_sensors -server"</screen>
                <para>Для административной стороны необходимо добавить <code>USE=admin</code>, а для
                    поддержки apache-2* <code>USE=apache2</code>.</para>
                <screen><prompt>#</prompt> <userinput>export "USE=admin apache2"</userinput>
<prompt>#</prompt> <userinput>emerge monitoring</userinput></screen>
                <para>Компиляцию и установление rrdtool, apache, Net-Telnet в случае использования
                    Gentoo можно пропускать, потому что эти пакеты уже будут установлены как
                    зависимости, а переходить сразу к их настройке. </para>
                <section>
                    <title>Инсталляция rrdtool</title>
                    <para><indexterm>
                            <primary>rrdtool</primary>
                        </indexterm>Базой данных, для хранения информации и инструмент генерации
                        графиков, используется пакет rrdtool (round robin database tool). Зкачать
                        пакет можно отсюда: <link xlink:href="http://rrdtool.eu.org"
                            >http://rrdtool.eu.org</link> или <link
                            xlink:href="http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/"
                            >http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/</link>. Подробно
                        ознакомиться с этим пакетом можно здесь: <link
                            xlink:href="http://www.bog.pp.ru/work/rrdtool.html"
                            >http://www.bog.pp.ru/work/rrdtool.html</link> (Российская). В принципе,
                        программа самостоятельно создаст необходимые базы так, что дополнительных
                        знаний не нужно и следующий пункт Пример расчёта настройки базы RRD можно
                        пропустить. </para>
                    <section>
                        <title>Пример расчёта настройки базы RRD</title>
                        <para>Расчёт настроек создания базы RRD файлы /etc/monitoring/*.rrd.cf
                            Количество "слов" в файле будет соотведствовать количеству графиков в
                            разных маштабах времени. например для расчёта подобия MRTG: 5-ти
                            минутный — даные за последние 2 дня: х-доля=0.5 количество отсчётов на
                            ячейку=1 количество ячеек=2*24*12=576 +min+max+avg+cur ~ 650 </para>
                        <programlisting>0.5:1:650</programlisting>
                        <para>30-ти минутный — дание за последние две недели: х-доля=0.5 количество
                            отсчётов на ячейку=30/5=6 количество ячеек=2*7*24*2=672 +min+max+avg+cur
                            ~ 750 </para>
                        <programlisting>0.5:6:750</programlisting>
                        <para>2-ух часовой — даные за последние два месяца: х-доля=0.5 количество
                            отсчётов на ячейку=60*2/5=24 количество ячеек=2*31*24/2=744
                            +min+max+avg+cur ~ 850 </para>
                        <programlisting>0.5:24:850</programlisting>
                        <para>1-но дневный — даные за последние два года: х-доля=0.5 количество
                            отсчётов на ячейку=60*24/5=288 количество ячеек=2*366=732
                            +min+max+avg+cur ~ 900 </para>
                        <programlisting>0.5:288:900</programlisting>
                        <para>Таким образом имеем: </para>
                        <screen><prompt>#</prompt> <userinput>cat /etc/monitoring/5min.rrd.cf</userinput>
0.5:1:650        0.5:6:750        0.5:24:850        0.5:288:900</screen>
                    </section>
                    <section>
                        <title>Инсталляция Net-Telnet</title>
                        <para>Данная версия программы для работы через сеть требует Net-Telnet perl
                            модуль (можно при желании использовать и netcat): из-за этого нужно
                            установить perl (что пожалуй уже сделано). Дальше Net-Telnet perl модуль
                            берем и устанавливаем отсюда: <link
                                xlink:href="http://cpan.perl.org/modules/by-module/Net/"
                                >http://cpan.perl.org/modules/by-module/Net/</link> название файлу
                                <filename>Net-Telnet-*.tar.gz</filename>. </para>
                    </section>
                    <section>
                        <title>Инсталляция Apache</title>
                        <para>Нужно установить и настроить apache сервер, дополнительно можете
                            добавить (<filename>admin/etc/apache/monitoring.conf</filename>): </para>
                        <programlisting># cat /etc/apache2/vhosts.d/monitoring.conf
### /etc/apache2/vhosts.d/monitoring.conf
### $Id: monitoring.conf,v 0.11 2006/09/28 16:27:12 hse Exp $
###
### For Monitoring *.shtml
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml
### For authentication:
&lt;Directory "/var/www/localhost/htdocs/administration/monitoring">
   AllowOverride All
   Options Includes
   &lt;IfModule mod_access.c>
### For password authentication:
#       AuthUserFile /var/www/localhost/htdocs/administration/passwd_file
#       AuthGroupFile /dev/null
#       AuthName Administrative-information
#       AuthType Basic
#       Require valid-user
### For host/network authentication:
	Order deny,allow
	Deny from all
	Allow from 127.0.0.1
#	Allow from .cluster.linux
    &lt;/IfModule>
&lt;/Directory></programlisting>
                        <para>Добавляем пользователя для просмотра веб страницы: </para>
                        <screen><prompt>#</prompt> <userinput>htpasswd -bcm /var/www/localhost/htdocs/administration/passwd_file <replaceable>username</replaceable> <replaceable>password</replaceable></userinput></screen>
                        <para>Если все хорошо идем дальше. </para>
                    </section>
                </section>
                <section>
                    <title>Установка программ для мониторинга</title>
                    <para>В файл <filename>admin/etc/host</filename>
                            (<filename>/etc/monitoring/host</filename>) вносим перечень серверов,
                        которые нужно мониторить (имена должны разрешаться в IP адреса). Коректируем
                        под свои потребности файл <filename>admin/etc/monitoring.conf</filename>
                            (<filename>/etc/monitoring/monitoring.conf</filename>) </para>
                    <programlisting><lineannotation>путь по которому установлено скрипт:</lineannotation>
installpath=/usr/
<lineannotation>путь к веб страницe:</lineannotation>
apachehtmldir=/var/www/html
webdirpath=/administration/monitoring
<lineannotation>путь к файлу с перечнем серверов для мониторинга:</lineannotation>
confpath=$installpath/etc/host
<lineannotation>путь к временных файлов:</lineannotation>
diskinfopath=/tmp/monitoring/disk.tmp
sarinfopath=/tmp/monitoring/sar.tmp
sensorsinfopath=/tmp/monitoring/sensors.tmp
<lineannotation>путь где установлен пакет rrdtool:</lineannotation>
rrdtoolpath=/usr/bin/rrdtool
<lineannotation>почтовый адрес:</lineannotation>
emailvalue=root@localhost</programlisting>
                    <para>По желанию (или за потребностью) правим другие файлы с каталога
                            <filename>etc/</filename>
                        (<filename>/etc/monitoring/</filename>):</para>
                    <para>diskusage memusage quantity cpu memory systemload — содержимое файлов
                        должно отвечать тем параметрам которые Вы хотите мониторить. Все параметры
                        должны выводиться командой <command>sar -A 1 1 |grep Average:</command>.
                        Названия файлов отвечают названиям графиков и баз которые создадутся и
                        должны быть записаны в файле system. Значение параметров принадлежащих одном
                        файлу должны быть одного типа!</para>
                    <para>system — первая колонка определяет какие графики получите и каждый ее
                        элемент отвечать файлу из этого же каталога (см. выше). Вторая указывает
                        через какие периоды времени база rrdtool будет принимать данные. Третья и
                        четвертая колонка определяет минимальное и максимальное значение параметра
                        которое еще может быть записано в базу. Пятая колонка определяет легенду
                        (размерность).</para>
                    <para>сolors — файл с номерами цветов в 16-ричной системе.</para>
                    <para>config — содержит имена конфигурационных файлов из этого же каталога
                        отвечающие веб страницам что создаються (можно добавлять свои, но тогда их
                        должны создать!).</para>
                    <para>disk — содержит названия графиков, периоды времени через которые база
                        rrdtool будет принимать данные, минимальные и максимальные значение
                        параметров которые мониторите, легенду (размерность).</para>
                    <para>network — содержит названия графиков, периоды времени через которые база
                        rrdtool будет принимать данные, минимальные и максимальные значение
                        параметров которые мониторите, легенду (размерность).</para>
                    <para>sensors — содержит названия графиков, периоды времени через которые база
                        rrdtool будет принимать данные, минимальные и максимальные значение
                        параметров которые мониторите, легенду (размерность).</para>
                    <para>disk.rrd.cf network.rrd.cf sensors.rrd.cf system.rrd.cf — описывают
                        структуру базы данных.</para>
                    <para>disk.msg network.msg sensors.msg system.msg — содержит информацию которую
                        получите почтой в критических ситуациях.</para>
                    <para>Если хотите осуществить установку вручную, пропустите следующий пункт.
                    </para>
                </section>
                <section>
                    <title>Автоматическая установка программ</title>
                    <para>Теперь можете воспользоваться скриптом для инсталляции. Для этого нужно
                        откорректировать следующие строки в файле
                            <filename>monitoringinstall.sh</filename>
                            (<filename>/usr/sbin/monitoringinstall.sh</filename>) или пропустить
                        этот пункт и следовать дальнейшей инструкции для установки в ручную. </para>
                    <programlisting><lineannotation>имя пользователя и группы:</lineannotation>
runuser=monitoring
rungroup=monitoring
<lineannotation>директория где расположены cron настройки:</lineannotation>
cronpath=/etc/cron.d
<lineannotation>путь к инициализационному скрипту</lineannotation>
crond crond=/etc/init.d/crond
<lineannotation>директория где находятся настройки apache</lineannotation>
apachconfdir=/etc/apache/conf
<lineannotation>файл конфигурации apache:</lineannotation>
apachconffile=apache.conf
<lineannotation>путь к инициализационному скрипту apache</lineannotation>
apached=/etc/init.d/apache</programlisting>
                    <para>Теперь с правами рута выполните (нужно подождать 1 минуту, если не
                        установили мониторинг сети, и 10 минут после установки мониторынга сети на
                        последнем сервере, прежде чем выполнять следующую команду): </para>
                    <screen><prompt>#</prompt> <userinput>./monitoringinstall.sh --admin</userinput></screen>
                    <para>В Gentoo просто </para>
                    <screen><prompt>#</prompt> <userinput>monitoringinstall.sh --admin</userinput></screen>
                    <para>Если видите ошибки, наверное надо:</para>
                    <para>1 поправить файлы конфигурации в <filename>admin/etc/</filename>
                            (<filename>/etc/monitoring</filename>)</para>
                    <para>2 посмотреть в
                        <filename>/home/monitoring/hostname/err/...</filename></para>
                    <para>3 удалить файлы с <filename>/home/monitoring/hostname/</filename> и
                        перезапустить скрипт</para>
                    <para>4 удалить базы данных с <filename>/var/db/monitoring/...</filename> и
                        перезапустить скрипт</para>
                    <para>5 <filename>bin/net_telnet.pl</filename> читает только 500 строк входа.
                        Если в Вас больше, отредактируйте его:</para>
                    <programlisting>line 32: while [$и ne 500]</programlisting>
                    <para>Тогда попробуйте еще, но добавьте имена сервисов, под рутом выполните: </para>
                    <screen><prompt>#</prompt> <userinput>./monitoringinstall.sh --admin=disk</userinput>
<prompt>#</prompt> <userinput>./monitoringinstall.sh --admin=sensors</userinput>
<prompt>#</prompt> <userinput>./monitoringinstall.sh --admin=system</userinput>
<prompt>#</prompt> <userinput>./monitoringinstall.sh --admin=network</userinput></screen>
                    <para>Если где-то допустили ошибку, можно просто выполнить
                        monitoringuninstall.sh и попытаться еще раз. Можете пропустить следующий
                        пункт. </para>
                </section>
                <section>
                    <title>Ручная установка программ</title>
                    <para>Устанавливаем скриптыи для мониторинга, генерации базы данных и веб
                        страницы скопировав с каталога <filename>monitoring/admin</filename> в
                        каталог: <filename>/usr/ ($INSTALL_PATH)</filename>, используя опцию –p для
                        сохранения прав. Выполняем: </para>
                    <screen><prompt>#</prompt> <userinput>cp -p admin/bin/* $INSTALL_PATH/bin/</userinput>
<prompt>#</prompt> <userinput>mkdir /etc/monitoring</userinput>
<prompt>#</prompt> <userinput>cp -p admin/etc/* /etc/monitoring/</userinput>
<prompt>#</prompt> <userinput>mkdir $INSTALL_PATH/share/monitoring</userinput>
<prompt>#</prompt> <userinput>cp -p admin/share/* $INSTALL_PATH/share/monitoring/</userinput>

<prompt>#</prompt> <userinput>mkdir -p /var/www/localhost/htdocs/administration/monitoring</userinput>
<prompt>#</prompt> <userinput>chmod 755 /var/www/localhost/htdocs/administration/monitoring/</userinput>
<prompt>#</prompt> <userinput>groupadd -g 1111 monitoring</userinput>
<prompt>#</prompt> <userinput>useradd -u 1111 -g monitoring -d /home/monitoring -s /bin/bash -c monitoring monitoring</userinput>
<prompt>#</prompt> <userinput>chmod -R 700 /home/monitoring</userinput>
<prompt>#</prompt> <userinput>chown -R monitoring:monitoring /home/monitoring</userinput>
<prompt>#</prompt> <userinput>chown -R monitoring:monitoring /var/www/localhost/htdocs/administration/monitoring/</userinput></screen>
                    <para>И тогда выполняйте (подождите 1 минуту, если не устанавливали мониторинг
                        сети, и 10 минут после установки мониторинга сети на последнем сервере,
                        прежде чем выполнять следующую команду): </para>
                    <screen><prompt>#</prompt> <userinput>su monitoring</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/net.vert.1.sh</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/net.vert.10.sh</userinput></screen>
                    <para>создаются базы данных в каталоге
                                <filename>/var/db/monitoring/<replaceable>имя_сервера</replaceable>/</filename>
                        для всех серверов с файлу <filename>/etc/monitoring/host</filename> и
                        дополнительная конфигурация в <filename>/home/monitoring</filename></para>
                    <para>Выполняем: </para>
                    <screen><prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh disk -1week 30min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh disk -1month 2hour</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh disk -1year 1day</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh network -1week 30min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh network -1month 2hour</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh network -1year 1day</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh sensors -2day 5min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh sensors -1week 30min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh sensors -1month 2hour</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh sensors -1year 1day</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh system -2day 5min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh system -1week 30min</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh system -1month 2hour</userinput>
<prompt>$</prompt> <userinput>$INSTALL_PATH/bin/png_graph.sh system -1year 1day</userinput></screen>
                    <para>Если видите ошибки, наверное нужно:</para>
                    <para>1 поправить файлы конфигурации в
                        <filename>/etc/monitoring</filename></para>
                    <para>2 посмотреть в
                        <filename>/home/monitoring/hostname/err/...</filename></para>
                    <para>3 удалить файлы с <filename>/home/monitoring/hostname/</filename> и
                        перезапустить скрипт</para>
                    <para>4 удалить базы данных с <filename>/var/db/monitoring/...</filename> и
                        перезапустить скрипт</para>
                    <para>5 <filename>bin/net_telnet.pl</filename> читает только 500 строк входа.
                        Если в Вас больше, отредактируйте его:</para>
                    <programlisting>line 32: while [$и ne 500]</programlisting>
                    <para>Тогда попробуйте еще раз.</para>
                    <para>В каталоге
                            <filename>/var/www/localhost/htdocs/administration/monitoring</filename>
                        создаются начальная страница и каталоги с веб страницами для каждого
                        сервера.</para>
                    <para>Если не возникло больше ошибок, используйте следующий файл для
                        автоматизации всей работы с crond: </para>
                    <screen><prompt>$</prompt> <userinput>exit</userinput>
<prompt>#</prompt> <userinput>cat /etc/cron.d/monitoring</userinput>

SHELL=/bin/bash
PATH=/bin:/usr/bin
MAILTO=root
HOME=/home/monitoring
LANG=POSIX

# Begin server part (may be you wont monitoring "admin" computer too)
*/1 * * * * monitoring /usr/bin/show_sar.sh
*/10 * * * * monitoring /usr/bin/show_iptables.sh	#GNU/Linux
#*/10 * * * * monitoring /usr/bin/show_ipfw.sh		#BSD
# End server part

# Begin disk admin part
*/30 * * * * monitoring /usr/bin/png_graph.sh hdisk -1week 30min
0 */2 * * * monitoring /usr/bin/png_graph.sh hdisk -1month 2hour
0 0 * * * monitoring /usr/bin/png_graph.sh hdisk -1year 1day
# End  disk admin part

# Begin network admin part
*/30 * * * * monitoring /usr/bin/png_graph.sh network -1week 30min
0 */2 * * * monitoring /usr/bin/png_graph.sh network -1month 2hour
0 0 * * * monitoring /usr/bin/png_graph.sh network -1year 1day
# End  network admin part

# Begin system admin part
*/5 * * * * monitoring /usr/bin/png_graph.sh system -2day 5min
*/30 * * * * monitoring /usr/bin/png_graph.sh system -1week 30min
0 */2 * * * monitoring /usr/bin/png_graph.sh system -1month 2hour
0 0 * * * monitoring /usr/bin/png_graph.sh system -1year 1day
# End system admin part

# Begin sensors admin part
*/5 * * * * monitoring /usr/bin/png_graph.sh sensors -2day 5min
*/30 * * * * monitoring /usr/bin/png_graph.sh sensors -1week 30min
0 */2 * * * monitoring /usr/bin/png_graph.sh sensors -1month 2hour
0 0 * * * monitoring /usr/bin/png_graph.sh sensors -1year 1day
# End sensors admin part

# Begin vert admin part
*/1 * * * * monitoring /usr/bin/net.vert.1.sh
*/10 * * * * monitoring /usr/bin/net.vert.10.sh
# End  vert admin part
</screen>
                    <para>Выполняем: </para>
                    <screen><prompt>#</prompt> <userinput>/etc/init.d/crond restart</userinput></screen>
                </section>
            </section>
        </section>
        <section>
            <title>Если все хорошо</title>
            <para>Теперь заходим Вашим любимым браузером на страницу <link
                    xlink:href="http://servername/administration/monitoring/index.html"
                    >http://servername/administration/monitoring/index.html</link>. Здесь уже можем
                выбрать ссылки на сервер, который вас интересует :) </para>
        </section>
        <section>
            <title>Добавление новых серверов</title>
            <para>Если Вам когда-то придется добавить новый сервер, достаточно будет сделать
                следующее:</para>
            <para>1. Выполнить для него пункт 2 („Серверная” сторона)</para>
            <para>2. Добавить его имя в файл <filename>/etc/monitoring/host</filename></para>
            <para>Всё остальное создастся само !!! Наслаждайтесь :))) </para>
        </section>
        <section>
            <title>Альтернативы</title>
            <para>Если Вы недовольны реализацией мониторинга таким образом (по моему мнению
                достаточно неплохое решение ;)) подберите себе лучшую. Вот некоторый перечень
                альтернатив или дополнений :=) </para>
            <para>Angel Network Monitor <link xlink:href="http://www.paganini.net/angel/"
                    >http://www.paganini.net/angel/</link></para>
            <para>Autostatus <link xlink:href="http://www.angio.net/consult/autostatus/"
                    >http://www.angio.net/consult/autostatus/</link>
            </para>
            <para>Cacti <link xlink:href="http://cacti.net">http://cacti.net</link></para>
            <para>HiWAyS <link xlink:href="http://www.hiways.org/"
                >http://www.hiways.org/</link></para>
            <para>MARS <link xlink:href="http://www.altara.org/mars.html"
                    >http://www.altara.org/mars.html</link></para>
            <para>Mon <link xlink:href="http://www.altara.org/mars.html"
                    >http://www.kernel.org/software/mon/</link></para>
            <para>Monit <link xlink:href="http://www.tildeslash.com/monit/"
                    >http://www.tildeslash.com/monit/</link>
            </para>
            <para>Nagios <link xlink:href="http://www.nagios.org"
                >http://www.nagios.org</link></para>
            <para>Netup (French) <link xlink:href="http://www.pasteur.fr/units/sis/netup/"
                    >http://www.pasteur.fr/units/sis/netup/</link>
            </para>
            <para>NocMonitor <link xlink:href="http://www2.discpro.org/nocmon/"
                    >http://www2.discpro.org/nocmon/</link>
            </para>
            <para>NodeWatch <link xlink:href="http://www2.discpro.org/nocmon/"
                    >http://www.skendric.com/nodewatch/</link>
            </para>
            <para>Penemo <link xlink:href="http://www2.discpro.org/nocmon/"
                    >http://www.communityprojects.org/apps/penemo/</link>
            </para>
            <para>PIKT <link xlink:href="http://pikt.org/">http://pikt.org/</link>
            </para>
            <para>RITW <link xlink:href="http://www.terravista.pt/Ancora/1883/ritw_e.html"
                    >http://www.terravista.pt/Ancora/1883/ritw_e.html</link>
            </para>
            <para>RRDWorld <link xlink:href="http://oss.oetiker.ch/rrdtool/rrdworld/index.en.html"
                    >http://oss.oetiker.ch/rrdtool/rrdworld/index.en.html</link>
            </para>
            <para>Scotty <link xlink:href="http://wwwhome.cs.utwente.nl/~schoenw/scotty/"
                    >http://wwwhome.cs.utwente.nl/~schoenw/scotty/</link>
            </para>
            <para>Spong <link xlink:href="http://spong.sourceforge.net/"
                    >http://spong.sourceforge.net/</link>
            </para>
            <para>Sysmon <link xlink:href="http://www.sysmon.org/">http://www.sysmon.org/</link>
            </para>
            <para>ZABBIX <link xlink:href="http://www.zabbix.com">http://www.zabbix.com</link>
            </para>
            <para>ZEUS <link xlink:href="http://www.zeus.com/">http://www.zeus.com/</link>
            </para>
        </section>
    </section>
</article>
