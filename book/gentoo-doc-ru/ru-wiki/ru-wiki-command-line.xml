<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbookxi.rng" type="xml"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0">
    <info>
        <title>Секреты командной строки</title>
    </info>
    <section>
        <title>Общие команды</title>
        <para>поиск команды Linux, ее описания и номера секции man страниц </para>
        <screen>apropos word </screen>
        <para>закодировать файл file с помощью GnuPG </para>
        <screen>gpg -c file </screen>
        <para>раскодировать файл file </para>
        <screen>gpg file.gpg </screen>
        <para>быстрый поиск по словарю слов, начинающихся с word </para>
        <screen>look word </screen>
        <para>подсветить слово word в файле /somefile </para>
        <screen>grep --color word /somefile </screen>
        <para>запустить command с низким приоритетом </para>
        <screen>nice command </screen>
        <para>назначить низший приоритет текущему шеллу (и всем потомкам). Может быть полезно, если вашу систему сильно замедляет установка нового пакета (emerge). Кстати, для автоматического понижения приоритета emerge используется переменная PORTAGE_NICENESS в файле /etc/make.conf </para>
        <screen>renice 19 -p $$ </screen>
        <para>посмотреть код завершения предыдущей команды </para>
        <screen>echo $? </screen>
        <para>скачать список новых страничек с нашего сайта в 01:00 в текущую директорию </para>
        <screen>echo "wget http://ru.gentoo-wiki.com/Special:Newpages" | at 01:00 </screen>
        <para>в 17:45 послать пустое письмо с заголовком 'got the r00t?'на bugs@microsoft.com </para>
        <screen>echo "mail -s 'got the r00t?' bugs@microsoft.com &lt; /dev/null" | at 17:45 </screen>
        <para>напечатать 1234 в соответствии с настройками локали (в России обычно 1.234) </para>
        <screen>printf "%'d\n" 1234 </screen>
        <para>запускать просмотр прерываний каждую секунду </para>
        <screen>watch -n1 "cat /proc/interrupts" </screen>
        <para>посмотреть, сколько времени занимает выполнение команды </para>
        <screen>time command </screen>
        <para>удобный алиас для вывода дампа </para>
        <screen>alias hd='od -Ax -tx1z -v' </screen>
        <para>полный путь к команде command </para>
        <screen>which command </screen>
        <para>вывести в 9 колонок по ширине терминала </para>
        <screen>ls | pr -T9 -W$COLUMNS </screen>
        <para>установить время изменения для файла file (в формате YYMMDDhhmm) </para>
        <screen>touch -c -t 0304050607 file </screen>
        <para>показать иерархию запущенных процессов </para>
        <screen>pstree -p </screen>
        <para>показать процессы, использующие файл /dir/file (чаще всего использую нечто вроде 'lsof /mnt/cdrom'). Не забудьте сделать 'emerge -n lsof' </para>
        <screen>lsof /dir/file</screen>
    </section>
    <section>
        <title>Ввод-вывод</title>
        <para>объединить stderr и stdout (вернее сказать перенаправить stderr в stdout) </para>
        <screen>gcc file.c 2&gt;&amp;1 | less </screen>
        <para>Перенаправить stderr в файл errors.log а stdout в файл compile.log для дальнейшего анализа </para>
        <screen>gcc file.c 2&gt;errors.log 1&gt;compile.log </screen>
        <para>Если нужно запретить вывод потока (например убрать в скрипте сообщения об ошибках) то достаточно перенаправить поток на устройство /dev/null, тогда сообщения уйдут в никуда: </para>
        <screen>rm -r /var/tmp/portage 2&gt;&amp;1 &gt;/dev/null или rm -r /var/tmp/portage &amp;&gt; /dev/null </screen>
        <para>Порой нужно обьединить выходной поток сразу нескольких комманд, а поток одной изних отключить, тогда группу нужно объединить в скобки: </para>
        <screen>( cat /etc/gentoo-release ; cat /etc/passwd &gt;/dev/null; cat /etc/group ) |less </screen>
        <para>Навигация по директориям.</para>
        <para>вернуться в предыдущую директорию (не путать с 'cd ..') </para>
        <screen>cd — </screen>
        <para>вернуться в домашнюю директорию </para>
        <screen>cd</screen>
        <para>перейти в директорию dir, запустить command и автоматически вернуться назад </para>
        <screen>(cd dir; command) </screen>
        <para>добавить текущую директорию в стек, чтобы потом можно было сделать popd и вернуться к ней </para>
        <screen>pushd . </screen>
    </section>
    <section>
        <title>Дисковое пространство</title>
        <para>показать список файлов с информацией о каждом файле (-l), отсортировав список по убыванию размера (-S) и перевернуть список (-r). Получим сортировку по возрастанию. </para>
        <screen>ls -lSr</screen>
        <para>показать, сколько места на диске занимает файл file и директория dir </para>
        <screen>du -sh <replaceable>file</replaceable> <replaceable>dir</replaceable></screen>
        <para>показать свободное место на примонтированных ресурсах </para>
        <screen>df -h</screen>
        <para>то же самое но в инодах </para>
        <screen>df -i</screen>
        <para>показать геометрию размещения разделов жесткого диска (нужны права root) </para>
        <screen>fdisk -l</screen>
    </section>
    <section>
        <title>Работа с CD</title>
        <para>создать iso-образ диска и заархивировать его </para>
        <screen>dd bs=1M if=/dev/cdrom | gzip &gt; cdrom.iso.gz</screen>
        <para>создать iso-образ из директории dir </para>
        <screen>mkisofs -r dir | gzip &gt; cdrom.iso.gz</screen>
        <para>смонтировать cdrom.iso в /mnt/dir (для просмотра и правки) </para>
        <screen>mount -o loop cdrom.iso /mnt/dir</screen>
        <para>записать архивированный образ на диск </para>
        <screen>gzip -dc cdrom.iso.gz | cdrecord dev=0,0,0 —</screen>
        <para>рипнуть дорожки с Audio-CD в текущую директорию (в формате .wav) </para>
        <screen>cdparanoia -B</screen>
        <para>создать Audio-CD из всех .wav файлов в текущей директории </para>
        <screen>cdrecord dev=0,0,0 -audio *.wav</screen>
        <para>конвертировать файл track.cdda.wav формат .ogg </para>
        <screen>oggenc --tracknum="track" track.cdda.wav -o "track.ogg"</screen>
    </section>
    <section>
        <title>Работа с архивами</title>
        <para>создать архив директории dir </para>
        <screen>tar c dir/ | bzip2 &gt; dir.tar.bz2 
tar -cjf dir.tar.bz2 dir </screen>
        <para>извлечь архив в директорию /to/dir (без '-C /to/dir' в текущую директорию) </para>
        <screen>bzip2 -dc dir.tar.bz2 | tar x -С /to/dir
tar -xjf dir.tar.bz2 -C /to/dir</screen>
        <para>создать архив всех .png файлов в директории dir/ </para>
        <screen>find dir/ -name "*.png" | xargs tar rf dir.tar; bzip2 dir.tar </screen>
        <para>скопировать (с сохранением прав доступа!) директорию /dir/to/copy/ в /where/to/ </para>
        <screen>( tar cf — /dir/to/copy ) | ( cd /where/to/ &amp;&amp; tar xf — ) </screen>
        <para>скопировать (с сохранением прав доступа!) содержимое директории /dir/to/copy в /where/to/ </para>
        <screen>( cd /dir/to/copy &amp;&amp; tar cf — . ) | ( cd /where/to/ &amp;&amp; tar xf — ) </screen>
        <para>скопировать (с сохранением прав доступа!) директорию /dir/to/copy/ в директорию /where/to/ на удаленной машине </para>
        <screen>( tar cf — /dir/to/copy ) | gzip | ssh user@remote 'cd /where/to/ &amp;&amp; gzip -dc | tar xf -' </screen>
        <para>создать и сохранить бэкап жесткого диска на удаленной машине </para>
        <screen>dd bs=1M if=/dev/hda | gzip | ssh user@remote 'dd of=hda.gz' </screen>
    </section>
    <section>
        <title>Работа с файлами</title>
        <para>удобный листинг по команде l </para>
        <screen>alias l='ls -l --color=auto' </screen>
        <para>вывести листинг с упорядочиванием по дате </para>
        <screen>ls -lrt </screen>
        <para>показать в папке dir файлы модифицированные раньше, чем 2 дня назад </para>
        <screen>find dir -mtime +2 </screen>
        <para>удаляем в папке dir файлы старше 1 часа </para>
        <screen>find dir -type f -mmin +60 -exec rm -f {} \; </screen>
        <para>удаляем в папке dir файлы старше 10 дней </para>
        <screen>find dir -type f -mtime +10 -exec rm -f {} \; </screen>
        <para>найти в текущей директории (и ниже) .c и .h файлы содержащие строку "search string" </para>
        <screen>find -name "*.[ch]" | xargs grep -E "search string" </screen>
        <para>искать строку "search string" только в обычных файлах </para>
        <screen>find -type f | xargs grep -E "search string" </screen>
        <para>искать строку "search string" только в текущей директории (не спускаться ниже) </para>
        <screen>find -type f -maxdepth 1 | xargs grep -E "search string" </screen>
        <para>в текущей директории найти все файлы с расширением sql содержащие USER1 и заменить в них USER1 на USER2 </para>
        <screen>tmp="/tmp/$RANDOM$$.tmp"; f="USER1"; r="USER2";
find . -name '*.sql' -exec grep -l "$f" {} \; |
xargs --replace="{}" bash -c "( sed 's/$f/$r/g' &lt; {} &gt; $tmp &amp;&amp; cat $tmp &gt; {} &amp;&amp; rm -f $tmp )"  </screen>
        <para>найти файл в базе данных программы slocate. Замечание: данное регулярное выражение эквивалентно маске *file*.txt </para>
        <screen>locate -r 'file[^/]*\.txt'</screen>
    </section>
    <section>
        <title>Работа с файловой системой</title>
        <para>отформатировать флоппи-диск с FAT </para>
        <screen>mkdosfs -c -f 16 -n "название тома" /dev/fd0 или mkfs -t fat16 /dev/fd0 </screen>
        <para>"правильная" кодировка и права файлов для сменных носителей (floppy, CD, flash) </para>
        <para>необходимо прописать в <filename>/etc/fstab</filename>!!! </para>
        <para>для CDROM</para>
        <programlisting>/dev/cdrom /mnt/cdrom iso9660 ro,nosuid,noauto,exec,user,nodev 0 0 </programlisting>
        <para>для "дискетки"</para>
        <programlisting>/dev/fd0 /mnt/floppy vfat iocharset=koi8-r,sync,nosuid,codepage=866,user,--,noauto,nodev,unhide 0 0 </programlisting>
        <para>для раздела Windows</para>
        <programlisting>/dev/hda1 /mnt/win vfat user,exec,umask=0,codepage=866,iocharset=koi8-r 0 0 </programlisting>
        <para>для "флешки"</para>
        <programlisting>/dev/sda1 /mnt/flash vfat user,exec,umask=0,sync,codepage=866,iocharset=koi8-r 0 0 </programlisting>
        <para>вышенаписанное справедливо для локали koi8-r, ваша может отличаться (см. locale), в этом случае все "koi8-r" необходимо исправить на свои, и помните, что это, лишь, пример </para>
    </section>
    <section>
        <title>Работа с календарем</title>
        <para>вывести на экран календарь на текущий, предыдущий и следующий месяцы </para>
        <screen>cal -3 </screen>
        <para>на какой день недели выпал в этом году день рождения Linux? </para>
        <screen>date --date='25 Aug' +%A </screen>
        <para>конвертировать в дату (в соответствии с локалью) — 130204800 секунд, прошедшие с начала эпохи Unix </para>
        <screen>date --date '1970-01-01 UTC 130204800 seconds' </screen>
        <para>Сколько сейчас времени на западном побережьи США (используйте tzselect чтобы узнать параметр для TZ) </para>
        <screen>TZ="America/Los_Angeles" date </screen>
    </section>
    <section>
        <title>Работа с сетью</title>
        <para>(Предварительно сделать <command>emerge</command> на <package>net-tools</package>, <package>sys-apps/iproute2</package>, <package>net-dns/bind-tools</package>)</para>
        <para>показать сетевые интерфейсы </para>
        <screen>ip link show </screen>
        <para>показать статус сетевых интерфейсов </para>
        <screen>ethtool interface или /sbin/ifconfig </screen>
        <para>переименовать eth0 в wan </para>
        <screen>ip link set dev eth0 name wan </screen>
        <para>добавить ip 1.2.3.4 с маской 255.255.255.0 на eth0 </para>
        <screen>ip addr add 1.2.3.4/24 brd + dev eth0 </screen>
        <para>поднять интерфейс </para>
        <screen>ip link set dev interface up </screen>
        <para>опустить интерфейс </para>
        <screen>ip link set dev interface down </screen>
        <para>сделать шлюзом по умолчанию 1.2.3.254 </para>
        <screen>ip route add default via 1.2.3.254 </screen>
        <para>показать ip адрес для name </para>
        <screen>host name </screen>
        <para>показать прослушиваемые порты в системе (и кто их слушает) </para>
        <screen>netstat -lp --inet </screen>
        <para>показать активные соединения </para>
        <screen>netstat -p --inet </screen>
    </section>
    <section>
        <title>Математика</title>
        <para>простое вычисление </para>
        <screen>echo "(321-123)/123" | bc -l </screen>
        <para>простое целочисленное вычисление с использование bash </para>
        <screen>echo "$(( (51+123)/2 ))" </screen>
        <para>использование python для научных вычислений </para>
        <screen>echo "print (10E3-123)/123" | python </screen>
        <para>приведение систем счисления (в данном случае, десятичной к шестнадцатеричной) </para>
        <screen>echo "obase=16;ibase=10;123" | bc </screen>
        <para>Более сложное вычисление — максимальная скорость передачи (в пакетах в секунду) в Fast Ethernet сети (100Mb) </para>
        <screen>echo "framing=20; minsize=64; (100*10^6)/((framing+minsize)*8)" | bc </screen>
        <para>А здесь мы строим график зависимости скорости передачи от размера пакета всё в той же 100-мегабитной сети. </para>
        <screen>echo "framing=20; plot [64:1518] (100*10**6)/((framing+x)*8)" | gnuplot -persist </screen>
    </section>
</article>
