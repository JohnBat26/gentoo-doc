<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbookxi.rng" type="xml"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="portage-basic">
    <info>
        <title>Основы Portage</title>
    </info>
    <para>Одно из фундаментальных отличий Gentoo от других дистрибутивов — его система управления пакетами, названная Portage, ориентированная в первую очередь на установку программ из исходных текстов. Это позволяет иметь множество настроек и точек контроля для одного пакета там, где пользователи бинарных дистрибутивов имеют несколько пакетов с разными опциями и зависимостями (фактически это тоже самое, только управление различными опциями сборки не такое гибкое). С Portage вы можете установить так называемые USE-флаги для настройки опций одного пакета или даже всей системы.</para>
    <para>Например если вы хотите включить поддержку KDE и выключить поддержку GNOME вам нужно добавить к строке USE в файле <filename>/etc/make.conf</filename> флаги "<code>kde -gnome</code>". Для получения более подробной информации о USE-флагах смотрите <link xlink:href="#">Gentoo Handbook</link>.</para>
    <para>Для работы с Portage используется команда <command>emerge</command>. Например для установки пакета moo достаточно набрать команду: <command>emerge moo</command>. Portage проверит зависимости, скачает все необходимые архивы с исходниками, соберёт пакет и установит его. Вся необходимая информация сохранена в базе, состоящей из ebuild'ов, каждый из которых представляет собой специальный скрипт. Все ebuild'ы находятся в папке <filename>/usr/portage</filename>.</para>
    <section>
        <info>
            <title>Управление настройками Portage</title>
        </info>
        <para>Первое правило Gentoo — нужно внимательно следить за флагами USE. Почему при установке Midnight Commander устанавливается X.Org — потому что у вас разрешён флаг X. Почему нет KPDF в KDE? — Потому что KDE был собран без флага <code>pdf</code> (не спрашивайте почему всё же собрался KGhostScript).</para>
        <para>Всегда устанавливайте новые пакеты командной <command>emerge --ask --verbose</command> (или <command>emerge -av</command>) для просмотра USE-флагов перед началом компиляции. Установите пакет gentoolkit (emerge gentoolkit) — среди множества полезных вещей он содержит утилиту euse, которая существенно упрощает управление флагами USE<footnote>
                <para> Также имеется утилита: ufed (установка: <command>emerge ufed</command>) для более дружественного просмотра  USE флагов</para>
            </footnote>. Выполните <command>euse -i flag</command> для получения информации о флаге "flag". Так же просмотрите man-страницу euse (не волнуйтесь. она короткая :-)).</para>
        <para>Если вы хотите изменить USE-флаги только для одного пакета не пытайтесь собирать его командой <command>USE="some flags" emerge moo</command>. Это конечно сработает, но при обновлении системы пакет будет пересобран со старыми флагами. Лучше прописывайте USE-флаги в /etc/portage/package.use, для этого выполните <command>echo "category/moo some flags" &gt;&gt; /etc/portage/package.use</command> перед установкой пакета.</para>
        <para>Тоже относится и к <envar>ACCEPT_KEYWORDS</envar> — используйте <filename>/etc/portage/package.keywords</filename>. В Portage 2.1 вы можете использовать папки <filename>package.use</filename> и <filename>package.keywords</filename> вместо файлов для более простого управления.</para>
    </section>
    <section>
        <info>
            <title>Когда нужно использовать оверлеи?</title>
        </info>
        <para><indexterm><primary>Оверлей</primary></indexterm><indexterm><primary>Overlay</primary></indexterm>Оверлей — набор ebuild'ов, которые вы хотите добавить к официальной базе данных (дереву) Portage</para>
        <para>Иногда возникает необходимость установить пакет, отсутствующий в Portage. Например вы можете захотеть установить пакет, удалённый из дерева Portage. Тогда вам нужно взять его ebuild из архива Portage CVS. Или например вы захотите установить новый пакет, взяв ebuild в bugzilla. Возможна ситуация, когда вы просто захотите немного подправить официальный ebuild.</para>
        <para>В любом случае вам нужно в такой ситуации поместить ваш ebuild в локальный оверлей. Оверлей — набор ebuild'ов, которые вы хотите добавить к официальной базе данных (дереву) Portage. </para>
        <para>Не храните свои ebuild'ы внутри официального дерева (<filename>/usr/portage</filename>), поскольку при обновлении они будут удалены. </para>
        <para>Создайте каталог для оверлея, и создайте в нём структуру подкаталогов, аналогичную <filename>/usr/portage</filename>. Поместите туда ваш ebuild. Добавьте <code>PORTDIR_OVERLAY="/path/to/local/overlay"</code> в ваш файл <filename>/etc/make.conf</filename>.</para>
        <para>Обычное место для оверлеев — <filename>/usr/local/overlays</filename>. Таким образом местом для вашего ebuild'а будет <filename>/usr/local/overlays/local</filename>. Что же ещё может находиться в <filename>/usr/local/overlays</filename>.</para>
        <para>Во многих случаях, когда вы ищите пакеты, не включённые в официальное дерево, вы находите не только ebuild'ы, но и оверлеи. Например один из самых популярных оверлеев xgl-coffee содержит всё, что нужно для работы XGL. Вы можете установить его в <filename>/usr/local/overlays/xgl-coffee</filename> что не смешивать с другими оверлеями и обновлять его через SVN.</para>
        <para>Вы можете найти подробную информацию относительно использования оверлеев на <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://ru.gentoo-wiki.com/">Gentoo Wiki</link>. Там же вы найдёте список неофициальных оверлеев и описание процесса синхронизации с ними.</para>
    </section>
    <section>
        <info>
            <title>Как часто нужно обновляться?</title>
        </info>
        <para>Вам нет смысла обновляться чаще чем раз в сутки. Можно даже реже. Вы можете следить за вашими любимыми пакетами периодически посещая сайты packages.gentoo.org или gentoo-portage.com (или подписавшись на RSS).</para>
        <para>Сохраните мир чистым !</para>
        <para>Каждый раз, когда вы выполняете emerge some-package, имя пакета записываете в файл <filename>/var/lib/portage/world</filename>. Когда вы обновляете систему командой <command>emerge --update --deep world</command> — используется список из этого файла. Поэтому этот файл должен быть по возможности короче. В нём должны быть только необходимые пакеты. </para>
        <para>Если какой-то пакет является всего лишь зависимостью другого — не стоит держать его в файле world.</para>
        <para>Например, если вы устанавливаете пакет, использующий библиотеку wxWidgets, то эта библиотека устанавливается как зависимость и не добавляется в файл world. Если вы деинсталлируете все пакеты использующие эту библиотеку — она перестанет обновляться при выполнении <filename>emerge --update (...) world</filename>, и будет удалены после вызова <filename>emerge --depclean</filename>. Единственный случай когда стоит добавить wxWidgets в world — если вы разрабатываете приложения на основе этой библиотеки.</para>
        <para>Существует скрипт, помогающий очистить world от всего лишнего. Для установки пакета без занесения его в world используйте опцию <option>--oneshot</option>. Эта опция так же будет хорошем решением при временной установке какого-либо пакета.</para>
    </section>
    <section>
        <info>
            <title>Деинсталляция пакетов</title>
        </info>
        <para>Все ваши действия с emerge записываются в файл <filename>/var/log/emerge.log</filename>. Если вы хотите знать какой пакет собирается в настоящее время — выполните <command>tail /var/log/emerge.log</command>. Утилита genlop (<command>emerge genlop</command>) позволяет извлечь множество различной информации из этого файла. Например <command>genlop -c</command> покажет вам какой пакет собирается в данный момент и попытается предсказать сколько времени осталось до конца сборки.</para>
    </section>
    <section>
        <info>
            <title>Удаление временных файлов</title>
        </info>
        <para>Когда сборка пакета завершается с ошибкой — остаётся каталог с временными файлами в <filename>/var/tmp/portage</filename>. Если вы устраняете проблему и пакет нормально собирается — файлы удаляются. Если же нет — вы можете очистить каталог <filename>/var/tmp/portage</filename> вручную.</para>
        <para>После обновления вы можете удалить устаревшие файлы из <filename>/usr/portage/distfiles</filename>. Для этого воспользуйтесь утилитой eclean из пакета gentoolkit. Она поможет удалить ненужные файлы. Эта утилита может работать как с исходниками, так и с бинарными пакетами. (просто вызовите её как eclean-dist или eclean-pkg соответственно). Прочитайте страницу man для получения полного списка опций.</para>
        <para>Gentoo предоставляет вам огромные возможности по настройке вашей системы. Автор статьи надеется что после прочтения этих строк вы сможете воспользоваться этими возможностями и испытать чувство глубокого удовлетворение от возможности управления любыми аспектами системы. Вам понравиться это ощущение.</para>
    </section>
</article>
