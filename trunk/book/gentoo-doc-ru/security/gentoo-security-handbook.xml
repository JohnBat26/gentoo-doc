<?xml version="1.0" encoding="UTF-8"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="gentoo-security-handbook">
    <info>
        <title>Настольная книга по безопасности Gentoo</title>
    </info>
    <para/>
    <para>Ссылка на оригинал: <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/doc/ru/security/">http://www.gentoo.org/doc/ru/security/</link>
    </para>
    <para>C версии: 1.3</para>
    <section>
        <info>
            <title>Введение</title>
        </info>
        <para>Эта настольная книга предназначена для людей, использующих Gentoo Linux в качестве сервера или чувствующих, что они нуждаются в повышении безопасности системы. </para>
        <para>Если после прочтения этой книги вы заинтересуетесь дальнейшим усилением защищенности системы Gentoo, то обратите внимание на проект укрепленной системы Gentoo — <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/proj/en/hardened/">Hardened Gentoo Project </link>(англ.).</para>
        <para/>
    </section>
    <section>
        <info>
            <title>Безопасность системы</title>
        </info>
        <section>
            <info>
                <title>Соображения перед началом установки</title>
            </info>
            <section>
                <info>
                    <title>Физическая безопасность</title>
                </info>
                <para>Сколько преград не установи, злоумышленник, имея физический доступ к компьютеру, сможет легко их обойти. Несмотря на это, кое-какие меры для относительной защиты от злоумышленника с физическим доступом к вашей машине принять можно. Поместив оборудование в кладовку под замок, вы помешаете злоумышленнику попросту отключить его и унести с собой. Стоит запереть корпус компьютера на замок, чтобы не дать злоумышленнику просто вынуть из него жесткий диск. Чтобы предотвратить загрузку с альтернативного диска, благодаря чему можно просто обойти порядок входа в систему и права доступа, попробуйте установить в BIOS жесткий диск в качестве первого загрузочного устройства и запаролить BIOS. Также важно установить пароль для загрузчика LILO или GRUB, чтобы не дать недобросовестному пользователю загрузить систему в однопользовательском режиме, получив к ней полный доступ. Это подробно описано в третьей главе, в разделах <link xmlns:xlink="http://www.w3.org/1999/xlink"
                        xlink:href="#">защита GRUB паролем</link> и <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#">защита LILO паролем</link>. </para>
            </section>
            <section>
                <info>
                    <title>Планирование демонов/служб</title>
                </info>
                <para>Для начала выпишите службы, которые должны работать на машине. Это поможет вам выбрать наилучшую схему разбивки разделов в системе и позволит лучше спланировать меры безопасности. Конечно же, в этом нет необходимости, если ваш компьютер служит для одной определенной задачи, например в качестве рабочей станции или выделенного межсетевого экрана. В таких случаях не должны запускаться никакие службы, за исключением, возможно, sshd. </para>
                <para>Составленный список также может пригодиться для администрирования системы. Вы увидите, что, поддерживая перечень текущих версий, значительно легче удерживать все в актуальном состоянии, когда в каких-либо из ваших демонов обнаруживаются уязвимости к удаленному доступу.</para>
            </section>
            <section>
                <info>
                    <title>Схемы создания разделов</title>
                </info>
                <para>Правила разбиения разделов: </para>
                <itemizedlist>
                    <listitem>
                        <para>любое дерево каталогов, в которое пользователь должен иметь возможность записи (например, <filename>/home</filename>, <filename>/tmp</filename>), должно размещаться в отдельном разделе с использованием дисковых квот. Это снижает риск переполнения всей файловой системы каким-либо пользователем. Portage использует <filename>/var/tmp</filename> для компиляции, поэтому этот раздел должен быть большим </para>
                    </listitem>
                    <listitem>
                        <para>любое дерево каталогов, в которое вы планируете устанавливать программное обеспечение не средствами управления пакетами дистрибутива, следует размещать в отдельном разделе. Согласно <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.pathname.com/fhs/">стандарту иерархии файлов</link> (англ.), это <filename>/opt</filename> или <filename>/usr/local</filename>. Являясь отдельными разделами, они не удаляются при переустановке системы </para>
                    </listitem>
                    <listitem>
                        <para>для лишней защиты можно поместить статические данные в отдельный раздел, монтируемый только для чтения. Если вы настоящий параноик, можете пользоваться неперезаписываемым носителем, например, компакт-диском </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <info>
                    <title>Пользователь root</title>
                </info>
                <para>Администратор системы (пользователь root) является наиболее важным пользователем, и его права не следует использовать без крайней необходимости. Если злоумышленник получит доступ с правами администратора, единственным способом восстановить доверие к системе будет переустановить ее. </para>
                <para>Золотые правила для root </para>
                <itemizedlist>
                    <listitem>
                        <para>всегда создавайте пользователя для каждодневных работ, а если этому пользователю понадобятся права администратора, добавьте его в группу «wheel». Это дает возможность обычным пользователям выполнять команды с правами администратора с помощью <command>su</command></para>
                    </listitem>
                    <listitem>
                        <para>никогда не запускайте X или другое пользовательское приложение под root. Права администратора следует использовать только при крайней необходимости: если уязвимость есть в приложении, запущенном от имени пользователя, злоумышленник может получить права этого пользователя. А если приложение запущено с правами администратора, то злоумышленник получит их. </para>
                    </listitem>
                    <listitem>
                        <para>войдя под учетной записью администратора, всегда указывайте абсолютные пути (или всегда используйте команду <command>su -</command>, которая заменяет переменные среды пользователя на администраторские, обеспечивая наличие в PATH администратора только защищенных каталогов, например <filename>/bin</filename> и <filename>/sbin</filename>). Иначе можно обмануть администратора и заставить его выполнить совершенно другое приложение. Если PATH администратора защищен или он использует только абсолютные пути, то можно быть уверенным, что это не произойдет </para>
                    </listitem>
                    <listitem>
                        <para>если пользователю нужно выполнять лишь несколько команд с правами администратора, то вместо использования учетной записи root, рекомендуется использовать команду <command>sudo</command>. Просто также задумывайтесь, кому вы даете доступ к этой команде! </para>
                    </listitem>
                    <listitem>
                        <para>никогда не оставляйте без присмотра терминал, в котором вы зарегистрированы в качестве root </para>
                    </listitem>
                </itemizedlist>
                <para>В Gentoo по умолчанию есть некоторая защита от обычных пользователей, пытающихся с помощью su получить права администратора. По умолчанию настройки PAM требуют, чтобы пользователь был членом группы «wheel» для того, чтобы запускать команду su. </para>
            </section>
            <section>
                <info>
                    <title>Правила безопасности</title>
                </info>
                <para>Есть ряд причин набросать правила безопасности для своей системы или сети. </para>
                <itemizedlist>
                    <listitem>
                        <para>хорошие правила безопасности позволяют вам наметить подход к безопасности <emphasis role="italic">системно</emphasis>, а не сваливать в кучу разрозненные меры. Например, без правил администратор может решить отключить telnet, так как в нем пароли передаются не зашифрованными, оставив доступ по FTP, обладающему таким же недостатком. Хорошие правила безопасности позволяют выявить, какие меры безопасности имеют смысл, а какие — нет </para>
                    </listitem>
                    <listitem>
                        <para>чтобы выявлять проблемы, проводить аудит или выслеживать злоумышленников, может потребоваться перехват данных, передаваемых по сети, проверка истории входа пользователей и выполнявшихся ими команд, а также просмотр их домашних каталогов. Без указания об этом в документации и явного предупреждения пользователей такие действия могут оказаться незаконными и привести к привлечению вас к ответственности по закону </para>
                    </listitem>
                    <listitem>
                        <para>похищенные учетные записи пользователей являются одной из самых распространенных угроз безопасности системы. Не объясняя пользователям, почему безопасность важна, и как ее поддерживать (например, не записывать пароли на клочках бумаги на рабочем месте), можно и не надеяться на защищенность пользовательских данных </para>
                    </listitem>
                    <listitem>
                        <para>хорошо задокументированная схема сети и системы поможет как вам, так и, при необходимости, суду и следствию, отслеживать проникновение злоумышленника и выявлять слабые места по факту взлома. Уведомление правил безопасности о том, что ваша система является частной сетью и несанкционированный доступ запрещен, также способствует надлежащему преследованию нарушителя по закону после его поимки </para>
                    </listitem>
                </itemizedlist>
                <para>Надеемся, что теперь необходимость в хороших правилах безопасности более чем ясна. </para>
                <para>Сами по себе правила — это документ или набор документов, раскрывающих функции сети или системы (например, какие именно услуги предоставляются), допустимые и запрещенные действия, применение «передового опыта» обеспечения безопасности, и т. д. Все пользователи должны быть знакомы как с правилами безопасности, так и с изменениями, которые вы вносите для поддержания их актуальности. Важно уделять время, чтобы добиваться понимания правил пользователями, объяснять, зачем знакомится под роспись, и что будет, если пользователь явно нарушит их требования (в правилах безопасности об этом должно быть ясно указано). Необходимо повторять ознакомление по крайней мере раз в год, так как правила подвержены изменениям (а также для напоминания пользователям). </para>
                <note>
                    <para>Создавайте правила, понятные для чтения и не допускающие разночтений в любой ситуации. </para>
                </note>
                <para>Правила безопасности должны охватывать по крайней мере следующие темы: </para>
                <itemizedlist>
                    <listitem>
                        <para>допустимые действия</para>
                        <itemizedlist>
                            <listitem>
                                <para>экранные заставки</para>
                            </listitem>
                            <listitem>
                                <para>обращение с паролями</para>
                            </listitem>
                            <listitem>
                                <para>скачивание и установка программ</para>
                            </listitem>
                            <listitem>
                                <para>предупреждение, если действия пользователей отслеживаются</para>
                            </listitem>
                            <listitem>
                                <para>использование антивирусных программ</para>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                    <listitem>
                        <para>обращение с ценными сведениями (в любом письменном виде, на электронном или бумажном носителе)</para>
                        <itemizedlist>
                            <listitem>
                                <para>чистый рабочий стол и хранение сведений ДСП под замком</para>
                            </listitem>
                            <listitem>
                                <para>отключение компьютера перед уходом</para>
                            </listitem>
                            <listitem>
                                <para>использование средств шифрования</para>
                            </listitem>
                            <listitem>
                                <para>передача ключей доверенным сотрудникам</para>
                            </listitem>
                            <listitem>
                                <para>обращение с конфиденциальными данными в поездках</para>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                    <listitem>
                        <para>обращение с компьютерным оборудованием в поездках</para>
                        <itemizedlist>
                            <listitem>
                                <para>обращение с ноутбуком в поездках и в гостиницах</para>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                </itemizedlist>
                <para>Для разных пользователей могут требоваться разные типы или уровни доступа, и содержание ваших правил может отличаться, чтобы охватить их все. </para>
                <para>В распухших правилах безопасности легко упустить важные моменты. В правилах для ИТ-персонала могут содержаться сведения, закрытые для обычных пользователей. Поэтому есть смысл разделить их на несколько небольших разделов, например, «допустимые действия», «использование паролей», «правила использования электронной почты», «правила удаленного доступа». </para>
                <para>Примеры правил безопасности приведены на сайте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.sans.org/resources/policies/">проекта правил безопасности SANS</link> (англ.). Если у вас небольшая сеть, и вы считаете, что эти примеры слишком велики, можете обратиться к <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ftp://ftp.isi.edu/in-notes/rfc2196.txt">руководству по объектовой безопасности (Site Security Handbook)</link> (англ.). </para>
            </section>
        </section>
        <section>
            <info>
                <title>Закручивание гаек</title>
            </info>
            <section>
                <info>
                    <title>USE-флаги</title>
                </info>
                <para>В Gentoo Linux файл make.conf содержит USE-флаги, определенные пользователем, а <filename>/etc/make.profile/make.defaults</filename> — USE-флаги по умолчанию. Для данного руководства важны флаги pam (Pluggable Authentication Modules — подключаемые модули опознания), tcpd (Упаковщики TCP) и ssl (Secure Socket Layer). Все они включены в USE-флаги по умолчанию. </para>
            </section>
            <section>
                <info>
                    <title>Защита GRUB паролем</title>
                </info>
                <para>В GRUB можно защитить загрузчик паролем двумя различными способами. В первом используется открытый пароль, а во втором — шифрование с использованием md5+salt. </para>
                <example>
                    <title>/boot/grub/grub.conf</title>
                    <programlisting>timeout 5
password changeme</programlisting>
                </example>
                <para>Благодаря этим строкам был добавлен пароль changeme. Если во время загрузки не ввести пароль, то GRUB просто загружает вариант по умолчанию. </para>
                <para>При добавлении пароля MD5 вы должны преобразовать открытый пароль в зашифрованный в том же формате, что и в файле /etc/shadow. За дополнительными сведениями обращайтесь к man crypt. Зашифрованный пароль, например changeme, может выглядеть вот так: <code>$1$T7/dgdIJ$dJM.n2wZ8RG.oEiIOwJUs</code>. </para>
                <para>Зашифровать пароль можно прямо в оболочке GRUB: </para>
                <para>
                    <example>
                        <title>md5crypt в оболочке grub</title>
                        <screen><prompt>#</prompt> <userinput>/sbin/grub</userinput>

GRUB version 0.92 (640K lower / 3072K upper memory)

   [ Minimal BASH-like line editing is supported. For the first word, TAB lists
     possible command completions. Anywhere else TAB lists the possible
     completions of a device/filename. ]

<prompt>grub></prompt> <userinput>md5crypt</userinput>

Password: <userinput>********</userinput>
<lineannotation>(было набрано слово changeme)</lineannotation>
Encrypted: $1$T7/dgdIJ$dJM.n2wZ8RG.oEiIOwJUs.

<prompt>grub></prompt> <userinput>quit</userinput></screen>
                    </example>
                </para>
                <para>Затем скопируйте полученный пароль в <filename>/boot/grub/grub.conf</filename>.</para>
                <example>
                    <title>/boot/grub/grub.conf</title>
                    <programlisting>timeout 5
password --md5 $1$T7/dgdIJ$dJM.n2wZ8RG.oEiIOwJUs</programlisting>
                </example>
                <para>Задержка в 5 секунд пригодится в случае, когда система физически недоступна, и нужна возможность перезагрузки без использования клавиатуры. Более подробно о паролях в GRUB вы можете узнать, набрав <command>info grub</command>. </para>
            </section>
            <section>
                <info>
                    <title>Защита LILO паролем</title>
                </info>
                <para>В LILO также поддерживается два способа защиты с помощью пароля: общий и для отдельного образа, в обоих случаях пароль хранится в открытом виде. </para>
                <para>Общий пароль устанавливается в начале файла конфигурации и относится к каждому загрузочному образу: </para>
                <example>
                    <title>/etc/lilo.conf</title>
                    <programlisting>password=changeme
restricted
delay=3</programlisting>
                </example>
                <para>Пароль для отдельного образа устанавливается следующим образом: </para>
                <example>
                    <title>/etc/lilo.conf</title>
                    <programlisting>image=/boot/bzImage
      read-only
      password=changeme
      restricted</programlisting>
                </example>
                <para>Если параметр restricted не введен, то пароль будет запрашиваться при каждой загрузке. </para>
                <para>Чтобы сохранить новые сведения в файле <filename>lilo.conf</filename>, нужно запустить <command>/sbin/lilo</command>. </para>
            </section>
            <section>
                <info>
                    <title>Ограничение доступа к консоли</title>
                </info>
                <para>С помощью файла <filename>/etc/securetty</filename> можно указать, с каких терминальных устройств (tty) можно входить в систему администратору. </para>
                <para>Рекомендуется закомментировать все строки, кроме vc/1 (если у вас devfs), или кроме tty1 (если у вас udev). Благодаря этому суперпользователь сможет входить в систему одновременно только один раз и только с одного терминала. </para>
                <note>
                    <para>Пользователи, входящие в группу «wheel» по-прежнему смогут воспользоваться <command>su -</command>, чтобы стать администратором, работая с других терминалов. </para>
                </note>
                <example>
                    <title>/etc/securetty</title>
                    <programlisting><lineannotation>(для devfs)</lineannotation>
vc/1
<lineannotation>(для udev)</lineannotation>
tty1</programlisting>
                </example>
            </section>
        </section>
        <section>
            <info>
                <title>Журналирование</title>
            </info>
            <section>
                <info>
                    <title>Введение</title>
                </info>
                <para>Для перехвата предупреждений и ошибок, которые могут свидетельствовать о происходящей атаке или успешном взломе, следует подключать дополнительное журналирование. Часто злоумышленники сканируют систему и «проверяют ее на зуб» перед атакой. </para>
                <para>Также немаловажно, чтобы файлы журналов были легко читаемыми и обозримыми. В Gentoo Linux при установке на выбор предлагается 3 разных средства журналирования. </para>
            </section>
            <section>
                <info>
                    <title>Журналирование: Syslogd</title>
                </info>
                <para>Syslogd является самым распространенным средством журналирования для Linux и Unix. Он способен делать ротацию журналов, однако использование <command>/usr/sbin/logrotate</command> с вызовом по расписанию (logrotate настраивается с помощью файла <filename>/etc/logrotate.conf</filename>) может оказаться полезней, так как у logrotate есть много дополнительных возможностей. Частота ротации подбирается в зависимости от загрузки системы. </para>
                <para>Ниже приведен стандартный файл <filename>syslog.conf</filename> с некоторыми добавлениями. Мы раскомментировали строки cron и tty, и добавили удаленный сервер журналирования. Для дальнейшего усиления журналирования можно настроить ведение журнала в двух местах. </para>
                <example>
                    <title><filename>/etc/syslog.conf</filename></title>
                    <programlisting>#  /etc/syslog.conf     Файл настройки syslogd.
#
#                       За дополнительной информацией обращайтесь к
#                       странице справки syslog.conf(5).
#                       Взято из Debian, пока пользуемся им
#                       Daniel Robbins, 5/15/99

#
# Сначала стандартные файлы журналов.  Журналирование по подсистемам.
#

auth,authpriv.*                 /var/log/auth.log
*.*;auth,authpriv.none          -/var/log/syslog
cron.*                         /var/log/cron.log
daemon.*                        -/var/log/daemon.log
kern.*                          -/var/log/kern.log
lpr.*                           -/var/log/lpr.log
mail.*                          /var/log/mail.log
user.*                          -/var/log/user.log
uucp.*                          -/var/log/uucp.log
local6.debug                    /var/log/imapd.log

#
# Журналирование почтовой системы. Разбито на части, чтобы
# легко писать сценарии для разбора этих файлов.
#
mail.info                       -/var/log/mail.info
mail.warn                       -/var/log/mail.warn
mail.err                        /var/log/mail.err

# Журналирование новостной системы INN
#
news.crit                       /var/log/news/news.crit
news.err                        /var/log/news/news.err
news.notice                     -/var/log/news/news.notice

#
# Журналы, куда может попадать "все подряд".
#
*.=debug;\
        auth,authpriv.none;\
        news.none;mail.none     -/var/log/debug
*.=info;*.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        mail,news.none          -/var/log/messages

#
# Предупреждения и чрезвычайные сообщения, посылаемые всем вошедшим.
#
*.emerg                         *
*.=alert                        *

#
# Мне нравится вывод сообщений на консоль, но только на ту виртуальную
# консоль, что я обычно оставляю простаивать.
#
daemon,mail.*;\
       news.=crit;news.=err;news.=notice;\
       *.=debug;*.=info;\
       *.=notice;*.=warn       /dev/tty8

# Настройка сервера удаленного журналирования
*.*                        @logserver

# Именованный канал /dev/xconsole - для утилиты `xconsole'. Чтобы использовать,
# следует запускать `xconsole' с параметром `-file':
#
#    $ xconsole -file /dev/xconsole [...]
#
# ПРИМЕЧАНИЕ: измените список, данный ниже, или вы с ума сойдете, если
#      у вас осносительно загруженная площадка..
#
#daemon.*,mail.*;\
#       news.crit;news.err;news.notice;\
#       *.=debug;*.=info;\
#       *.=notice;*.=warn       |/dev/xconsole

local2.*                --/var/log/ppp.log</programlisting>
                </example>
                <para>Злоумышленники, скорее всего, будут стараться уничтожать следы своего пребывания, исправляя или удаляя файлы журналов. Можно затруднить им работу, ведя журналирование на одном или нескольких удаленных серверах журнала, расположенных на других компьютерах. Узнать больше о syslogd можно, запустив man syslog.</para>
            </section>
            <section>
                <info>
                    <title>Metalog</title>
                </info>
                <para>
                    <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://metalog.sourceforge.net/">Metalog</link>, написанный Frank Dennis, не может отправлять журнал на удаленный сервер, но дает преимущество, когда речь о скорости и гибкости журналирования. Он может вести журналы по названию программы, срочности, подсистеме (как и syslogd), и комплектуется разборщиком регулярных выражений, с помощью которых можно запускать внешние сценарии при обнаружении заданных шаблонов. При необходимости это может оказаться очень полезным. </para>
                <para>Стандартной настройки обычно достаточно. Если необходимо, чтобы вам отправлялось письмо при любом неверно введенном пароле, используйте один из следующих сценариев. </para>
                <para>Для postfix: </para>
                <example>
                    <title><filename>/usr/local/sbin/mail_pwd_failures.sh</filename> для postfix</title>
                    <programlisting>#! /bin/sh
echo "$3" | mail -s "Warning (program : $2)" root</programlisting>
                </example>
                <para>Для netqmail: </para>
                <example>
                    <title><filename>/usr/local/sbin/mail_pwd_failures.sh</filename> for netqmail</title>
                    <programlisting>#!/bin/sh
echo "To: root
Subject:Failure (Warning: $2)
$3
" | /var/qmail/bin/qmail-inject -f root</programlisting>
                </example>
                <para>Не забудьте сделать сценарий исполняемым командой <command>/bin/chmod +x /usr/local/sbin/mail_pwd_failures.sh</command>. </para>
                <para>Затем в файле <filename>/etc/metalog/metalog.conf</filename> раскомментируйте строку под <code>«Password failures»</code>: </para>
                <example>
                    <title><filename>/etc/metalog/metalog.conf</filename></title>
                    <programlisting>command  = "/usr/local/sbin/mail_pwd_failures.sh"</programlisting>
                </example>
            </section>
            <section>
                <info>
                    <title>Syslog-ng</title>
                </info>
                <para>Syslog-ng, за некоторыми отличиями, обладает теми же возможностями, что и syslog и metalog. Он может фильтровать сообщения по уровню и содержимому (как metalog), вести удаленное журналирование, как syslog, обрабатывать журналы, получаемые от syslogd (даже потоки от Solaris), записывать в TTY, запускать программы, и служить сервером журналирования. То есть, он сочетает лучшие черты обоих средств журналирования с возможностью расширенной настройки. </para>
                <para>Ниже приведен слегка подправленный классический конфигурационный файл. </para>
                <example>
                    <title>/etc/syslog-ng/syslog-ng.conf</title>
                    <programlisting>options { chain_hostnames(off); sync(0); };

#источник, откуда читать журнал
source src { unix-stream("/dev/log"); internal(); };
source kernsrc { file("/proc/kmsg"); };

#получатели
destination authlog { file("/var/log/auth.log"); };
destination syslog { file("/var/log/syslog"); };
destination cron { file("/var/log/cron.log"); };
destination daemon { file("/var/log/daemon.log"); };
destination kern { file("/var/log/kern.log"); };
destination lpr { file("/var/log/lpr.log"); };
destination user { file("/var/log/user.log"); };
destination mail { file("/var/log/mail.log"); };

destination mailinfo { file("/var/log/mail.info"); };
destination mailwarn { file("/var/log/mail.warn"); };
destination mailerr { file("/var/log/mail.err"); };

destination newscrit { file("/var/log/news/news.crit"); };
destination newserr { file("/var/log/news/news.err"); };
destination newsnotice { file("/var/log/news/news.notice"); };

destination debug { file("/var/log/debug"); };
destination messages { file("/var/log/messages"); };
destination console { usertty("root"); };
destination console_all { file("/dev/tty12"); };
destination xconsole { pipe("/dev/xconsole"); };

#создание фильтров
filter f_authpriv { facility(auth, authpriv); };
filter f_syslog { not facility(authpriv, mail); };
filter f_cron { facility(cron); };
filter f_daemon { facility(daemon); };
filter f_kern { facility(kern); };
filter f_lpr { facility(lpr); };
filter f_mail { facility(mail); };
filter f_user { facility(user); };
filter f_debug { not facility(auth, authpriv, news, mail); };
filter f_messages { level(info..warn)
        and not facility(auth, authpriv, mail, news); };
filter f_emergency { level(emerg); };

filter f_info { level(info); };
filter f_notice { level(notice); };
filter f_warn { level(warn); };
filter f_crit { level(crit); };
filter f_err { level(err); };
filter f_failed { match("failed"); };
filter f_denied { match("denied"); };

#связывание фильтров с получателями
log { source(src); filter(f_authpriv); destination(authlog); };
log { source(src); filter(f_syslog); destination(syslog); };
log { source(src); filter(f_cron); destination(cron); };
log { source(src); filter(f_daemon); destination(daemon); };
log { source(kernsrc); filter(f_kern); destination(kern); };
log { source(src); filter(f_lpr); destination(lpr); };
log { source(src); filter(f_mail); destination(mail); };
log { source(src); filter(f_user); destination(user); };
log { source(src); filter(f_mail); filter(f_info); destination(mailinfo); };
log { source(src); filter(f_mail); filter(f_warn); destination(mailwarn); };
log { source(src); filter(f_mail); filter(f_err); destination(mailerr); };

log { source(src); filter(f_debug); destination(debug); };
log { source(src); filter(f_messages); destination(messages); };
log { source(src); filter(f_emergency); destination(console); };

#журнал по умолчанию
log { source(src); destination(console_all); };</programlisting>
                </example>
                <para>Syslog-ng очень легко настраивается, но с той же легкостью можно что-либо упустить в файле настройки, так как он очень велик. Автор также обещает дополнительные возможности, например, шифрование, опознание, сжатие и обязательную проверку прав доступа (MAC — mandatory access control). С такими возможностями программа станет незаменимой для журналирования в сети, так как злоумышленник не сможет перехватывать журнал. </para>
                <para>К тому же у syslog-ng есть еще одно достоинство: он не требует прав администратора для запуска! </para>
            </section>
            <section>
                <info>
                    <title>Анализ журналов с помощью Logcheck</title>
                </info>
                <para>Конечно же, ведение журналов — это только полдела. Приложение наподобие Logcheck может значительно облегчить регулярный анализ журналов. Logcheck — это сценарий, который вместе с двоичным файлом logtail, запускается службой cron и сверяет журналы с заданными правилами на предмет подозрительной деятельности. При совпадении он отправляет электронное письмо с соответствующими записями на почтовый ящик администратора. </para>
                <para>Logcheck и logtail входят в состав пакета app-admin/logsentry. </para>
                <para>Logcheck использует четыре файла для выделения важных событий из обычных сообщений. Этими файлами являются logcheck.hacking, содержащий известные сообщения, встречающиеся при взломе, logcheck.violations, содержащий шаблоны, сигнализирующие о нарушениях безопасности, logcheck.violations.ignore, содержащий ключевые слова, совпадающие с шаблонами в файле нарушений, но которые можно игнорировать, и logcheck.ignore, содержащий записи, которые можно игнорировать. </para>
                <warning>
                    <para>Не оставляйте logcheck.violations.ignore пустым. Для обработки журналов Logcheck использует grep, некоторые версии которого считают пустой файл знаком подстановки (wildcard). В таком случае все нарушения будут игнорироваться. </para>
                </warning>
            </section>
        </section>
        <section>
            <info>
                <title>Монтирование разделов</title>
            </info>
            <section>
                <info>
                    <title>Монтирование разделов</title>
                </info>
                <para>При монтировании разделов с файловой системой ext2, ext3 или reiserfs можно указать различные параметры в файле <filename>/etc/fstab</filename>. Среди них: </para>
                <orderedlist>
                    <listitem>
                        <para>nosuid — игнорировать установленный для файла бит SUID, уподобляя его обычному файлу </para>
                    </listitem>
                    <listitem>
                        <para>noexec — предотвращать запуск файлов с данного раздела </para>
                    </listitem>
                    <listitem>
                        <para>nodev — игнорировать файлы устройств </para>
                    </listitem>
                </orderedlist>
                <para>К сожалению, эти настройки можно легко обойти, задействовав косвенные пути. Тем не менее, установкой noexec для /tmp можно воспрепятствовать использованию большинства вредоносных программ, разработанных для запуска напрямую из каталога <filename>/tmp</filename>. </para>
                <example>
                    <title><filename>/etc/fstab</filename></title>
                    <programlisting>/dev/sda1 /boot ext2 noauto,noatime 1 1
/dev/sda2 none swap sw 0 0
/dev/sda3 / reiserfs notail,noatime 0 0
/dev/sda4 /tmp reiserfs notail,noatime,nodev,nosuid,noexec 0 0
/dev/sda5 /var reiserfs notail,noatime,nodev 0 0
/dev/sda6 /home reiserfs notail,noatime,nodev,nosuid 0 0
/dev/sda7 /usr reiserfs notail,noatime,nodev,ro 0 0
/dev/cdroms/cdrom0 /mnt/cdrom iso9660 noauto,ro 0 0
proc /proc proc defaults 0 0</programlisting>
                </example>
                <warning>
                    <para>Установка <filename>/tmp</filename> в режим noexec может помешать нормальной работе различных сценариев. </para>
                </warning>
                <note>
                    <para>За сведениями о дисковых квотах обращайтесь к разделу <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#">квоты</link>. </para>
                </note>
                <note>
                    <para>Я не устанавливаю для <filename>/var</filename> параметры noexec или nosuid, даже если обычно файлы никогда не запускаются из этого каталога, так как netqmail устанавливается в <filename>/var/qmail</filename> и требует разрешения на исполнение и доступ к одному файлу с SUID. Я устанавливаю <filename>/usr</filename> в режим только для чтения, так как я никогда ничего не записываю туда, кроме случая обновления Gentoo. Тогда я перемонтирую файловую систему в режиме чтения-записи, обновляю систему и перемонтирую обратно в режиме только для чтения. </para>
                </note>
                <note>
                    <para>Даже если вы не используете netqmail, Gentoo все же нужен установленный бит исполнения для <filename>/var/tmp</filename>, так поскольку сборка ebuild выполняется именно здесь. Но если у вас есть насущная необходимость монтировать каталог /var с параметром noexec, можно указать для этого альтернативный путь. </para>
                </note>
            </section>
        </section>
        <section>
            <info>
                <title>Ограничения пользователей/групп</title>
            </info>
            <section>
                <info>
                    <title>/etc/security/limits.conf</title>
                </info>
                <para>Контроль использования ресурсов может быть очень эффективным при попытке предотвращения локальной атаки на отказ от обслуживания или ограничения максимального количества входов в систему для группы или пользователя. Однако излишне строгие настройки будут затормаживать работу вашей системы и станут причиной сбоев программ, поэтому проверьте каждый из параметров. </para>
                <example>
                    <title><filename>/etc/security/limits.conf</filename></title>
                    <programlisting>*    soft core 0
*    hard core 0
*    hard nproc 15
*    hard rss 10000
*    -    maxlogins 2
@dev hard core 100000
@dev soft nproc 20
@dev hard nproc 35
@dev -    maxlogins 10</programlisting>
                </example>
                <para>Если вы пытаетесь установить nproc или maxlogins в 0, то подумайте, может, лучше вместо этого удалить пользователя. В примере выше установлены настройки группы dev для процессов, основных файлов и maxlogins. Все остальное установлено в значения по умолчанию. </para>
                <note>
                    <para><filename>/etc/security/limits.conf</filename> является частью пакета PAM и применима только для пакетов, использующих PAM. </para>
                </note>
            </section>
            <section>
                <info>
                    <title>/etc/limits</title>
                </info>
                <para><filename>/etc/limits</filename> очень схож с файлом ограничений <filename>/etc/security/limits.conf</filename>. Единственное отличие — формат, который применим лишь для пользователей или заполнителей (но не для групп). Вот пример конфигурации: </para>
                <example>
                    <title><filename>/etc/limits</filename></title>
                    <programlisting>*   L2 C0 U15 R10000
kn L10 C100000 U35</programlisting>
                </example>
                <para>Здесь устанавливаются настройки по умолчанию и специфичные настройки для пользователя kn. limits являются частью пакета sys-apps/shadow. Если вы включили pam в make.conf, то нет необходимости устанавливать какие-либо ограничения в этом файле. </para>
            </section>
            <section>
                <info>
                    <title>Квоты</title>
                </info>
                <warning>
                    <para>Проверьте, что рабочая файловая система поддерживает квоты. Чтобы задействовать квоты для ReiserFS, необходимо наложить заплатку на ядро,которая доступна на сайте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ftp://ftp.namesys.com/pub/reiserfs-for-2.4/testing/quota-2.4.20">Namesys</link>. Пользовательские утилиты можно загрузить с сайта проекта <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.sf.net/projects/linuxquota/">Linux DiskQuota project</link>. При совместной работе квот с ReiserFS вы можете встретить проблемы. Мы вас предупредили! </para>
                </warning>
                <para>Установка квот на файловые разделы ограничивает использование дискового пространства для каждого пользователя или каждой группы. Квоты должны быть включены в ядре и добавлены к точке монтирования в <filename>/etc/fstab</filename>. Параметр ядра включается в конфигурации ядра в разделе File systems-&gt;Quota support. Установите следующие настройки, пересоберите ядро и перезагрузитесь в систему с новым ядром. </para>
                <para>Начните с установки квот, запустив <command>emerge quota</command>. Затем измените <filename>/etc/fstab</filename> и добавьте usrquota и grpquota к разделам, использование которых вы хотите ограничить, так, как показано в примере ниже. </para>
                <example>
                    <title><filename>/etc/fstab</filename></title>
                    <programlisting>/dev/sda1 /boot ext2 noauto,noatime 1 1
/dev/sda2 none swap sw 0 0
/dev/sda3 / reiserfs notail,noatime 0 0
/dev/sda4 /tmp ext3 noatime,nodev,nosuid,noexec,usrquota,grpquota 0 0
/dev/sda5 /var ext3 noatime,nodev,usrquota,grpquota 0 0
/dev/sda6 /home ext3 noatime,nodev,nosuid,usrquota,grpquota 0 0
/dev/sda7 /usr reiserfs notail,noatime,nodev,ro 0 0
/dev/cdroms/cdrom0 /mnt/cdrom iso9660 noauto,ro 0 0
proc /proc proc defaults 0 0</programlisting>
                </example>
                <para>Создайте для каждого раздела, для которого включены квоты, файлы квот (<filename>aquota.user</filename> и <filename>aquota.group</filename>) и поместите их в корень каждого из разделов. </para>
                <example>
                    <title>Создание файлов квот</title>
                    <screen><prompt>#</prompt> <userinput>touch /tmp/aquota.user</userinput>
<prompt>#</prompt> <userinput>touch /tmp/aquota.group</userinput>
<prompt>#</prompt> <userinput>chmod 600 /tmp/aquota.user</userinput>
<prompt>#</prompt> <userinput>chmod 600 /tmp/aquota.group</userinput></screen>
                </example>
                <para>Это шаг выполняется для любого раздела, для которого включены квоты. После добавления и настройки файлов квот вам понадобится добавить сценарий запуска quota в загрузочный уровень запуска. </para>
                <important>
                    <para>XFS проверяет все квоты самостоятельно, поэтому для нее не требуется добавления сценария quota в начальный уровень загрузки. Есть ряд файловых систем, не указанных в этом документе, которые функционируют также, поэтому обратитесь к странице руководства вашей файловой системы, для того, чтобы узнать, как она обрабатывает проверки квот. </para>
                </important>
                <example>
                    <title>Добавление квот в загрузочный уровень исполнения</title>
                    <screen><prompt>#</prompt> <userinput>rc-update add quota boot</userinput></screen>
                </example>
                <para>Теперь настроим систему для проверки квот раз в неделю, добавив следующую строку в <filename>/etc/crontab</filename>:</para>
                <example>
                    <title>Добавление проверки квот в crontab</title>
                    <programlisting>0 3 * * 0 /usr/sbin/quotacheck -avug</programlisting>
                </example>
                <para>Перезагрузив компьютер, время установить квоты для пользователей и групп. С помощью команды <command>edquota -u kn</command> запустится редактор, определенный переменной <envar>$EDITOR</envar> (по умолчанию nano) для правки квот для пользователя kn. <command>edquota -g</command> сделает то же самое для групп. </para>
                <example>
                    <title>Установка квот для пользователя kn</title>
                    <screen>Quotas for user kn:
/dev/sda4: blocks in use: 2594, limits (soft = 5000, hard = 6500)
         inodes in use: 356, limits (soft = 1000, hard = 1500)</screen>
                </example>
                <para>Для большей информации обратитесь к man edquota или <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.tldp.org/HOWTO/Quota.html">Quota miniHOWTO</link>. </para>
            </section>
            <section>
                <info>
                    <title>/etc/login.defs</title>
                </info>
                <para>Если правилами определено, что пользователи должны менять свои пароли каждые две недели, измените значения переменной <varname>PASS_MAX_DAYS</varname> на 14 и <varname>PASS_WARN_AGE</varname> на 7. Это рекомендуется для того, чтобы предотвратить старение пароля, так как полный перебор всех значений может взломать любой пароль, если есть достаточно времени. Также рекомендуется установить <varname>LOG_OK_LOGINS</varname> в значение <code>yes</code>.</para>
            </section>
            <section>
                <info>
                    <title>/etc/login.access</title>
                </info>
                <para><indexterm>
                        <primary>login.access</primary>
                    </indexterm>Файл <filename>login.access</filename> также является частью пакета sys-apps/shadow, который управляет процессом входа в систему. Он определяет на основании имени пользователя, группы или узла, кто сможет войти в систему, а кто не сможет. Так как по умолчанию этот файл содержит лишь примеры и комментарии, то все пользователи системы могут войти в систему. В зависимости от того, что вы защищаете — сервер или рабочую станцию, рекомендуется настроить этот файл так, чтобы никто, кроме вас (как администратора), не мог получить доступ к консоли. </para>
                <note>
                    <para>Эти настройки не влияют на суперпользователя. </para>
                </note>
                <example>
                    <title>/etc/login.access</title>
                    <programlisting>-:ALL EXCEPT wheel sync:console
-:wheel:ALL EXCEPT LOCAL .gentoo.org</programlisting>
                </example>
                <important>
                    <para>Настраивая эти параметры, будьте осторожны, так как любая ошибка может привести к тому, что вы не сможете войти в собственную систему, не воспользовавшись правами суперпользователя. </para>
                </important>
                <note>
                    <para>Эти настройки не применимы для SSH, так как по умолчанию для SSH не запускается <filename>/bin/login</filename>. Это может быть включено с помощью параметра UseLogin yes в файле <filename>/etc/ssh/sshd_config</filename>. </para>
                </note>
                <para>Это устанавливает доступ на вход в систему так, что только члены группы wheel могут входить в систему локально или из домена gentoo.org. Возможно, попахивает паранойей, но лучше быть в безопасности, чем сожалеть о потерянном. </para>
            </section>
        </section>
        <section>
            <info>
                <title>Права доступа к файлам</title>
            </info>
            <section>
                <info>
                    <title>Файлы, доступные по чтению для всех</title>
                </info>
                <para>Обычные пользователи не должны иметь доступ к конфигурационным файлам или паролям. Атакующий может украсть пароли к базе данных или веб-сайту и использовать их для дефейса или даже хуже — для удаления файлов. Вот почему важно правильно установить разрешения на файлы. Если вы уверены, что определенный файл может использоваться только суперпользователем, установите для него права 0600 и назначьте ему правильного владельца с помощью <command>chown</command>. </para>
            </section>
            <section>
                <info>
                    <title>Файлы, доступные по записи для группы или для всех</title>
                </info>
                <example>
                    <title>Поиск файлов, доступных по записи всем</title>
                    <screen><prompt>#</prompt> <userinput>find / -type f \( -perm -2 -o -perm -20 \) -exec ls -lg {} \; 2>/dev/null >writable.txt</userinput>
<prompt>#</prompt> <userinput>find / -type d \( -perm -2 -o -perm -20 \) -exec ls -ldg {} \; 2>/dev/null >>writable.txt</userinput></screen>
                </example>
                <para>Эти команды создадут огромный файл, содержащий имена файлов, которые имеют права на запись для группы и всех остальных. Проверьте их и устраните ненужные права, запустив для файлов команду <command>/bin/chmod o-w</command>.</para>
            </section>
            <section>
                <info>
                    <title>Файлы SUID/SGID</title>
                </info>
                <para>Файлы с битами SUID или SGID будут запущены с привелегиями владельца или группы владельца, а не с привелегиями запустившего их пользователя. Обычно это используется для файлов, которые должны запускаться с правами суперпользователя для выполнения необходимых задач. Эти файлы, если содержат уязвимости, могут стать источником повышения привелегий локальным пользователем. Это может быть опасным, поэтому с подобных файлов необходимо любой ценой удалить установленный бит SUID или SGID. Если вы не используете эти файлы, запустите для них команду <command>chmod 0</command> или удалите пакет, установивший этот файл (проверить, какому пакету принадлежит определенный файл, можно с помощью команды <command>equery</command>; если у вас ее еще нет, то, чтобы установить ее, просто наберите <command>emerge gentoolkit</command>). Иначе просто удалите бит SUID с помощью <command>chmod -s</command>.</para>
                <example>
                    <title>Поиск файлов с setuid</title>
                    <screen><prompt>#</prompt> <userinput>find / -type f \( -perm -004000 -o -perm -002000 \) -exec ls -lg {} \; 2&gt;/dev/null &gt;suidfiles.txt</userinput></screen>
                </example>
                <para>Эта команда создаст файл, содержащий список всех SUID/SGID-файлов. </para>
                <example>
                    <title>Список файлов с setuid</title>
                    <programlisting>/bin/su
/bin/ping
/bin/mount
/bin/umount
/var/qmail/bin/qmail-queue
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/crontab
/usr/bin/chage
/usr/bin/expiry
/usr/bin/sperl5.6.1
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/procmail
/usr/bin/suidperl
/usr/lib/misc/pt_chown
/usr/sbin/unix_chkpwd
/usr/sbin/traceroute
/usr/sbin/pwdb_chkpwd</programlisting>
                </example>
                <para>По умолчанию в Gentoo Linux не так много файлов с битом SUID (хотя это зависит от типа вашей установки), но у вас может получиться список, представленный выше. Большинство команд используется только суперпользователем. Удалите SUID-бит с <filename>ping</filename>, <filename>mount</filename>, <filename>umount</filename>, <filename>chfn</filename>, <filename>chsh</filename>, <filename>newgrp</filename>, <filename>suidperl</filename>, <filename>pt_chown</filename> и <filename>traceroute</filename>, запустив для каждого из них <command>chmod -s</command>. Не удаляйте бит с <filename>su</filename>, <filename>qmail-queue</filename> или <filename>unix_chkpwd</filename>. Удалив setuid с этих файлов, вы не сможете стать суперпользователем и получать почту. Удаляя бит (там, где это безопасно), вы исключаете возможность обычного пользователя (или злоумышленника) получить права суперпользователя с помощью этих файлов. </para>
                <para>В моей системе есть только несколько SUID-файлов: <filename>su</filename>, <filename>passwd</filename>, <filename>gpasswd</filename>, <filename>qmail-queue</filename>, <filename>unix_chkpwd</filename> и <filename>pwdb_chkpwd</filename>. Но если у вас запущен X-сервер, то в вашей системе их будет больше, так как X нужны повышенные привелегии, которые могут быть предоставлены посредством SUID. </para>
            </section>
            <section>
                <info>
                    <title>SUID/SGID-файлы и жесткие ссылки</title>
                </info>
                <para>Файл может считаться удаленным лишь в том случае, когда нет больше ссылок, указывающих на него. Это может звучать странно, но просто следует понять, что файл (например, <filename>/usr/bin/perl</filename>) на самом деле является ссылкой на inode, в котором сохранены данные. На файл может указывать любое число ссылок, и пока каждая их них не будет удалена, файл будет существовать. </para>
                <para>Если у ваших пользователей есть доступ к разделам, которые не смонтированы с параметрами <code>nosuid</code> или <code>noexec</code> (например, если <filename>/tmp</filename>, <filename>/home</filename>, <filename>/var/tmp</filename> не являются отдельными разделами), вы должны удостовериться, что они не смогут создать жесткие ссылки на файлы с SUID- или SGID-битами, благодаря чему они могут иметь доступ к устаревшим версиям файлов. </para>
                <warning>
                    <para>Если вы получаете предупреждения об оставшихся жестких ссылках, а ваши пользователи имеют доступ по записи к разделам, позволяющим запускать файлы с SUID/SGID-битами, вы должны прочитать этот раздел очень внимательно. Любой из ваших пользователей может разрушить ваши обновления, сохранив устаревшую версию программы. Если ваши пользователи не могут создавать собственные файлы с битом SUID или могут только запускать программы с помощью динамического загрузчика (разделы, смонтированные с параметром noexec), то вам не о чем беспокоиться. </para>
                </warning>
                <note>
                    <para>Пользователям не нужен доступ по чтению для файла, чтобы создать на него ссылку, им нужен всего лишь доступ по чтению к каталогу, содержащему этот файл. </para>
                </note>
                <para>Чтобы проверить, сколько ссылок имеет файл, вы можете использовать команду <command>stat</command>. </para>
                <example>
                    <title>Команда stat</title>
                    <screen><prompt>$</prompt> <userinput>stat /bin/su</userinput>
  File: `/bin/su'
  Size: 29350           Blocks: 64         IO Block: 131072 regular file
Device: 900h/2304d      Inode: 2057419     Links: 1
Access: (4711/-rws--x--x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2005-02-07 01:59:35.000000000 +0000
Modify: 2004-11-04 01:46:17.000000000 +0000
Change: 2004-11-04 01:46:17.000000000 +0000</screen>
                </example>
                <para>Чтобы найти файлы с SUID и SGID со множеством ссылок, вы можете задействовать команду <command>find</command>. </para>
                <example>
                    <title>Поиск suid/sgid-файлов с несколькими ссылками</title>
                    <screen><prompt>$</prompt> <userinput>find / -type f \( -perm -004000 -o -perm -002000 \) -links +1 -ls</userinput></screen>
                </example>
            </section>
        </section>
        <section>
            <info>
                <title>PAM</title>
            </info>
            <section>
                <info>
                    <title>PAM</title>
                </info>
                <para><indexterm>
                        <primary>PAM</primary>
                    </indexterm>PAM — это набор библиотек, предоставляющих альтернативный способ аутентификации пользователя в программах. USE-флаг <code>pam</code> уже включен по умолчанию. Хотя настройки PAM в Gentoo Linux довольно разумны, всегда есть возможность что-нибудь улучшить. Для начала установите cracklib. </para>
                <example>
                    <title>Установка cracklib</title>
                    <screen><prompt>#</prompt> <userinput>emerge cracklib</userinput></screen>
                </example>
                <example>
                    <title>/etc/pam.d/passwd</title>
                    <programlisting>auth     required pam_unix.so shadow nullok
account  required pam_unix.so
password required pam_cracklib.so difok=3 retry=3 minlen=8 dcredit=2 ocredit=2
password required pam_unix.so md5 use_authtok
session  required pam_unix.so</programlisting>
                </example>
                <para>После этого с помощью cracklib будет проверяться пароль пользователя, имеет ли он длину по крайней мере 8 символов, содержит ли он по крайней мере 2 цифры, 2 других символа и не менее 3 символов, отличающихся от символов прошлого пароля. Благодаря этому пользователь будет выбирать стойкие пароли. Проверьте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.kernel.org/pub/linux/libs/pam/Linux-PAM-html/pam-6.html#ss6.3">документацию PAM</link> для других параметров. </para>
                <example>
                    <title>/etc/pam.d/sshd</title>
                    <programlisting>auth     required pam_unix.so nullok
auth     required pam_shells.so
auth     required pam_nologin.so
auth     required pam_env.so
account  required pam_unix.so
password required pam_cracklib.so difok=3 retry=3 minlen=8 dcredit=2 ocredit=2 use_authtok
password required pam_unix.so shadow md5
session  required pam_unix.so
session  required pam_limits.so</programlisting>
                </example>
                <para>Любая служба, не описанная в одном из файлов PAM из каталога <filename>/etc/pam.d</filename>, будет использовать правила, взятые из /etc/pam.d/other. По умолчанию установлена политика <code>deny</code>, как и должно быть. Но нам нужна регистрация, поэтому добавим <code>pam_warn.so</code>. Последняя конфигурация — это <code>pam_limits</code>, которая управляется с помощью <filename>/etc/security/limits.conf</filename>. См. раздел <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#">/etc/security/limits.conf</link> для подробного описания этих настроек. </para>
                <example>
                    <title>/etc/pam.d/other</title>
                    <programlisting>auth     required pam_deny.so
auth     required pam_warn.so
account  required pam_deny.so
account  required pam_warn.so
password required pam_deny.so
password required pam_warn.so
session  required pam_deny.so
session  required pam_warn.so</programlisting>
                </example>
            </section>
        </section>
        <section>
            <info>
                <title>Упаковщики TCP</title>
            </info>
            <section>
                <info>
                    <title>Упаковщики TCP</title>
                </info>
                <para>Обычно для контроля доступом к службам используется inetd (которого в Gentoo нет), но так же можно воспользоваться xinetd или другими сервисами. </para>
                <note>
                    <para>Служба должна быть запущена с помощью tcpd в качестве аргумента сервера (для случая xinetd). См. раздел о xinetd для большей информации. </para>
                </note>
                <example>
                    <title>/etc/hosts.deny</title>
                    <programlisting>ALL:PARANOID</programlisting>
                </example>
                <example>
                    <title>/etc/hosts.allow</title>
                    <programlisting>ALL: LOCAL @wheel
time: LOCAL, .gentoo.org</programlisting>
                </example>
                <para>Как вы видите, формат записи очень похож на содержимое файла <filename>/etc/login.access</filename>. Tcpd поддерживает отдельная служба; она никак не связана с <filename>/etc/login.access</filename>. Эти настройки применимы только для служб, использующих упаковщики TCP. </para>
                <para>Также возможно запускать команды при разрешенной службе (это может быть полезным для создания трансляций для коммутируемых пользователей), но это не рекомендуется, так как обычно, решая одну проблему, люди создают еще больше. Допустим, что вы настроили сценарий, отправляющий электронное письмо в том случае, когда кто-то подпал под запрещающее правило, но тогда злоумышленник может запустить DoS-атаку, попадающую под правило запрещения. Из-за этого создастся много ввода-вывода и ненужно электронной почты, поэтому не делайте так! Прочтите <command>man 5 hosts_access</command> для дальнейшей информации. </para>
            </section>
        </section>
        <section>
            <info>
                <title>Безопасность ядра</title>
            </info>
            <section>
                <info>
                    <title>Удаление функциональности</title>
                </info>
                <para>Основное правило при конфигурации ядра — удалять все ненужное. Это не только создаст маленькое ядро, но и также исключит вероятные уязвимости, которые могут присутствовать в драйверах и других возможностях. </para>
                <para>Также рекомендуется отключить поддержку загружаемых модулей. Хотя возможность внедрения руткитов сохраняется, это делает систему более неприступной для обычного злоумышленника, пытающегося установить руткит в виде модуля ядра.</para>
            </section>
            <section>
                <info>
                    <title>Файловая система proc</title>
                </info>
                <para>Множество параметров ядра может быть изменено с помощью файловой системы <filename>/proc</filename> или <command>sysctl</command>.</para>
                <para>Чтобы иметь возможность на лету изменять параметры и переменные ядра, вам понадобится определить в ядре <varname>CONFIG_SYSCTL</varname>. Она включена по умолчанию в ядрах серии 2.4. </para>
                <example>
                    <title>Отключения IP-форвардинга</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "0" &gt; /proc/sys/net/ipv4/ip_forward</userinput></screen>
                </example>
                <para>Проверьте, что проброс IP-пакетов отключен. Эта возможность необходима лишь для узла, имеющего доступ к нескольким сетям. Рекомендуется устанавливать и отключать этот флаг до включения или отключения других флагов. </para>
                <example>
                    <title>Отбрасывание пакетов ping</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "1" &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</userinput></screen>
                </example>
                <para>Это просто заставит ядро игнорировать все сообщения ping (ICMP-пакеты типа 0). IP-пакет, несущий ICMP-сообщение, может содержать также в нагрузку и другую информацию, о которой вы можете не подозревать, поэтому следует отключить прием. Администраторы используют ping как утилиту диагностики и часто выражают недовольство, если она отключена, но нет причины позволять чужакам пинговать узел. Тем не менее, если необходимо разрешить внутренним пользователям использовать ping, то можно отключить сообщения ICMP типа 0 в межсетевом экране (тем самым позволив локальным администраторам использовать эту утилиту). </para>
                <example>
                    <title>Игнорирование широковещательных запросов ping</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "1" &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</userinput></screen>
                </example>
                <para>Это отключает ответ на широковещательные ICMP-запросы, предотвращая реализацию Smurf-атаки. Smurf-атака основана на отправке ICMP-пакета типа 0 (ping) по широковещательному адресу сети. Обычно для этого злоумышленник использует поддельный адрес. Все компьютеры сети ответят на сообщение ping, что может вызвать наводнение трафика на узел, адрес которого был подделан. </para>
                <example>
                    <title>Отключение исходящих маршрутизированных пакетов.</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "0" &gt; /proc/sys/net/ipv4/conf/all/accept_source_route</userinput></screen>
                </example>
                <para>Не принимать исходящие маршрутизированные пакеты. Злоумышленники могут использовать исходящую маршрутизацию для генерации трафика, имеющего адрес внутренней сети, но на самом деле возвращаемого назад злоумышленнику, что позволит ему компрометировать сеть. Исходящая маршрутизация очень редко используется по назначению, так что безопаснее ее отключить. </para>
                <example>
                    <title>Отключение приема перенаправлений</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "0" > /proc/sys/net/ipv4/conf/all/accept_redirects</userinput>
<prompt>#</prompt> <userinput>/bin/echo "0" > /proc/sys/net/ipv4/conf/all/secure_redirects</userinput></screen>
                </example>
                <para>Не принимать ICMP-пакеты перенаправления. ICMP-перенаправления могут быть использованы злоумышленником для изменения таблиц маршрутизации. </para>
                <example>
                    <title>Защита против неправильных сообщений об ошибках</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "1" &gt; /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses</userinput></screen>
                </example>
                <para>Включить защиту против приходящих неправильных сообщений об ошибках. </para>
                <example>
                    <title>Включение фильтрации обратного пути</title>
                    <screen><prompt>#</prompt> <userinput>for i in /proc/sys/net/ipv4/conf/*; do
        /bin/echo "1" > $i/rp_filter
done</userinput></screen>
                </example>
                <para>Включает фильтрацию обратного пути. Это поможет быть уверенным, что в пакетах используются правомерные адреса, при этом входящие пакеты будут автоматически отброшены, если запись в таблице маршрутизации об адресе этих пакетов не соответствуют сетевому интерфейсу, с которого они пришли. Это позволит предотвратить подделку IP-адресов. Необходимо включить эту возможность для каждого net/ipv4/conf/*, иначе проверка исходящих пакетов не будет полностью функционировать. </para>
                <warning>
                    <para>Тем не менее включение фильтрации обратного пути может стать проблемой при использовании асимметричной маршрутизации (исходящие пакеты идут отличным от входящих пакетов путем) или при использовании немаршрутизируемом узле с несколькими IP-адресами на различных интерфейсах. </para>
                </warning>
                <example>
                    <title>Регистрация всех поддельных, исходящих маршрутизированных и перенаправленных пакетов</title>
                    <screen><prompt>#</prompt> <userinput>/bin/echo "1" &gt; /proc/sys/net/ipv4/conf/all/log_martians</userinput></screen>
                </example>
                <para>Регистрировать поддельные пакеты, пакеты с исходящей маршрутизацией и пакеты перенаправлений. </para>
                <para>Все настройки будут сброшены после перезагрузки компьютера. Рекомендуется добавлять их в <filename>/etc/sysctl.conf</filename>, который будет автоматически загружен сценарием инициализации <filename>/etc/init.d/bootmisc</filename>.</para>
                <para>Синтаксис <filename>/etc/sysctl.conf</filename> достаточно понятный. Удалите из указанных путей <filename>/proc/sys/</filename> и замените <filename>/</filename> на <filename>.</filename>: </para>
                <example>
                    <title>Переход к файлу <filename>sysctl.conf</filename></title>
                    <programlisting><lineannotation>(Вручную с помощью команды echo:)</lineannotation>
/bin/echo "0" > /proc/sys/net/ipv4/ip_forward

<lineannotation>(Автоматически в файле sysctl.conf:)</lineannotation>
net.ipv4.ip_forward = 0</programlisting>
                </example>
            </section>
            <section>
                <info>
                    <title>Grsecurity</title>
                </info>
                <para>Заплатка от <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://grsecurity.net/">Grsecurity</link> входит в <package>sys-kernel/hardened-sources</package>, но по умолчанию отключена. Сначала сконфигурируйте ядро, а затем настройте параметры Grsecurity. Подробное описание доступных параметров Grsecurity можно найти на странице проекта <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/proj/en/hardened?style=printable">укрепленного Gentoo</link>. </para>
                <para>Последние версии hardened-sources содержат Grsecurity версии 2.*. Для дополнительной информации о наборе патчей Grsecurity обратитесь к документации, доступной на <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.grsecurity.net/">домашнем сайте Grsecurity</link>. </para>
            </section>
            <section>
                <info>
                    <title>Kerneli</title>
                </info>
                <para><indexterm>
                        <primary>Kerneli</primary>
                    </indexterm><link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.Kerneli.org/">Kerneli</link> — это заплатка, которая добавляет функции шифрования к существующему ядру. Наложив эту заплатку на ядро, вы получите такие новые параметры, как алгоритмы шифрования, дайджеста и фильтры к зашифрованным образам. </para>
                <warning>
                    <para>В настоящий момент заплатка kerneli для последнего ядра нестабильна, поэтому будьте осторожны при ее использовании. </para>
                </warning>
            </section>
            <section>
                <info>
                    <title>Другие заплатки к ядру</title>
                </info>
                <orderedlist>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.openwall.com/">Проект OpenWall</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.lids.org/">Linux Intrusion Detection System</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.rsbac.org/">Rule Set Based Access Control</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.nsa.gov/selinux">NSA's security enhanced kernel</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://sourceforge.net/projects/wolk/">Wolk</link>
                        </para>
                    </listitem>
                </orderedlist>
                <para>И множество других. </para>
            </section>
        </section>
        <section>
            <info>
                <title>Безопасность служб</title>
            </info>
            <section>
                <info>
                    <title>Apache</title>
                </info>
                <para>Apache поставляется с достаточно полным конфигурационным файлом по умолчанию, но опять же необходимо улучшить некоторые аспекты, например, использовать для Apache только один адрес. Ниже приведены параметры, которые вы должны внести в конфигурационный файл. </para>
                <para>Если вы не отключали поддержку ssl в <filename>/etc/make.conf</filename> перед установкой Apache, то теперь вы должны иметь доступ к серверу с включенным SSL. Чтобы включить ее, просто добавьте следующую строку. </para>
                <example>
                    <title>/etc/conf.d/apache</title>
                    <programlisting>HTTPD_OPTS="-D SSL"</programlisting>
                </example>
                <example>
                    <title>/etc/apache/conf/apache.conf</title>
                    <programlisting>#Добавьте свой IP для прослушивания
Listen 127.0.0.1
BindAddress 127.0.0.1
#Не следует использовать nobody или nogroup для каждого сервиса, запущенного
#без административных привелегий
#(просто добавляем пользователя apache с группой apache)
User apache
Group apache
#Не сообщать информацию о версии сервера
ServerSignature Off
ServerTokens Prod</programlisting>
                </example>
                <para>Apache собран с параметрами <option>--enable-shared=max</option> и <option>--enable-module=all</option>. По умолчанию это включает все модули, поэтому вы должны закомментировать все неиспользуемые модули в разделе <code>LoadModule</code> (<code>LoadModule</code> и <code>AddModule</code>). Затем перезапустите сервис, выполнив <command>/etc/init.d/apache restart</command>.</para>
                <para>Документация доступна по адресу <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.apache.org/">http://www.apache.org</link>. </para>
            </section>
            <section>
                <info>
                    <title>Bind</title>
                </info>
                <para>Документацию можно найти на сайте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.isc.org/products/BIND/bind9.html">Internet Software Consortium</link>. Руководство администратора BIND 9 также доступно каталоге doc/arm. </para>
                <para>Новые сборочные файлы BIND поддерживают изменение корневого каталога из коробки. После установки bind следуйте этим простым инструкциям: </para>
                <example>
                    <title>Изолирование среды BIND</title>
                    <screen><prompt>#</prompt> <userinput>emerge --config bind</userinput>
<lineannotation>(Перед запуском следующей команды вам может потребоваться изменить каталог
chroot в файле /etc/conf.d/named. Иначе будет использован /chroot/dns.)</lineannotation></screen>
                </example>
            </section>
            <section>
                <info>
                    <title>Djbdns</title>
                </info>
                <para><indexterm>
                        <primary>djbdns</primary>
                    </indexterm>Djbdns — это реализация DNS, за обнаружение уязвимостей в которой автор готов выплачивать <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://cr.yp.to/djbdns/guarantee.html">деньги</link>. Принцип работы сильно отличается от Bind 9, однако он работает. Дополнительная информация может быть получена на сайте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.djbdns.org/">http://www.djbdns.org</link>. </para>
            </section>
            <section>
                <info>
                    <title>FTP</title>
                </info>
                <para>В общем случае использование FTP (File Transfer Protocol, протокол передачи файлов) является плохой идеей. Этот протокол отправляет данные незашифрованными (в том числе и пароли), прослушивает 2 порта (обычно это порты 20 и 21), и часто злоумышленники ищут анонимный доступ для обмена варезом. Так как протокол содержит ряд проблем безопасности, то следует использовать sftp или HTTP. Если это невозможно, то максимально обезопасьте свои сервисы и будьте готовы. </para>
            </section>
            <section>
                <info>
                    <title>Mysql</title>
                </info>
                <para>Если вам необходимо предоставить доступ к базе данных mysql локальным приложениям, раскомментируйте следующую строку в <filename>/etc/mysql/my.cnf</filename>. </para>
                <example>
                    <title>Отключение доступа к сети</title>
                    <programlisting>skip-networking</programlisting>
                </example>
                <para>Затем мы отключаем использование команды LOAD DATA LOCAL INFILE. Это предотвратит несанкционированное чтение локальных файлов. Это также подходит против SQL-инъекций в PHP-сценариях.</para>
                <example>
                    <title>Отключение LOAD DATA LOCAL INFILE в разделе [mysqld]</title>
                    <programlisting>set-variable=local-infile=0</programlisting>
                </example>
                <para>Затем необходимо удалить тестовую базу данных (test) и все учетные записи за исключением root. </para>
                <example>
                    <title>Удаление тестовой базы данных и всех ненужных пользователей</title>
                    <screen><prompt>mysql></prompt> <userinput>drop database test;</userinput>
<prompt>mysql></prompt> <userinput>use mysql;</userinput>
<prompt>mysql></prompt> <userinput>delete from db;</userinput>
<prompt>mysql></prompt> <userinput>delete from user where not (host="localhost" and user="root");</userinput>
<prompt>mysql></prompt> <userinput>flush privileges;</userinput></screen>
                </example>
                <warning>
                    <para>Если вас уже есть настроенные учетные записи, то будьте осторожны с этими командами. </para>
                </warning>
                <note>
                    <para>Если вы изменяли пароли в командной строке MySQL, то всегда очищайте <filename>~/.mysql_history</filename> и <filename>/var/log/mysql/mysql.log</filename>, так как они сохраняют список выполненных SQL-команд с открытыми паролями. </para>
                </note>
            </section>
            <section>
                <info>
                    <title>Proftpd</title>
                </info>
                <para>У proftpd было несколько проблем с безопасностью, но большинство из них было исправлено. Тем не менее, неплохо внести некоторые улучшения: </para>
                <example>
                    <title><filename>/etc/proftpd/proftpd.conf</filename></title>
                    <programlisting>ServerName "My ftp daemon"
# Не показывать ident сервера
ServerIdent on "Go away"

# Упрощаем создание виртуальных пользователей
RequireValidShell off

# Использовать альтернативные файлы паролей и групп (в формате passwd)
AuthUserFile "/etc/proftpd/passwd"
AuthGroupFile "/etc/proftpd/group"

# Разрешения
Umask 077

# Таймауты и ограничения
MaxInstances 30
MaxClients 10 "Only 10 connections allowed"
MaxClientsPerHost 1 "You have already logged on once"
MaxClientsPerUser 1 "You have already logged on once"
TimeoutStalled 10
TimeoutNoTransfer 20
TimeoutLogin 20

# Все входят в изолированную оболочку
DefaultRoot ~

# Не запускать с правами администратора
User  nobody
Group nogroup

# Регистрировать любые передачи
TransferLog /var/log/transferlog

# Проблемы с универсализацией имен файлов
DenyFilter \*.*/</programlisting>
                </example>
                <para>Дополнительная информация может быть найдена на <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.proftpd.org/">http://www.proftpd.org</link>. </para>
            </section>
            <section>
                <info>
                    <title>Pure-ftpd</title>
                </info>
                <para><indexterm>
                        <primary>pure-ftpd</primary>
                    </indexterm>Pure-ftpd является ответвлением оригинального trollftpd с модификациями Фрэнка Денниса по части безопасности и функциональности. </para>
                <para>Используйте виртуальных пользователей (и никогда не применяйте системные учетные записи), включив параметр <varname>AUTH</varname>. Установите его для <code>-lpuredb:/etc/pureftpd.pdb</code> и создайте пользователей при помощи команды <command>/usr/bin/pure-pw</command>. </para>
                <example>
                    <title><filename>/etc/conf.d/pure-ftpd</filename></title>
                    <programlisting>AUTH="-lpuredb:/etc/pureftpd.pdb"

## Misc. Others ##
MISC_OTHER="-A -E -X -U 177:077 -d -4 -L100:5 -I 15"</programlisting>
                </example>
                <para>Добавьте к переменной <varname>MISC_OTHER</varname> параметры запрета на подключение анонимных пользователей (<option>-E</option>), изменения корневого каталога для всех (<option>-A</option>), запрета записи и чтения файлов, начинающихся с точки (<option>-X</option>), максимального периода бездействия (<option>-I</option>), ограничения рекурсии (<option>-L</option>) и подходящего umask. </para>
                <warning>
                    <para>Не используйте параметры <option>-w</option> или <option>-W</option>! Если же вы хотите, чтобы у вас был сайт с варезом, то перестаньте читать это руководство! </para>
                </warning>
                <para>Дополнительная информация может быть найдена на <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.pureftpd.org/">http://www.pureftpd.org</link>. </para>
            </section>
            <section>
                <info>
                    <title>Vsftpd</title>
                </info>
                <para><indexterm>
                        <primary>vsftpd</primary>
                    </indexterm>Vsftpd (сокращение от very secure ftp) — это небольшой FTP-демон, который может запускаться с настройками по умолчанию. Он прост и не имеет множества возможностей, присущих pureftp и proftp.</para>
                <example>
                    <title><filename>/etc/vsftpd</filename></title>
                    <programlisting>anonymous_enable=NO
local_enable=YES

#read only
write_enable=NO

#enable logging of transfers
xferlog_std_format=YES

idle_session_timeout=20
data_connection_timeout=20
nopriv_user=nobody

chroot_list_enable=YES
chroot_list_file=/etc/vsftpd/chrootlist

ls_recurse_enable=NO</programlisting>
                </example>
                <para>Как вы можете видеть, нет возможности установить для данного сервиса индивидуальные разрешения, но если используется настройки для анонимного доступа, то это он не так уж плох. Иногда неплохо иметь анонимный FTP-сервер (для доступа к открытому ПО), и vsftpd неплохо подходит для этой работы. </para>
            </section>
            <section>
                <info>
                    <title>Netqmail</title>
                </info>
                <para><indexterm>
                        <primary>netqmail</primary>
                    </indexterm>Netqmail часто признается наиболее безопасным почтовым сервером. Он написан с прицелом на безопасность (и паранойю). По умолчанию он не разрешает релей и, начиная с 1996 года, не имеет никаких уязвимостей безопасности. Просто наберите <command>emerge netqmail</command> и настройте его! </para>
            </section>
            <section>
                <info>
                    <title>Samba</title>
                </info>
                <para><indexterm>
                        <primary>Samba</primary>
                    </indexterm>Samba — это протокол, предоставляющий файлы в сетях Microsoft/Novell, и он не должен использоваться в интернете. Его необходимо обезопасить. </para>
                <example>
                    <title>/etc/samba/smb.conf</title>
                    <programlisting>[global]
  #Прослушивать определенный интерфейс
  interfaces = eth0 10.0.0.1/32

  #Использовать зашифрованные пароли
  encrypt passwords = yes
  directory security mask = 0700

  #Разрешить трафик из подсети 10.0.0.*
  hosts allow = 10.0.0.

  #Включить аутентификацию
  #(не используйте режим share)
  security = user

  #Запретить привелигерованные учетные записи
  invalid users = root @wheel

  #Максимальный отображаемый размер ресурса (не является ограничителем)
  max disk size = 102400

  #Ужесточить политики паролей
  min password length = 8
  null passwords = no

  #Использовать PAM (если была добавлена поддержка)
  obey pam restrictions = yes
  pam password change = yes</programlisting>
                </example>
                <para>Проверьте, что для каждого ресурса выставлены правильные разрешения и не забудьте прочитать <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.samba.org/">документацию</link>. </para>
                <para>Теперь перезапустите сервер и добавьте пользователей, которым необходим доступ к этому сервису. Это можно сделать с помощью команды /usr/bin/smbpasswd с параметром -a. </para>
            </section>
            <section>
                <info>
                    <title>ssh</title>
                </info>
                <para>Для OpenSSH необходимо лишь одно улучшение — использование более надежного механизма аутентификации, основанного на шифровании с использованием открытого ключа. Очень много сайтов (например, <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.sourceforge.net/">http://www.sourceforge.net</link>, <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.php.net/">http://www.php.net</link> и <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.apache.org/">http://www.apache.org</link>) было подвержено несанкционированному доступу из-за пустых или слабых паролей. </para>
                <example>
                    <title>/etc/ssh/sshd_config</title>
                    <programlisting>#Включаем только версию 2
Protocol 2

#Отключаем вход администратора. Пользователи могут использовать su для входа
PermitRootLogin no

#Включаем аутентификацию по открытому ключу
PubkeyAuthentication yes
AuthorizedKeysFile      .ssh/authorized_keys

#Отключаем .rhost и обычную аутентификацию по паролю
HostbasedAuthentication no
PasswordAuthentication no
PermitEmptyPasswords no

#Разрешаем подключаться только пользователям из групп wheel или admin
AllowGroups wheel admin

#Из этих групп разрешаем подключаться только следующим пользователям
#@&lt;domainname> не обязательна, но заменяет старую директиву
#AllowHosts
AllowUsers kn@gentoo.org bs@gentoo.org

#Вход в систему
SyslogFacility AUTH
LogLevel INFO

<lineannotation>(Измените адрес на свой)</lineannotation>
ListenAddress 127.0.0.1
</programlisting>
                </example>
                <para>Также проверьте, что в конфигурационном файле нет параметра <code>UsePAM yes</code>, который перекрывает механизм аутентификации с помощью открытого ключа. </para>
                <para>Теперь создайте для каждого пользователя ключ (на компьютере, с которого они будут регистрироваться) с помощью следующей команды: </para>
                <example>
                    <title>Создание пар ключей DSA</title>
                    <screen><prompt>#</prompt> <userinput>/usr/bin/ssh-keygen -t dsa</userinput></screen>
                </example>
                <para>И введите пароль.</para>
                <example>
                    <title>Вывод ssh-keygen</title>
                    <screen>Generating public/private dsa key pair.
Enter file in which to save the key (/home/kn/.ssh/id_dsa):<userinput>[Press enter]</userinput>
Created directory '/home/kn/.ssh'.
Enter passphrase (empty for no passphrase): <userinput>[Enter passphrase]</userinput>
Enter same passphrase again: <userinput>[Enter passphrase again]</userinput>
Your identification has been saved in /home/kn/.ssh/id_dsa.
Your public key has been saved in /home/kn/.ssh/id_dsa.pub.
The key fingerprint is:
07:24:a9:12:7f:83:7e:af:b8:1f:89:a3:48:29:e2:a4 kn@knielsen</screen>
                </example>
                <para>После этого в каталоге <filename>~/.ssh/</filename> появятся два файла с названием <filename>id_dsa</filename> и <filename>id_dsa.pub</filename>. Файл <filename>id_dsa</filename> является секретным ключом и должен оберегаться от других. Другой файл, <filename>id_dsa.pub</filename>, должен быть размещен на каждом сервере, к которому необходим доступ. Добавьте этот ключ в каталог <filename>~/.ssh/authorized_keys</filename> в домашнем каталоге пользователя. Теперь пользователь должен иметь доступ к подключению: </para>
                <example>
                    <title>Adding the id_dsa.pub file to the authorized_keys file</title>
                    <screen><prompt>$</prompt> <userinput>scp id_dsa.pub other-host:/var/tmp/currenthostname.pub</userinput>
<prompt>$</prompt> <userinput>ssh other-host</userinput>
password:
<prompt>$</prompt> <userinput>cat /var/tmp/currenthostname.pub >> ~/.ssh/authorized_keys</userinput></screen>
                </example>
                <para>Теперь ваши пользователи должны тщательно оберегать свои секретные ключи. Поместите их на сменный носитель, который они будут всегда носить с собой, или спрячьте их на рабочих станциях пользователей (поместите их под правила <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#">паролей</link>). </para>
                <para>Для дальнейшей информации посетите веб-сайт <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.openssh.org/">OpenSSH</link>. </para>
            </section>
            <section>
                <info>
                    <title>Использование xinetd</title>
                </info>
                <para><indexterm>
                        <primary>xinetd</primary>
                    </indexterm>xinetd является заменой inetd (которого в Gentoo нет), демона сетевых сервисов. Он поддерживает контроль доступа, основанный на адресе удаленного узла и времени доступа. Он также предоставляет расширенные возможности регистрации событий, включая время запуска сервера, адрес удаленного узла, имя удаленного пользователя, время работы сервера и выполненные запросы. </para>
                <para>Как в случае с другими сервисами, важно создать хорошую конфигурацию по умолчанию. Но так как xinetd запускается с правами администратора и поддерживает протоколы, о работе которых вы можете не знать, рекомендуется не использовать его. Но если вы все равно хотите использовать его, то вы можете укрепить его безопасность: </para>
                <example>
                    <title>Установка xinetd</title>
                    <screen><prompt>#</prompt> <userinput>emerge xinetd tcp-wrappers</userinput></screen>
                </example>
                <para>И отредактируйте конфигурационный файл: </para>
                <example>
                    <title><filename>/etc/xinetd.conf</filename></title>
                    <programlisting>defaults
{
 only_from = localhost
 instances = 10
 log_type = SYSLOG authpriv info
 log_on_success = HOST PID
 log_on_failure = HOST
 cps = 25 30
}

# Это установит работу pserver (cvs) через xinetd со следующими:
# настройками:
# максимум 10 обработчиков (10 подключений одновременно)
# использовать только TCP
# использовать пользователя cvs для запуска сервиса
# использовать только 1 IP
# разрешать доступ с 10.0.0.*
# разработчики могут пользоваться cvs только с 8 до 17 часов
# использовать упаковщики tpcd (контроль доступа через
# /etc/hosts.allow и /etc/hosts.deny)
# max_load для компьютера 1.0
# Отключающий флаг для настроек по умолчанию, я предпочитаю,
# чтобы он был отключен
service cvspserver
{
 socket_type = stream
 protocol = tcp
 instances = 10
 protocol = tcp
 wait = no
 user = cvs
 bind = 10.0.0.2
 only_from = 10.0.0.0
 access_times = 8:00-17:00
 server = /usr/sbin/tcpd
 server_args = /usr/bin/cvs --allow-root=/mnt/cvsdisk/cvsroot pserver
 max_load = 1.0
 log_on_failure += RECORD
 disable = no
}</programlisting>
                </example>
                <para>Для большей информации см. <command>man 5 xinetd.conf</command>.</para>
            </section>
            <section>
                <info>
                    <title>X</title>
                </info>
                <para>По умолчанию Xorg настроен функционировать в качестве Xserver. Это может быть опасным, так как X использует не зашифрованные TCP-соединения и прослушивает подключения xclient. </para>
                <important>
                    <para>Если вам не нужен этот сервис, отключите его! </para>
                </important>
                <para>Но если вам требуется использовать рабочую станцию в качестве X-сервера, используйте команду <command>/usr/X11R6/bin/xhost</command> с большой осторожностью. Эта команда позволит клиентам других узлов подключаться к вашему экрану. Это может быть полезно при необходимости запуска приложения X с другого компьютера, и это возможно лишь через сеть, но это может быть использовано и злоумышленником. Синтаксис этой команды — <command>/usr/X11R6/bin/xhost +hostname</command>. </para>
                <warning>
                    <para>Не используйте возможность <code>xhost +</code>! Эта возможность позволит любому клиенту подключиться к X-серверу и взять контроль над ним. Если злоумышленник может получить доступ к X, то сможет регистрировать нажатия на клавиши, что позволит ему взять контроль над вашим компьютером. Если вы все же используете ее, то всегда указывайте узел. </para>
                </warning>
                <para>Более безопасным решением является полное отключение этой возможности при старте X-сервера с помощью <command>startx -- -nolisten tcp</command> или отключение ее навсегда в файлах конфигурации. </para>
                <example>
                    <title>/usr/X11R6/bin/startx</title>
                    <programlisting>defaultserverargs="-nolisten tcp"</programlisting>
                </example>
                <para>Вы должны защитить startx, чтобы не допустить его перезаписи при установке новой версии Xorg. Добавьте следующую строку в <filename>/etc/make.conf</filename>: </para>
                <example>
                    <title><filename>/etc/make.conf</filename></title>
                    <programlisting>CONFIG_PROTECT_MASK="/usr/X11R6/bin/startx"</programlisting>
                </example>
                <para>Если вы используете графический диспетчер входа в систему, вам понадобится другой подход. </para>
                <para>Для gdm (Gnome Display Manager) </para>
                <example>
                    <title><filename>/etc/X11/gdm/gdm.conf</filename></title>
                    <programlisting>[server-Standard]
command=/usr/X11R6/bin/X -nolisten tcp</programlisting>
                </example>
                <para>Для xdm (X Display Manager) и kdm (Kde Display Manager) </para>
                <example>
                    <title><filename>/etc/X11/xdm/Xservers</filename></title>
                    <programlisting>:0 local /usr/bin/X11/X -nolisten tcp</programlisting>
                </example>
            </section>
        </section>
        <section>
            <info>
                <title>Изменение корневого каталога и виртуальные серверы</title>
            </info>
            <section>
                <info>
                    <title>Изменение корневого каталога</title>
                </info>
                <para>Изменение корневого каталога для службы является способом ограничения среды службы (или пользователя), в которой она имеет доступ лишь к необходимым ресурсам. Запущенная служба под пользователем, отличном от суперпользователя (nobody, apache, named) может предоставить злоумышленнику доступ лишь к тем файлам, к которым имеет доступ пользователь, от имени которого запущена служба. Это означает, что злоумышленник не сможет получить права root, даже если служба подвержена различным уязвимостям. </para>
                <para>Некоторые службы, например pure-ftpd и bind, могут быть заключены в chroot. Если служба поддерживает эту возможность, используйте ее, иначе вы можете можете создать среду собственноручно. Давайте рассмотрим пример создания chroot. Чтобы изучить работу механизма chroot, мы будем экспериментировать с bash (простейший для изучения случай). </para>
                <para>Создайте каталог <filename>/chroot</filename>, выполнив команду <command>mkdir /chroot</command>. Затем определите, какие динамические библиотеки необходимы для работы bash (если он собран с параметром <option>-static</option>, этот шаг можно пропустить): </para>
                <para>Следующая команда создаст список библиотек, необходимых для bash. </para>
                <example>
                    <title>Получение списка используемых библиотек</title>
                    <screen><prompt>#</prompt> <userinput>ldd /bin/bash</userinput>
  libncurses.so.5 => /lib/libncurses.so.5 (0x4001b000)
  libdl.so.2 => /lib/libdl.so.2 (0x40060000)
  libc.so.6 => /lib/libc.so.6 (0x40063000)
  /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x40000000)</screen>
                </example>
                <para>Теперь создадим изолированную среду для bash. </para>
                <example>
                    <title>Создание изолированной среды для bash</title>
                    <screen><prompt>#</prompt> <userinput>mkdir /chroot/bash</userinput>
<prompt>#</prompt> <userinput>mkdir /chroot/bash/bin</userinput>
<prompt>#</prompt> <userinput>mkdir /chroot/bash/lib</userinput></screen>
                </example>
                <para>Затем скопируем файлы, используемые bash (<filename>/lib</filename>) в изолированный <filename>lib</filename> и скопируем файл <filename>bash</filename> в изолированный каталог <filename>bin</filename>. Этим мы создадим ту же самую среду, но с ограниченными возможностями. После этого попробуйте выполнить команду <command>chroot /chroot/bash /bin/bash</command>. Если вы получите строку приглашения, гласящую /, то у вас все получилось! Иначе вам сообщат, какого файла не хватает. Некоторые разделяемые библиотеки могут использовать другие файлы. </para>
                <para>Как вы можете заметить, внутри изолированной среды ничего, кроме <command>echo</command>, не работает. Это потому что в внутри среды chroot кроме bash нет никаких других команд, а <command>echo</command> является встроенной командой. </para>
                <para>Подобным образом вы можете создать службу в изолированной среде. Единственное различие в том, что служба может время от времени обращаться к устройствам и файлам настроек в <filename>/etc</filename>. Просто скопируйте их (файлы устройств можно скопировать с помощью команды <command>cp -a</command>) в изолированную среду, отредактируйте сценарий инициализации перед тем, как заключить службу в среду. Может быть сложным определить, какие устройства и файлы конфигурации могут понадобиться. Здесь может пригодиться команда <command>strace</command>. Запустите службу вместе с <command>/usr/bin/strace</command> и отследите все вызовы open, read, stat и, возможно, connect. Это подскажет вам, что нужно копировать. Но в большинстве случаев вам понадобится скопировать файл passwd (отредактируйте копию, удалив из него всех пользователей, не нужных для запуска службы), <filename>/dev/zero</filename>, <filename>/dev/log</filename> и <filename>/dev/random</filename>.</para>
            </section>
            <section>
                <info>
                    <title>Пользовательский режим Linux</title>
                </info>
                <para>Другим способом создания безопасной среды является запуск виртуальной машины. Виртуальная машина — это процесс, выглядящий как отдельная ОС и работающий в реальной операционной системе, которая предоставляет ему необходимые системные ресурсы. Безопасность достигается в том, что если сервер, запущенный внутри виртуальной машины, будет взломан, то будет затронут только виртуальный сервер, а не родительская установка. </para>
                <para>Для дальнейшей информации по установке пользовательского режима Linux, обратитесь к <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/doc/ru/uml.xml?style=printable">руководству по пользовательскому режиму Linux</link>. </para>
            </section>
        </section>
        <section>
            <info>
                <title>Межсетевые экраны</title>
            </info>
            <section>
                <info>
                    <title>Межсетевой экран</title>
                </info>
                <para>Люди часто думают, что межсетевой экран окончательно защитит их систему, но они ошибаются. В большинстве случаев плохо настроенный межсетевой экран предоставляет еще меньше безопасен, чем его отсутствие. Он тоже является программой, и с ним нужно обращаться так же, как и с остальными программами, так как он может содержать уязвимости. </para>
                <para>А теперь подумайте перед реализацией межсетевого экрана! Так ли он вам нужен? Если да, то вам нужно написать правила, определяющие его работу, тип межсетевого экрана и кто должен им управлять. Но сначала прочитайте это руководство. </para>
                <para>Межсетевые экраны используются для двух целей: </para>
                <itemizedlist>
                    <listitem>
                        <para>Для защиты извне (черви/злоумышленники) </para>
                    </listitem>
                    <listitem>
                        <para>Для защиты изнутри (сотрудники/дети) </para>
                    </listitem>
                </itemizedlist>
                <para>В основном есть три типа межсетевых экранов: </para>
                <itemizedlist>
                    <listitem>
                        <para>Фильтрование пакетов </para>
                    </listitem>
                    <listitem>
                        <para>Прокси </para>
                    </listitem>
                    <listitem>
                        <para>Программный шлюз </para>
                    </listitem>
                </itemizedlist>
                <para>Межсетевой экран должен работать на выделенном компьютере без лишних запущенных сервисов (или же только с sshd) и обезопасен такими способами, которые описаны в этом руководстве. </para>
            </section>
            <section>
                <info>
                    <title>Фильтрование пакетов</title>
                </info>
                <para>Весь сетевой трафик передается в виде пакетов. Непрерывный поток разделяется на маленькие, легко управляемые пакеты, которые собираются в точке назначения. В заголовке каждого пакета содержится информация о способе и месте его назначения. Также эта информация используется работы межсетевого экрана. Фильтрация основана на: </para>
                <itemizedlist>
                    <listitem>
                        <para>разрешении или запрещении пакетов на основании IP-адреса отправителя/получателя </para>
                    </listitem>
                    <listitem>
                        <para>разрешении или запрещении пакетов на основании порта отправителя/получателя </para>
                    </listitem>
                    <listitem>
                        <para>разрешении или запрещении пакетов на основании протокола </para>
                    </listitem>
                    <listitem>
                        <para>разрешении или запрещении пакетов на основании параметров, специфичных для каждого из протоколов </para>
                    </listitem>
                </itemizedlist>
                <para>Другими словами, фильтрация основана на содержимом заголовка пакета, а не самого пакета. </para>
                <para>Недостатки: </para>
                <itemizedlist>
                    <listitem>
                        <para>адрес в пакете может быть ненастоящим адресом IP (или подделанным отправителем) </para>
                    </listitem>
                    <listitem>
                        <para>данные или запросы в пропущенном пакете могут содержать непредвиденные данные, которые злоумышленник может использовать для эксплуатации известных уязвимостей в сервисах, расположенным на межсетевом экране или позади него </para>
                    </listitem>
                    <listitem>
                        <para>критично к сбоям </para>
                    </listitem>
                </itemizedlist>
                <para>Преимущества: </para>
                <itemizedlist>
                    <listitem>
                        <para>простая реализация </para>
                    </listitem>
                    <listitem>
                        <para>возможность отправки предупреждений о возможных атаках до того, как они произойдут (то есть регистрация сканирования портов) </para>
                    </listitem>
                    <listitem>
                        <para>хорош против предотвращения SYN-атак </para>
                    </listitem>
                </itemizedlist>
                <para>Вот примеры свободных фильтров пакетов для Linux: </para>
                <orderedlist>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.iptables.org/">Iptables</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.linuxdocs.org/HOWTOs/IPCHAINS-HOWTO.html">Ipchains</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.smoothwall.org/">SmoothWall</link>
                        </para>
                    </listitem>
                </orderedlist>
                <note>
                    <para>Рекомендуется использовать iptables. ipchains устарел. </para>
                </note>
            </section>
            <section>
                <info>
                    <title>Прокси</title>
                </info>
                <para>Шлюз сеансового уровня является межсетевым экраном, проверяющим соединения перед разрешением обмена данных. Это значит, что он не только разрешает или запрещает пересылку пакетов на основании их заголовка, но и определяет перед открытием сессии на основании настраиваемых правил, что оба адресата реально существуют. Фильтрация основывается на: </para>
                <itemizedlist>
                    <listitem>
                        <para>IP-адресе отправителя/получателя </para>
                    </listitem>
                    <listitem>
                        <para>порте отправителя/получателя </para>
                    </listitem>
                    <listitem>
                        <para>времени </para>
                    </listitem>
                    <listitem>
                        <para>протоколе </para>
                    </listitem>
                    <listitem>
                        <para>пользователе </para>
                    </listitem>
                    <listitem>
                        <para>пароле </para>
                    </listitem>
                </itemizedlist>
                <para>Весь трафик прослушивается и проверяется, и непрошенный трафик может быть отброшен. </para>
                <para>Недостатки: </para>
                <itemizedlist>
                    <listitem>
                        <para>Взаимодействует на транспортном уровне и может потребовать изменения программ, предоставляющих транспортные функции. </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <info>
                    <title>Программный шлюз</title>
                </info>
                <para>Шлюзы уровня приложений являются прокси-серверами для приложений, обменивающимися вместо клиентов данными с удаленными системами. Это позволяет находиться вне доступа извне за ДМЗ (демилитаризованной зоной, частью частной сети, видимой сквозь межсетевой экран) или разрешать межсетевому экрану предотвращать соединения извне. Фильтрация основывается на: </para>
                <itemizedlist>
                    <listitem>
                        <para>разрешении или запрещении на основании IP-адреса источника/назначения </para>
                    </listitem>
                    <listitem>
                        <para>на содержимом пакетов </para>
                    </listitem>
                    <listitem>
                        <para>ограничения доступа к файлу на основе типа файла и расширения </para>
                    </listitem>
                </itemizedlist>
                <para>Преимущества: </para>
                <itemizedlist>
                    <listitem>
                        <para>Может кэшировать файлы, увеличивая производительность сети </para>
                    </listitem>
                    <listitem>
                        <para>Детализированная регистрация всех подключений </para>
                    </listitem>
                    <listitem>
                        <para>Хорошая расширяемость (некотрые прокси могут распределять кэшированные данные между собой) </para>
                    </listitem>
                    <listitem>
                        <para>Нет прямого доступа извне </para>
                    </listitem>
                    <listitem>
                        <para>Может изменять содержимое пакета на лету </para>
                    </listitem>
                </itemizedlist>
                <para>Недостатки: </para>
                <itemizedlist>
                    <listitem>
                        <para>Конфигурация является комплексной </para>
                    </listitem>
                </itemizedlist>
                <para>Программные шлюзы принято считать наиболее безопасным решением, так как они не запускаются с правами администратора, и все узлы за ними будут недоступными из интернета. </para>
                <para>Пример свободного шлюза: </para>
                <itemizedlist>
                    <listitem>
                        <para>
                            <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.squid-cache.org/">Squid</link>
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <info>
                    <title>Iptables</title>
                </info>
                <para>Для нормального функционирования iptables должен быть включен в ядро. Я включил поддержку iptables модулей (команда <command>iptables</command> загрузит их по мере необходимости) и пересобрал ядро (но вы можете включить их в само ядро, если намереваетесь отказаться от загружаемых модулей ядра, как сказано выше). Для более детальной информации по настройке iptables в ядре обратитесь к странице <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://iptables-tutorial.frozentux.net/iptables-tutorial.html#PREPARATIONS">Iptables Tutorial Chapter 5: Preparations</link>. После пересборки нового ядра (или во время компиляции) вы должны добавить команду <command>iptables</command>. Для этого просто наберите <command>emerge iptables</command>.</para>
                <para>Теперь проверим свою работу, запустив <command>iptables -L</command>. Если команда завершилась ошибкой, значит, что-то не так, поэтому проверьте еще раз настройки. </para>
                <para>iptables — новый и весьма улучшенный межсетевой экран в ядрах Linux 2.4.x. Он является наследником ipchains для ядер Linux 2.2.x. Одним из значительных нововведений является то, что iptables способен совершать полноценную фильтрацию пакетов. С ее помощью стало возможным следить за каждым установленным TCP-соединением. </para>
                <para>TCP-соединение содержит в себе серию пакетов, содержащих информацию IP-адресе и порте отправителя и получателя, а также последовательное число, поэтому пакеты могут быть воссозданы без потери данных. TCP является протоколом, ориентированном на подключение, в отличии от UDP, который не гарантирует доставку. </para>
                <para>Изучая заголовок TCP-пакета, межсетевой экран может может определить, является ли полученный пакет частью уже установленного соединения или нет, и принять решение, принять или отбросить этот пакет. </para>
                <para>При использовании межсетевого экрана, не отслеживающего соединения, возможно провести его и заставить с помощью манипулирования заголовками TCP-пакета принимать пакеты, которые необходимо отбросить. Это может быть сделано с помощью установки SYN или других флагов заголовка TCP и создания поддельного пакета, который будет считаться частью уже установленного соединения (ведь межсетевой экран не будет отслеживать состояние соединения). При использовании фильтрации пакетов, отслеживающих соединения, можно отбрасывать подобные пакеты, если они не являются частью уже установленного соединения. Это также предотвратит «stealth-сканирование», разновидности сканирования, с помощью которого сканер отправляет пакеты с такой комбинацией флагов, при которых они не будут зарегистрированы межсетевым экраном, полагающим, что это — обычные SYN-пакеты. </para>
                <para>В iptables также есть различные возможности, как например NAT (Network Address Translation, сетевая трансляция адресов) и ограничения по частоте. Ограничение по частоте весьма полезна для предотвращения DoS-атак (Denial of Service, отказ от обслуживания), например SYN-наводнений. </para>
                <para>TCP-соединения устанавливаются после так называемого троекратного рукопожатия. При установлении TCP-соединения клиент отправляет серверу пакет с установленным флагом SYN. При получении сервер возвращает клиенту пакет с установленными SYN+ACK. При его получении клиент отвечает третьим пакетом с ACK для подтверждения соединения. </para>
                <para>SYN-наводнения основаны на отправке SYN-пакетов с одновременным запретом отправки пакетов SYN+ACK. Клиент может создать пакет с поддельным IP-адресом отправителя, так как ему не нужно на что-либо отвечать. Сервер заполнит очередь подключений полуоткрытыми соединениями, ожидающими окончательного пакета с ACK, до того, как удалит их из очереди. Очередь ограничена определенным числом, и когда она заполнится, то станет невозможным принимать новые подключения. Если пакет с ACK не будет получен по истечении определенного временного интервала, то он будет автоматически удален из очереди. Настройки таймаута могут быть различными, но обычно они находятся в пределах 30—60 секунд или даже больше. Клиент инициирует атаку, создавая множество SYN-пакетов с различных IP-адресов и отправляя их на адрес цели как можно чаще, заполняя тем самым очередь полуоткрытыми соединениями и не позволяя другим клиентам устанавливать легитимные подключения к серверу. </para>
                <para>В данном случае может быть полезным ограничение отправки. Можно ограничить частоту отправки принятых SYN-пакетов с помощью <command>-m limit --limit 1/s</command>, тем самым ограничив число SYN-пакетов до одного в секунду и оградив свои ресурсы от SYN-наводнений. </para>
                <note>
                    <para>Другим решением, предотвращающим SYN-наводнения является использование <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://cr.yp.to/syncookies.html">SYN cookies</link>, которые позволят вашему компьютеру отвечать на SYN-пакеты без заполнения очереди подключений. SYN cookies могут быть включены при конфигурировании ядра Linux, однако на данный момент эта поддержка считается экспериментальной. </para>
                </note>
                <para>А теперь немного практических занятий! </para>
                <para>Будучи загруженным в ядро, iptables предоставляет 5 ловушек, в которые вы можете поместить свои правила. Они называются INPUT, OUTPUT, FORWARD, PREROUTING и POSTROUTING. Каждая из них называется цепочкой и содержит список правил. Каждое правило описывает, что если заголовок пакета выглядит как образец, то делать с этим пакетом нужно то-то и то-то. Если правило не подходит под пакет, то пакет переходит к следующему правилу в цепочке. </para>
                <para>Вы можете поместить правила в 5 цепочках напрямую или создать новые цепочки и добавлять в них правила таким же способом, как и в обычную цепочку. Iptables поддерживает следующие параметры. </para>
                <informaltable frame="all">
                    <tgroup cols="2">
                        <thead>
                            <row>
                                <entry>Параметр:</entry>
                                <entry>Описание:</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>-A</entry>
                                <entry>Добавление</entry>
                            </row>
                            <row>
                                <entry>-D</entry>
                                <entry>Удаление</entry>
                            </row>
                            <row>
                                <entry>-I</entry>
                                <entry>Вставка</entry>
                            </row>
                            <row>
                                <entry>-R</entry>
                                <entry>Замена</entry>
                            </row>
                            <row>
                                <entry>-L</entry>
                                <entry>Просмотр</entry>
                            </row>
                            <row>
                                <entry>-F</entry>
                                <entry>Удалить все правила в цепочке или все цепочки</entry>
                            </row>
                            <row>
                                <entry>-Z</entry>
                                <entry>Обнулить счетчики во всех цепочках</entry>
                            </row>
                            <row>
                                <entry>-C</entry>
                                <entry>Проверить этот пакет в цепочке</entry>
                            </row>
                            <row>
                                <entry>-N</entry>
                                <entry>Создать новую пользовательскую цепочку</entry>
                            </row>
                            <row>
                                <entry>-X</entry>
                                <entry>Удалить пользовательскую цепочку</entry>
                            </row>
                            <row>
                                <entry>-P</entry>
                                <entry>Изменить политику цепочки для цели</entry>
                            </row>
                            <row>
                                <entry>-E</entry>
                                <entry>Изменить имя цепочки</entry>
                            </row>
                            <row>
                                <entry>-p</entry>
                                <entry>протоколе</entry>
                            </row>
                            <row>
                                <entry>-s</entry>
                                <entry>Адрес/маска источника</entry>
                            </row>
                            <row>
                                <entry>-d</entry>
                                <entry>Адрес/маска назначения</entry>
                            </row>
                            <row>
                                <entry>-i</entry>
                                <entry>Входящее имя (имя ethernet)</entry>
                            </row>
                            <row>
                                <entry>-o</entry>
                                <entry>Исходящее имя (имя ethernet)</entry>
                            </row>
                            <row>
                                <entry>-j</entry>
                                <entry>Перейти (цель для правила)</entry>
                            </row>
                            <row>
                                <entry>-m</entry>
                                <entry>Расширенные сравнения (могут использовать внешние расширения)</entry>
                            </row>
                            <row>
                                <entry>-n</entry>
                                <entry>Числовой вывод адресов и портов</entry>
                            </row>
                            <row>
                                <entry>-t</entry>
                                <entry>Таблица для обработки</entry>
                            </row>
                            <row>
                                <entry>-v</entry>
                                <entry>Расширенный режим</entry>
                            </row>
                            <row>
                                <entry>-x</entry>
                                <entry>Расширить числа (вывести все значения)</entry>
                            </row>
                            <row>
                                <entry>-f</entry>
                                <entry>Проверять только второй и последующие фрагменты</entry>
                            </row>
                            <row>
                                <entry>-V</entry>
                                <entry>Версия пакета</entry>
                            </row>
                            <row>
                                <entry>--line-numbers</entry>
                                <entry>Указывать номера строк при выводе</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>Сначала попробуем заблокировать все ICMP-пакеты, идущие на наш компьютер, просто для того, чтобы познакомиться с iptables поближе. </para>
                <example>
                    <title>Блокировка всех пакетов ICMP</title>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -p icmp -j DROP</userinput></screen>
                </example>
                <para>Сначала мы указываем цепочку, в которую хотим поместить правило, затем протокол проверяемого пакета и в конце цель. Цель может быть именем пользовательской цепочки или одной из специальных целей — <code>ACCEPT</code>, <code>DROP</code>, <code>REJECT</code>, <code>LOG</code>, <code>QUEUE</code> или <code>MASQUERADE</code>. В случае, если мы укажем DROP, то пакет будет отброшен без уведомления клиента. </para>
                <note>
                    <para><code>LOG</code> является «необрывающей» целью. Если пакет подпадает под правило с целью <code>LOG</code>, то он будет передан следующему правилу в цепочке, а не обработан только этим правилом. Это позволяет регистрировать пакеты и при этом их обрабатывать. </para>
                </note>
                <para>Теперь попробуйте выполнить <command>ping localhost</command>. Вы не должны получить ответа, так как iptables будет отбрасывать все входящие ICMP-сообщения. Вы также не сможете проверить и другие компьютеры, так как ответные ICMP-пакеты тоже будут отбрасываться. А теперь, чтобы вновь получать ICMP, очистим цепочку. </para>
                <example>
                    <title>Сбросить все правила</title>
                    <screen><prompt>#</prompt> <userinput>iptables -F</userinput></screen>
                </example>
                <para>Теперь взглянем на полноценную фильтрацию пакетов с помощью iptables. Если нужно полноценное исследование входящих пакетов на интерфейсе eth0, то выполним следующую команду: </para>
                <example>
                    <title>Принимать пакеты от уже установленных соединений</title>
                    <screen><prompt>#</prompt> <userinput>iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT</userinput></screen>
                </example>
                <para>Это разрешит принимать любой пакет из уже установленного соединения или связанного в цепочке INPUT. Вы можете отбросить любой пакет, не соответствующий состоянию таблицы, выполнив команду iptables -A INPUT -i eth0 -m state --state INVALID -j DROP сразу же после предыдущей. Эта команда включит фильтрацию пакетов на основании состояния, подключив внешнее расширение «state». Если вам необходимо разрешить подключаться клиентам к компьютеру, то вы можете использовать флаг --state NEW. Iptables содержит несколько модулей различного назначения. Вот некоторые из них: </para>
                <informaltable frame="all">
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>Модуль/сравнение</entry>
                                <entry>Описание</entry>
                                <entry>Расширенные параметры</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>mac</entry>
                                <entry>Расширение для проверки MAC-адресов входящих пакетов.</entry>
                                <entry>--mac-source</entry>
                            </row>
                            <row>
                                <entry>state</entry>
                                <entry>Включение проверки состояния соединения</entry>
                                <entry>--state (состоянием может быть ESTABLISHED,RELATED, INVALID, NEW)</entry>
                            </row>
                            <row>
                                <entry>limit</entry>
                                <entry>Частотное ограничение</entry>
                                <entry>--limit, --limit-burst</entry>
                            </row>
                            <row>
                                <entry>owner</entry>
                                <entry>Попытка проверить различные характеристики создателя пакета</entry>
                                <entry>
                                    <para>--uid-owner userid --gid-owner groupid --pid-owner processid --sid-owner sessionid</para>
                                </entry>
                            </row>
                            <row>
                                <entry>unclean</entry>
                                <entry>Различные случайны проверки пакетов на правильность</entry>
                                <entry/>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>Теперь попробуем создать пользовательскую цепочку и применить ее для одного из существующих: </para>
                <example>
                    <title>Создание пользовательской цепочки</title>
                    <screen><lineannotation>(Создаем новую цепочку с одним правилом)</lineannotation>
<prompt>#</prompt> <userinput>iptables -X mychain</userinput>
<prompt>#</prompt> <userinput>iptables -N mychain</userinput>
<prompt>#</prompt> <userinput>iptables -A mychain -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT</userinput>
<lineannotation>(Разрешающая политика по умолчанию для всего исходящего трафика. Входящий будет отброшен.)</lineannotation>
<prompt>#</prompt> <userinput>iptables -P OUTPUT ACCEPT</userinput>
<prompt>#</prompt> <userinput>iptables -P INPUT DROP</userinput>
<lineannotation>(И добавление ее в цепочку INPUT)</lineannotation>
<prompt>#</prompt> <userinput>iptables -A INPUT -j mychain</userinput></screen>
                </example>
                <para>Применив правило к входящей цепочке, мы получим следующую политику: все исходящие пакеты будут пропущены, а все входящие — отброшены. </para>
                <para>Документация может быть найдена по адресу <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.iptables.org/documentation/index.html#HOWTO">Netfilter/iptables documentation</link>. </para>
                <para>Теперь взглянем на полный пример. Мои правила для межсетевого экрана/шлюза будут следующими: </para>
                <itemizedlist>
                    <listitem>
                        <para>Подключения к межсетевому экрану разрешены только через SSH (порт 22) </para>
                    </listitem>
                    <listitem>
                        <para>Локальная сеть должна иметь доступ к HTTP, HTTPS и SSH (также должен быть разрешен DNS) </para>
                    </listitem>
                    <listitem>
                        <para>ICMP может содержать постороннюю информацию и не должен быть разрешен. Конечно же, мы разрешаем некоторые ICMP-сообщения. </para>
                    </listitem>
                    <listitem>
                        <para>Сканирование портов должно быть определено и зарегистрировано </para>
                    </listitem>
                    <listitem>
                        <para>SYN-атаки должны быть пресечены </para>
                    </listitem>
                    <listitem>
                        <para>Весь остальной трафик должен быть отброшен и запротоколирован </para>
                    </listitem>
                </itemizedlist>
                <example>
                    <title><filename>/etc/init.d/firewall</filename></title>
                    <programlisting>#!/sbin/runscript
IPTABLES=/sbin/iptables
IPTABLESSAVE=/sbin/iptables-save
IPTABLESRESTORE=/sbin/iptables-restore
FIREWALL=/etc/firewall.rules
DNS1=212.242.40.3
DNS2=212.242.40.51
#inside
IIP=10.0.0.2
IINTERFACE=eth0
LOCAL_NETWORK=10.0.0.0/24
#outside
OIP=217.157.156.144
OINTERFACE=eth1

opts="${opts} showstatus panic save restore showoptions rules"

depend() {
  need net
}

rules() {
  stop
  ebegin "Setting internal rules"

  einfo "Setting default rule to drop"
  $IPTABLES -P FORWARD DROP
  $IPTABLES -P INPUT   DROP
  $IPTABLES -P OUTPUT  DROP

  #default rule
  einfo "Creating states chain"
  $IPTABLES -N allowed-connection
  $IPTABLES -F allowed-connection
  $IPTABLES -A allowed-connection -m state --state ESTABLISHED,RELATED -j ACCEPT
  $IPTABLES -A allowed-connection -i $IINTERFACE -m limit -j LOG --log-prefix \
      "Bad packet from ${IINTERFACE}:"
  $IPTABLES -A allowed-connection -j DROP

  #ICMP traffic
  einfo "Creating icmp chain"
  $IPTABLES -N icmp_allowed
  $IPTABLES -F icmp_allowed
  $IPTABLES -A icmp_allowed -m state --state NEW -p icmp --icmp-type \
      time-exceeded -j ACCEPT
  $IPTABLES -A icmp_allowed -m state --state NEW -p icmp --icmp-type \
      destination-unreachable -j ACCEPT
  $IPTABLES -A icmp_allowed -p icmp -j LOG --log-prefix "Bad ICMP traffic:"
  $IPTABLES -A icmp_allowed -p icmp -j DROP

  #Incoming traffic
  einfo "Creating incoming ssh traffic chain"
  $IPTABLES -N allow-ssh-traffic-in
  $IPTABLES -F allow-ssh-traffic-in
  #Flood protection
  $IPTABLES -A allow-ssh-traffic-in -m limit --limit 1/second -p tcp --tcp-flags \
      ALL RST --dport ssh -j ACCEPT
  $IPTABLES -A allow-ssh-traffic-in -m limit --limit 1/second -p tcp --tcp-flags \
      ALL FIN --dport ssh -j ACCEPT
  $IPTABLES -A allow-ssh-traffic-in -m limit --limit 1/second -p tcp --tcp-flags \
      ALL SYN --dport ssh -j ACCEPT
  $IPTABLES -A allow-ssh-traffic-in -m state --state RELATED,ESTABLISHED -p tcp --dport ssh -j ACCEPT

  #outgoing traffic
  einfo "Creating outgoing ssh traffic chain"
  $IPTABLES -N allow-ssh-traffic-out
  $IPTABLES -F allow-ssh-traffic-out
  $IPTABLES -A allow-ssh-traffic-out -p tcp --dport ssh -j ACCEPT

  einfo "Creating outgoing dns traffic chain"
  $IPTABLES -N allow-dns-traffic-out
  $IPTABLES -F allow-dns-traffic-out
  $IPTABLES -A allow-dns-traffic-out -p udp -d $DNS1 --dport domain \
      -j ACCEPT
  $IPTABLES -A allow-dns-traffic-out -p udp -d $DNS2 --dport domain \
     -j ACCEPT

  einfo "Creating outgoing http/https traffic chain"
  $IPTABLES -N allow-www-traffic-out
  $IPTABLES -F allow-www-traffic-out
  $IPTABLES -A allow-www-traffic-out -p tcp --dport www -j ACCEPT
  $IPTABLES -A allow-www-traffic-out -p tcp --dport https -j ACCEPT

  #Catch portscanners
  einfo "Creating portscan detection chain"
  $IPTABLES -N check-flags
  $IPTABLES -F check-flags
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL FIN,URG,PSH -m limit \
      --limit 5/minute -j LOG --log-level alert --log-prefix "NMAP-XMAS:"
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL ALL -m limit --limit \
      5/minute -j LOG --log-level 1 --log-prefix "XMAS:"
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL ALL -j DROP
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG \
      -m limit --limit 5/minute -j LOG --log-level 1 --log-prefix "XMAS-PSH:"
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL NONE -m limit \
      --limit 5/minute -j LOG --log-level 1 --log-prefix "NULL_SCAN:"
  $IPTABLES -A check-flags -p tcp --tcp-flags ALL NONE -j DROP
  $IPTABLES -A check-flags -p tcp --tcp-flags SYN,RST SYN,RST -m limit \
      --limit 5/minute -j LOG --log-level 5 --log-prefix "SYN/RST:"
  $IPTABLES -A check-flags -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
  $IPTABLES -A check-flags -p tcp --tcp-flags SYN,FIN SYN,FIN -m limit \
      --limit 5/minute -j LOG --log-level 5 --log-prefix "SYN/FIN:"
  $IPTABLES -A check-flags -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP

  # Apply and add invalid states to the chains
  einfo "Applying chains to INPUT"
  $IPTABLES -A INPUT -m state --state INVALID -j DROP
  $IPTABLES -A INPUT -p icmp -j icmp_allowed
  $IPTABLES -A INPUT -j check-flags
  $IPTABLES -A INPUT -i lo -j ACCEPT
  $IPTABLES -A INPUT -j allow-ssh-traffic-in
  $IPTABLES -A INPUT -j allowed-connection

  einfo "Applying chains to FORWARD"
  $IPTABLES -A FORWARD -m state --state INVALID -j DROP
  $IPTABLES -A FORWARD -p icmp -j icmp_allowed
  $IPTABLES -A FORWARD -j check-flags
  $IPTABLES -A FORWARD -o lo -j ACCEPT
  $IPTABLES -A FORWARD -j allow-ssh-traffic-in
  $IPTABLES -A FORWARD -j allow-www-traffic-out
  $IPTABLES -A FORWARD -j allowed-connection

  einfo "Applying chains to OUTPUT"
  $IPTABLES -A OUTPUT -m state --state INVALID -j DROP
  $IPTABLES -A OUTPUT -p icmp -j icmp_allowed
  $IPTABLES -A OUTPUT -j check-flags
  $IPTABLES -A OUTPUT -o lo -j ACCEPT
  $IPTABLES -A OUTPUT -j allow-ssh-traffic-out
  $IPTABLES -A OUTPUT -j allow-dns-traffic-out
  $IPTABLES -A OUTPUT -j allow-www-traffic-out
  $IPTABLES -A OUTPUT -j allowed-connection

  #Allow client to route through via NAT (Network Address Translation)
  $IPTABLES -t nat -A POSTROUTING -o $OINTERFACE -j MASQUERADE
  eend $?
}

start() {
  ebegin "Starting firewall"
  if [ -e "${FIREWALL}" ]; then
    restore
  else
    einfo "${FIREWALL} does not exists. Using default rules."
    rules
  fi
  eend $?
}

stop() {
  ebegin "Stopping firewall"
  $IPTABLES -F
  $IPTABLES -t nat -F
  $IPTABLES -X
  $IPTABLES -P FORWARD ACCEPT
  $IPTABLES -P INPUT   ACCEPT
  $IPTABLES -P OUTPUT  ACCEPT
  eend $?
}

showstatus() {
  ebegin "Status"
  $IPTABLES -L -n -v --line-numbers
  einfo "NAT status"
  $IPTABLES -L -n -v --line-numbers -t nat
  eend $?
}

panic() {
  ebegin "Setting panic rules"
  $IPTABLES -F
  $IPTABLES -X
  $IPTABLES -t nat -F
  $IPTABLES -P FORWARD DROP
  $IPTABLES -P INPUT   DROP
  $IPTABLES -P OUTPUT  DROP
  $IPTABLES -A INPUT -i lo -j ACCEPT
  $IPTABLES -A OUTPUT -o lo -j ACCEPT
  eend $?
}

save() {
  ebegin "Saving Firewall rules"
  $IPTABLESSAVE > $FIREWALL
  eend $?
}

restore() {
  ebegin "Restoring Firewall rules"
  $IPTABLESRESTORE &lt; $FIREWALL
  eend $?
}

restart() {
  svc_stop; svc_start
}

showoptions() {
  echo "Usage: $0 {start|save|restore|panic|stop|restart|showstatus}"
  echo "start)      will restore setting if exists else force rules"
  echo "stop)       delete all rules and set all to accept"
  echo "rules)      force settings of new rules"
  echo "save)       will store settings in ${FIREWALL}"
  echo "restore)    will restore settings from ${FIREWALL}"
  echo "showstatus) Shows the status"
}</programlisting>
                </example>
                <para>Вот несколько советов при создании правил для межсетевого экрана: </para>
                <orderedlist>
                    <listitem>
                        <para>Создайте политику межсетевого экрана до того, как ее реализуете </para>
                    </listitem>
                    <listitem>
                        <para>Сделайте ее простой </para>
                    </listitem>
                    <listitem>
                        <para>Знайте принцип работы каждого протокола (прочитайте подходящий <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.ietf.org/">RFC</link>) </para>
                    </listitem>
                    <listitem>
                        <para>Всегда помните, что межсетевой экран — это просто программа, запускаемая с правами администратора. </para>
                    </listitem>
                    <listitem>
                        <para>Проверьте свой межсетевой экран </para>
                    </listitem>
                </orderedlist>
                <para>Если вам кажется, что iptables труден для понимания или нужно слишком много времени для настройки межсетевого экрана, то вы можете попробовать <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.shorewall.net/">Shorewall</link>. Для генерации правил межсетевого экрана он использует iptables, но акцентируется на правилах и не указывает протокол. </para>
            </section>
            <section>
                <info>
                    <title>Squid</title>
                </info>
                <para>Squid является очень хорошим прокси-сервером. Он может фильтровать трафик на основании времени, регулярных выражений в пути/URI, IP-адреса получателя и отправителя, домена, браузера, имени зарегистрированного пользователя, типа MIME и номера порта (протокола). Некоторые возможности не указаны, но трудно перечислить их всех. </para>
                <para>В следующем примере я добавил фильтр баннеров вместо фильтра, основанного на фильтрации порносайтов. По этой причине gentoo.org <emphasis role="italic">не должен быть</emphasis> перечислен в списке порносайтов. И я не собираюсь тратить свое время на поиски хороших сайтов для вас. </para>
                <para>В данном случае, вот мои правила: </para>
                <itemizedlist>
                    <listitem>
                        <para>Веб-серфинг (HTTP/HTTPS) разрешен только в рабочее время (с понедельника по пятницу с 8 до 17 часов и в субботу с 8 до 13 часов), но если служащие остаются, то они должны работать, а не сидеть в интернете. </para>
                    </listitem>
                    <listitem>
                        <para>Скачивание файлов не разрешено (.exe, .com, .arj, .zip, .asf, .avi, .mpg, .mpeg и так далее) </para>
                    </listitem>
                    <listitem>
                        <para>Нам не нужны баннеры, поэтому они будут отфильтрованы и заменены на прозрачный GIF (здесь пригодится ваша креативность!). </para>
                    </listitem>
                    <listitem>
                        <para>Все остальные подключения в/из Интернета запрещены. </para>
                    </listitem>
                </itemizedlist>
                <para>Все это реализуется в 4 простых шага. </para>
                <example>
                    <title><filename>/etc/squid/squid.conf</filename></title>
                    <programlisting># Указываем IP и порт
http_port 10.0.2.1:3128

# Стандартная конфигурация
hierarchy_stoplist cgi-bin ?
acl QUERY urlpath_regex cgi-bin \?
no_cache deny QUERY

# Добавляем основные списки контроля доступа
acl all src 0.0.0.0/0.0.0.0
acl manager proto cache_object
acl localhost src 127.0.0.1/255.255.255.255

# Добавляем тех, кто может пользоваться прокси
acl localnet src 10.0.0.0/255.255.0.0

# Добавляем порты
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl purge method PURGE

# Добавляем список контроля доступа, основанного на регулярных
# выражениях, встречаемых в URL
acl archives urlpath_regex "/etc/squid/files.acl"
acl url_ads url_regex "/etc/squid/banner-ads.acl"

# Добавляем список контроля доступа, основанного на времени и дате
acl restricted_weekdays time MTWHF 8:00-17:00
acl restricted_weekends time A 8:00-13:00

acl CONNECT method CONNECT

# Разрешаем менеджеру подключаться с localhost
http_access allow manager localhost
http_access deny manager

# Разрешать очищать запросы только с localhost
http_access allow purge localhost
http_access deny purge

# Запрещать запросы на неизвестные порты
http_access deny !Safe_ports

# Запрещать подключение к портам, не относящимся к SSL
http_access deny CONNECT !SSL_ports

# Мои собственные правила

# Добавляем страницу, отображаемую на месте
# удаленного баннера
deny_info NOTE_ADS_FILTERED url_ads

# Запрещаем баннеры
http_access deny url_ads

# Запрещаем любые архивы
http_access deny archives

# Ограничиваем доступ в рабочим временем
http_access allow localnet restricted_weekdays
http_access allow localnet restricted_weekends

# Запрещаем все остальное
http_access deny all</programlisting>
                </example>
                <para>Далее перечислим типы запрещенных к скачиванию файлов. Я добавил zip, viv, exe, mp3, rar, ace, avi, mov, mpg, mpeg, au, ra, arj, tar, gz и z файлы. </para>
                <example>
                    <title><filename>/etc/squid/files.acl</filename></title>
                    <programlisting>\.[Zz][Ii][pP]$
\.[Vv][Ii][Vv].*
\.[Ee][Xx][Ee]$
\.[Mm][Pp]3$
\.[Rr][Aa][Rr]$
\.[Aa][Cc][Ee]$
\.[Aa][Ss][Ff]$
\.[Aa][Vv][Ii]$
\.[Mm][Oo][Vv]$
\.[Mm][Pp][Gg]$
\.[Mm][Pp][Ee][Gg]$
\.[Aa][Uu]$
\.[Rr][Aa]$
\.[Aa][Rr][Jj]$
\.[Tt][Aa][Rr]$
\.[Gg][Zz]$
\.[Zz]$</programlisting>
                </example>
                <note>
                    <para>Обратите внимание на [] с заглавными и строчными буквами. Это сделано для того, чтобы никто не смог обмануть наш фильтр, пытаясь скачать файл с расширением AvI вместо avi. </para>
                </note>
                <para>Далее добавим регулярные выражения для определения баннеров. Вы, возможно, будете более изобретательнее меня: </para>
                <example>
                    <title><filename>/etc/squid/banner-ads.acl</filename></title>
                    <programlisting>/adv/.*\.gif$
/[Aa]ds/.*\.gif$
/[Aa]d[Pp]ix/
/[Aa]d[Ss]erver
/[Aa][Dd]/.*\.[GgJj][IiPp][FfGg]$
/[Bb]annerads/
/adbanner.*\.[GgJj][IiPp][FfGg]$
/images/ad/
/reklame/
/RealMedia/ads/.*
^http://www\.submit-it.*
^http://www\.eads.*
^http://ads\.
^http://ad\.
^http://ads02\.
^http://adaver.*\.
^http://adforce\.
adbot\.com
/ads/.*\.gif.*
_ad\..*cgi
/Banners/
/SmartBanner/
/Ads/Media/Images/
^http://static\.wired\.com/advertising/
^http://*\.dejanews\.com/ads/
^http://adfu\.blockstackers\.com/
^http://ads2\.zdnet\.com/adverts
^http://www2\.burstnet\.com/gifs/
^http://www.\.valueclick\.com/cgi-bin/cycle
^http://www\.altavista\.com/av/gifs/ie_horiz\.gif</programlisting>
                </example>
                <para>И в заключении мы хотим, чтобы отображался следующий файл вместо удаленного баннера. Он основан половине HTML-файла с прозрачным GIF-изображением размером 4х4. </para>
                <example>
                    <title><filename>/etc/squid/errors/NOTE_ADS_FILTERED</filename></title>
                    <programlisting>&lt;HTML>
&lt;HEAD>
&lt;META HTTP-EQUIV="REFRESH" CONTENT="0; URL=http://localhost/images/4x4.gif">
&lt;TITLE>ERROR: The requested URL could not be retrieved&lt;/TITLE>
&lt;/HEAD>
&lt;BODY>
&lt;H1>Add filtered!&lt;/H1></programlisting>
                </example>
                <note>
                    <para>Не закрывайте теги &lt;HTML&gt; и &lt;BODY&gt;. Squid сделает это самостоятельно. </para>
                </note>
                <para>Как вы видите, у Squid есть множество возможностей для очень эффективной фильтрации и кэширования. Можно даже использовать альтернативные прокси-сервера Squid для сегментирования очень больших сетей. Приведенная конфигурация подходит для небольшой сети с 1—20 пользователями. </para>
                <para>Однако комбинация межсетевого экрана (iptables) и программного шлюза (Squid), возможно, является наилучшей, особенно если Squid находится где-нибудь в безопасном месте, где никто не может иметь к нему доступ извне. Нам все же стоит позаботиться об атаках изнутри. </para>
                <para>Теперь вам необходимо настроить клиентские браузеры для использования прокси-сервера. Шлюз предотвратит попытки пользователей общаться с внешним миром без использования прокси. </para>
                <note>
                    <para>В Mozilla это может быть сделано через Edit-&gt;Preferences-&gt;Advanced-&gt;Proxies. </para>
                </note>
                <para>Также можно настроить прозрачное использование прокси, указав iptables перенаправлять весь исходящий трафик на вход Squid. Это можно сделать, добавив следующее правило на шлюзе: </para>
                <example>
                    <title>Разрешить проброс портов для нашего прокси-сервера</title>
                    <screen><prompt>#</prompt> <userinput>iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to proxyhost:3128</userinput>
<prompt>#</prompt> <userinput>iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to proxyhost:3128</userinput></screen>
                </example>
                <note>
                    <para>Если прокси-сервер работает на том же узле, что и межсетевой экран (хотя это не рекомендуется, но может понадобится из-за отсутствия свободных компьютеров), то используйте цель <code>REDIRECT</code> вместо <code>DNAT</code> (<code>REDIRECT</code> направит пакеты на localhost). </para>
                </note>
            </section>
            <section>
                <info>
                    <title>Изучено</title>
                </info>
                <para>Мы узнали: </para>
                <orderedlist>
                    <listitem>
                        <para>Межсетевой экран является опасным сам по себе. Плохо настроенный межсетевой экран хуже, чем его отсутствие. </para>
                    </listitem>
                    <listitem>
                        <para>Как установить простой шлюз и прозрачный прокси-сервер. </para>
                    </listitem>
                    <listitem>
                        <para>Залогом хорошей работы межсетевого экрана заключается в знании протоколов, которые вы собираетесь разрешить. </para>
                    </listitem>
                    <listitem>
                        <para>IP-трафик не всегда содержит законные данные, например пакеты ICMP, которые могут содержать вредоносное содержимое. </para>
                    </listitem>
                    <listitem>
                        <para>Как предотвратить SYN-атаку. </para>
                    </listitem>
                    <listitem>
                        <para>Фильтрация HTTP-трафика предотвратит загрузку нежелательных изображений и вирусов. </para>
                    </listitem>
                    <listitem>
                        <para>Сочетание пакетных фильтров и программных шлюзов дает лучший контроль. </para>
                    </listitem>
                </orderedlist>
                <para>Теперь, если вам <emphasis role="italic">действительно</emphasis> это нужно, идите и создайте правила межсетевого экрана, отвечающего вашим требованиям. </para>
            </section>
        </section>
        <section>
            <info>
                <title>Обнаружение вторжения</title>
            </info>
            <section>
                <info>
                    <title>AIDE (Advanced Intrusion Detection Environment)</title>
                </info>
                <para><indexterm>
                        <primary>AIDE</primary>
                    </indexterm>AIDE — это система обнаружения атак, основанная на узле (Host-Based Intrusion Detection System, HIDS), свободная альтернатива Tripwire (если вы уже работали с Tripwire, то не должны испытывать сложности с конфигурационным файлом AIDE). HIDS используется для обнаружения изменений в важных системных файлах настроек и двоичных файлах с помощью сверки уникальных криптографических контрольных сумм, созданных каждого из файлов и сохраненных в надежном месте. Принцип действия таков: заранее сохраненный и достоверный хеш сравнивается с сгенерированным с текущей копии каждого файла, чтобы определить какой из файлов был изменен. HIDS является великолепным решением для регистрации подозрительных изменений в системе, однако для того, чтобы она заработала, нужно приложить небольшие усилия. </para>
                <para>Конфигурационный файл основан на применении регулярных выражений, макросов и правил для файлов и каталогов. Есть следующие макросы: </para>
                <informaltable frame="all">
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>Макрос</entry>
                                <entry>Описание</entry>
                                <entry>Синтаксис</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>ifdef</entry>
                                <entry>если определен</entry>
                                <entry>@@ifdef "name"</entry>
                            </row>
                            <row>
                                <entry>ifndef</entry>
                                <entry>если не определен</entry>
                                <entry>@@ifndef "name"</entry>
                            </row>
                            <row>
                                <entry>define</entry>
                                <entry>определить переменную</entry>
                                <entry>@@define "name" "value"</entry>
                            </row>
                            <row>
                                <entry>undef</entry>
                                <entry>удалить переменную</entry>
                                <entry>@@undef "name"</entry>
                            </row>
                            <row>
                                <entry>ifhost</entry>
                                <entry>если "hostname"</entry>
                                <entry>@@ifhost "hostname"</entry>
                            </row>
                            <row>
                                <entry>ifnhost</entry>
                                <entry>если не "hostname"</entry>
                                <entry>@@ifnhost "hostname"</entry>
                            </row>
                            <row>
                                <entry>endif</entry>
                                <entry>endif должен использоваться каждый раз, когда используется любой из вышеприведенных макросов, за исключением define и undef</entry>
                                <entry>@@endif</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>Если у вас есть много компьютеров с Gentoo и вы хотите использовать на них AIDE, то макросы будут весьма полезными. Но не на всех компьютерах запускаются одни и те же сервисы или есть одни и те же пользователи. </para>
                <para>Теперь необходимо установить флаги проверок для файлов и каталогов. Возможны сочетания прав доступа, свойств файлов и криптографических хешей (контрольных сумм). </para>
                <informaltable frame="all">
                    <tgroup cols="2">
                        <thead>
                            <row>
                                <entry>Флаг</entry>
                                <entry>Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>p</entry>
                                <entry>права доступа</entry>
                            </row>
                            <row>
                                <entry>i</entry>
                                <entry>inode</entry>
                            </row>
                            <row>
                                <entry>n</entry>
                                <entry>количество ссылок</entry>
                            </row>
                            <row>
                                <entry>u</entry>
                                <entry>пользователь</entry>
                            </row>
                            <row>
                                <entry>g</entry>
                                <entry>группа</entry>
                            </row>
                            <row>
                                <entry>s</entry>
                                <entry>размер</entry>
                            </row>
                            <row>
                                <entry>b</entry>
                                <entry>число блоков</entry>
                            </row>
                            <row>
                                <entry>m</entry>
                                <entry>время последней модификации</entry>
                            </row>
                            <row>
                                <entry>a</entry>
                                <entry>время последнего доступа</entry>
                            </row>
                            <row>
                                <entry>c</entry>
                                <entry>время изменения</entry>
                            </row>
                            <row>
                                <entry>S</entry>
                                <entry>проверка растущего размера</entry>
                            </row>
                            <row>
                                <entry>md5</entry>
                                <entry>контрольная сумма MD5</entry>
                            </row>
                            <row>
                                <entry>sha1</entry>
                                <entry>контрольная сумма SHA1</entry>
                            </row>
                            <row>
                                <entry>rmd160</entry>
                                <entry>контрольная сумма RMD160</entry>
                            </row>
                            <row>
                                <entry>tiger</entry>
                                <entry>контрольная сумма Tiger</entry>
                            </row>
                            <row>
                                <entry>R</entry>
                                <entry>p+i+n+u+g+s+m+c+md5</entry>
                            </row>
                            <row>
                                <entry>L</entry>
                                <entry>p+i+n+u+g</entry>
                            </row>
                            <row>
                                <entry>E</entry>
                                <entry>Пустая группа</entry>
                            </row>
                            <row>
                                <entry>&gt;</entry>
                                <entry>растущий лог-файл p+u+g+i+n+S</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>А если AIDE собран с поддержкой mhash, то доступны следующие возможности: </para>
                <informaltable frame="all">
                    <tgroup cols="2">
                        <thead>
                            <row>
                                <entry>Флаг</entry>
                                <entry>Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>haval</entry>
                                <entry>контрольная сумма HAVAL</entry>
                            </row>
                            <row>
                                <entry>gost</entry>
                                <entry>контрольная сумма ГОСТ</entry>
                            </row>
                            <row>
                                <entry>crc32</entry>
                                <entry>контрольная сумма CRC32</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>Теперь вы можете создать собственные правила, основанные на сочетании вышеперечисленных флагов, например: </para>
                <example>
                    <title>Создание набора правил для AIDE</title>
                    <programlisting>All=R+a+sha1+rmd160
Norm=s+n+b+md5+sha1+rmd160</programlisting>
                </example>
                <para>И последнее, что нам понадобится для создания собственного конфигурационного файла, — это умение добавлять правило для файла или каталога. Чтобы ввести правило, скомбинируйте файл или каталог с правилом. AIDE добавляет все файлы рекурсивно, если вы не указали обратное в другом правиле. </para>
                <informaltable frame="all">
                    <tgroup cols="2">
                        <thead>
                            <row>
                                <entry>Флаг</entry>
                                <entry>Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>!</entry>
                                <entry>Не добавлять этот файл или каталог.</entry>
                            </row>
                            <row>
                                <entry>=</entry>
                                <entry>Добавлять этот каталог, но не рекурсивно.</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>А теперь взглянем на полный пример: </para>
                <example>
                    <title><filename>/etc/aide/aide.conf</filename></title>
                    <programlisting>@@ifndef TOPDIR
@@define TOPDIR /
@@endif

@@ifndef AIDEDIR
@@define AIDEDIR /etc/aide
@@endif

@@ifhost smbserv
@@define smbactive
@@endif

# Расположение базы данных для чтения.
database=file:@@{AIDEDIR}/aide.db

# Расположение базы данных для записи.
database_out=file:aide.db.new

verbose=20
report_url=stdout

# Определение правил
All=R+a+sha1+rmd160
Norm=s+n+b+md5+sha1+rmd160

@@{TOPDIR} Norm
!@@{TOPDIR}etc/aide
!@@{TOPDIR}dev
!@@{TOPDIR}media
!@@{TOPDIR}mnt
!@@{TOPDIR}proc
!@@{TOPDIR}root
!@@{TOPDIR}sys
!@@{TOPDIR}tmp
!@@{TOPDIR}var/log
!@@{TOPDIR}var/run
!@@{TOPDIR}usr/portage
@@ifdef smbactive
!@@{TOPDIR}etc/smb/private/secrets.tdb
@@endif
=@@{TOPDIR}home Norm</programlisting>
                </example>
                <para>В приведенном примере мы указали некоторые макросы, корневой каталог, с которого будет начинать свою работу AIDE, и каталог, в котором находится AIDE. AIDE сверяется с <filename>/etc/aide/aide.db</filename> при проверке на целостность. Но при обновлении или создании нового файла она сохраняет информацию в <filename>/etc/aide/aide.db.new</filename>. Это делается для того, чтобы не переписать старую базу данных. Параметр <code>report_URL</code> пока не реализован, но, согласно автору, он должен отправлять электронную почту или даже запуск сценариев. </para>
                <para>Теперь по умолчанию пакет AIDE поставляется вместе с рабочим конфигурационным файлом, сценарием-помощником и сценарием планировщика заданий crontab. Сценарий-помощник содержит множество задач для вас и предоставляет более дружественный интерфейс. Чтобы просмотреть все доступные параметры, попробуйте <command>aide --help</command>. Все что вам нужно, чтобы начать, — запустить <command>aide -i</command>, и теперь сценарий crontab должен найти базу данных и ежедневно отправлять отчеты по электронной почте. Рекомендуется все же пересмотреть файл <filename>/etc/aide/aide.conf</filename> и удостовериться, что конфигурация подходит для данного компьютера. </para>
                <note>
                    <para>В зависимости от процессора, скорости чтения диска и установленных для файлов флагов, это может занять много времени. </para>
                </note>
                <note>
                    <para>Не забудьте установить алиасы, чтобы получать почту, адресуемую суперпользователю. Иначе вы никогда не узнаете, что пишет для вас в отчетах AIDE. </para>
                </note>
                <para>Все же есть небольшой риск, заключающийся в том, что злоумышленник может (если узнает об установленном AIDE) изменить локальную базу данных файлов, обновить ее или изменить /usr/bin/aide. Поэтому вы должны создать компакт-диск или иной носитель и сохранить на нем копию файла .db и двоичных файлов AIDE. </para>
                <para>Дополнительную информацию вы можете найти на сайте проекта <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.cs.tut.fi/%7Erammer/aide.html">AIDE</link>
                </para>
            </section>
            <section>
                <info>
                    <title>Snort</title>
                </info>
                <para><indexterm>
                        <primary>Snort</primary>
                    </indexterm>Snort является сетевой системой обнаружения вторжения (Network Intrusion Detection System, NIDS). Чтобы установить и настроить его, воспользуйтесь следующими примерами. </para>
                <example>
                    <title><filename>/etc/conf.d/snort</filename></title>
                    <programlisting>PIDFILE=/var/run/snort_eth0.pid
MODE="full"
NETWORK="10.0.0.0/24"
LOGDIR="/var/log/snort"
CONF=/etc/snort/snort.conf
SNORT_OPTS="-D -s -u snort -dev -l $LOGDIR -h $NETWORK -c $CONF"</programlisting>
                </example>
                <example>
                    <title><filename>/etc/snort/snort.conf</filename></title>
                    <programlisting><lineannotation>(Шаг 1)</lineannotation>
var HOME_NET 10.0.0.0/24
var EXTERNAL_NET any
var SMTP $HOME_NET
var HTTP_SERVERS $HOME_NET
var SQL_SERVERS $HOME_NET
var DNS_SERVERS [10.0.0.2/32,212.242.40.51/32]
var RULE_PATH ./

<lineannotation>(Шаг 2)</lineannotation>
preprocessor frag2
preprocessor stream4: detect_scans detect_state_problems detect_scans disable_evasion_alerts
preprocessor stream4_reassemble: ports all
preprocessor http_decode: 80 8080 unicode iis_alt_unicode double_encode iis_flip_slash full_whitespace
preprocessor rpc_decode: 111 32771
preprocessor bo: -nobrute
preprocessor telnet_decode

<lineannotation>(Шаг 3)</lineannotation>
include classification.config

<lineannotation>(Шаг 4)</lineannotation>
include $RULE_PATH/bad-traffic.rules
include $RULE_PATH/exploit.rules
include $RULE_PATH/scan.rules
include $RULE_PATH/finger.rules
include $RULE_PATH/ftp.rules
include $RULE_PATH/telnet.rules
include $RULE_PATH/smtp.rules
include $RULE_PATH/rpc.rules
include $RULE_PATH/rservices.rules
include $RULE_PATH/dos.rules
include $RULE_PATH/ddos.rules
include $RULE_PATH/dns.rules
include $RULE_PATH/tftp.rules
include $RULE_PATH/web-cgi.rules
include $RULE_PATH/web-coldfusion.rules
include $RULE_PATH/web-iis.rules
include $RULE_PATH/web-frontpage.rules
include $RULE_PATH/web-misc.rules
include $RULE_PATH/web-attacks.rules
include $RULE_PATH/sql.rules
include $RULE_PATH/x11.rules
include $RULE_PATH/icmp.rules
include $RULE_PATH/netbios.rules
include $RULE_PATH/misc.rules
include $RULE_PATH/attack-responses.rules
include $RULE_PATH/backdoor.rules
include $RULE_PATH/shellcode.rules
include $RULE_PATH/policy.rules
include $RULE_PATH/porn.rules
include $RULE_PATH/info.rules
include $RULE_PATH/icmp-info.rules
include $RULE_PATH/virus.rules
# include $RULE_PATH/experimental.rules
include $RULE_PATH/local.rules
</programlisting>
                </example>
                <example>
                    <title>/etc/snort/classification.config</title>
                    <programlisting>config classification: not-suspicious,Not Suspicious Traffic,3
config classification: unknown,Unknown Traffic,3
config classification: bad-unknown,Potentially Bad Traffic, 2
config classification: attempted-recon,Attempted Information Leak,2
config classification: successful-recon-limited,Information Leak,2
config classification: successful-recon-largescale,Large Scale Information Leak,2
config classification: attempted-dos,Attempted Denial of Service,2
config classification: successful-dos,Denial of Service,2
config classification: attempted-user,Attempted User Privilege Gain,1
config classification: unsuccessful-user,Unsuccessful User Privilege Gain,1
config classification: successful-user,Successful User Privilege Gain,1
config classification: attempted-admin,Attempted Administrator Privilege Gain,1
config classification: successful-admin,Successful Administrator Privilege Gain,1

# NEW CLASSIFICATIONS
config classification: rpc-portmap-decode,Decode of an RPC Query,2
config classification: shellcode-detect,Executable code was detected,1
config classification: string-detect,A suspicious string was detected,3
config classification: suspicious-filename-detect,A suspicious filename was detected,2
config classification: suspicious-login,An attempted login using a suspicious username was detected,2
config classification: system-call-detect,A system call was detected,2
config classification: tcp-connection,A TCP connection was detected,4
config classification: trojan-activity,A Network Trojan was detected, 1
config classification: unusual-client-port-connection,A client was using an unusual port,2
config classification: network-scan,Detection of a Network Scan,3
config classification: denial-of-service,Detection of a Denial of Service Attack,2
config classification: non-standard-protocol,Detection of a non-standard protocol or event,2
config classification: protocol-command-decode,Generic Protocol Command Decode,3
config classification: web-application-activity,access to a potentially vulnerable web application,2
config classification: web-application-attack,Web Application Attack,1
config classification: misc-activity,Misc activity,3
config classification: misc-attack,Misc Attack,2
config classification: icmp-event,Generic ICMP event,3
config classification: kickass-porn,SCORE! Get the lotion!,1</programlisting>
                </example>
                <para>Дополнительной информация может быть найдена на сайте <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.snort.org/">Snort</link>. </para>
            </section>
            <section>
                <info>
                    <title>Обнаружение вредоносных программ с помощью chkrootkit</title>
                </info>
                <para>Система HIDS, как AIDE, является лучшим средством для обнаружения изменений в вашей системе, но хуже не будет, если будет установлен еще один рубеж обороны. <command>chkrootkit</command> — это утилита, которая сканирует системные файлы на наличие руткитов — программ, разработанных для сокрытия присутствия взломщика и сохранения доступа к системе, а также на наличие следов кейлоггеров и прочих вредоносных программ. Хотя chkrootkit (и прочие аналоги, например rkhunter) являются полезными утилитами, как контроля за системой, так и для обнаружения следов вторжения, но они не могут гарантировать, что ваша система в безопасности. </para>
                <para>Наилучший способ использовать <command>chkrootkit</command> для обнаружения внедрения — запускать его с помощью cron. Сначала установите <package>app-admin/chkrootkit</package>. <command>chkrootkit</command> может запускаться из командной строки или же с помощью записи в cron следующего вида: </para>
                <example>
                    <title>Назначение задания chrootkit в crontab</title>
                    <programlisting>0 3 * * * /usr/sbin/chkrootkit</programlisting>
                </example>
            </section>
        </section>
        <section>
            <info>
                <title>Регулярные обновления</title>
            </info>
            <section>
                <info>
                    <title>Регулярные обновления</title>
                </info>
                <para>После успешной установки и настройки ее безопасности систему, тем не менее, нельзя называть завершенной. Процесс обеспечения безопасности является постоянным по времени, ведь большинство известных взломов является результатом использования известных уязвимостей в устаревших системах. Постоянное обновление системы — наиболее значимый шаг, который вы можете совершить для обеспечения наилучшей безопасности. </para>
                <para>Если у вас установлена последняя версия portage, то, предварительно обновив дерево с помощью команды <command>emerge --sync</command>, вы можете запустить команду <command>glsa-check --list</command>, которая проверит вашу систему на наличие известных уязвимостей. <command>glsa-check</command> является частью пакета <package>app-portage/gentoolkit</package>. </para>
                <example>
                    <title>Пример вывода glsa-check -l</title>
                    <screen><prompt>#</prompt> <userinput>glsa-check -l</userinput>
WARNING: This tool is completely new and not very tested, so it should not be
used on production systems. It's mainly a test tool for the new GLSA release
and distribution system, it's functionality will later be merged into emerge
and equery.
Please read http://www.gentoo.org/proj/en/portage/glsa-integration.xml
before using this tool AND before reporting a bug.

[A] means this GLSA was already applied,
[U] means the system is not affected and
[N] indicates that the system might be affected.

200406-03 [N] sitecopy: Multiple vulnerabilities in included libneon ( net-misc/sitecopy )
200406-04 [U] Mailman: Member password disclosure vulnerability ( net-mail/mailman )
.......</screen>
                </example>
                <warning>
                    <para>Утилита glsa-check все еще является экспериментальной, поэтому, если вы действительно ставите безопасность превыше всего, то лучше также свериться с другими источниками. </para>
                </warning>
                <para>Все строки, содержащие <code>[A]</code> и <code>[U]</code>, могут быть игнорированы, так как они неприменимы для данной системы. </para>
                <important>
                    <para>Не забывайте, что использование <command>emerge -vpuD world</command> не устанавливает все необходимые обновления пакетов. Используйте <command>glsa-check</command>, если хотите быть уверенным, что все GLSA исправлены в вашей системе. </para>
                </important>
                <example>
                    <title>Проверка всех GLSA</title>
                    <screen><lineannotation>(Подвержена ли ваша система GLSA?)</lineannotation>
<prompt>#</prompt> <userinput>glsa-check -t all</userinput>
WARNING: This tool is completely new and not very tested, so it should not be
used on production systems. It's mainly a test tool for the new GLSA release
and distribution system, it's functionality will later be merged into emerge
and equery.
Please read http://www.gentoo.org/proj/en/portage/glsa-integration.xml
before using this tool AND before reporting a bug.

This system is affected by the following GLSA:
200504-06
200510-08
200506-14
200501-35
200508-12
200507-16

<lineannotation>(Просмотр всех пакетов, подверженных переустановке)</lineannotation>
<prompt>#</prompt> <userinput>glsa-check -p $(glsa-check -t all)</userinput>
     <lineannotation>(частичный вывод)</lineannotation>
Checking GLSA 200504-06
The following updates will be performed for this GLSA:
     app-arch/sharutils-4.2.1-r11 (4.2.1-r10)

     **********************************************************************

     Checking GLSA 200510-08
     The following updates will be performed for this GLSA:
          media-libs/xine-lib-1.1.0-r5 (1.1.0-r4)

<lineannotation>(применение необходимых исправлений)</lineannotation>
<prompt>#</prompt> <userinput>glsa-check -f $(glsa-check -t all)</userinput></screen>
                </example>
                <para>Если вы обновили запущенный сервис, не забудьте перезапустить его. </para>
                <para>Также рекомендуется регулярно <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/doc/ru/kernel-upgrade.xml?style=printable">обновлять ядро</link>. </para>
                <para>Вы можете также подписаться на список рассылки gentoo-announce, чтобы получать уведомления GLSA по электронной почте. Инструкции по подписке могут быть найдены на странице <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/main/ru/lists.xml?style=printable">Введение в почтовые рассылки Gentoo Linux</link>. </para>
                <para>Другим хорошим источником информации по безопасности является <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.securityfocus.com/archive/1">список рассылки Bugtraq</link>. </para>
            </section>
        </section>
    </section>
</article>
