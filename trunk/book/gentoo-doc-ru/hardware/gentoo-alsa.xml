<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbookxi.rng" type="xml"?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="gentoo-alsa">
    <info>
        <title>Руководство Gentoo Linux ALSA</title>
    </info>
    <para>Ссылка на оригинал: <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/doc/ru/alsa-guide.xml">http://www.gentoo.org/doc/ru/alsa-guide.xml</link>
    </para>
    <para>С версии: 1.0</para>
    <para>Обновлено:  1.2</para>
    <section>
        <title>Введение</title>
        <section>
            <title>Что такое ALSA?</title>
            <para>
                <indexterm><primary>ALSA</primary></indexterm><indexterm><primary>Advanced Linux Sound Architecture</primary></indexterm><firstterm>ALSA</firstterm>, или <firstterm>Advanced Linux Sound Architecture</firstterm> — продвинутая звуковая архитектура Linux, позволяет работать аудио и MIDI (Musical Instrument Digital Interface — Цифровой интерфейс музыкальных инструментов) в операционной системе Linux. ALSA является основной звуковой подсистемой в ядрах 2.6, заменяя собой OSS (Open Sound System — Открытая звуковая система), которая использовалась в ядрах 2.4. </para>
            <para>Главные преимущества ALSA включают эффективную поддержку всех типов аудио интерфейсов, начиная от широко распространённых аудио карт и заканчивая профессиональным звуковым оборудованием, полностью модульные драйверы, поддержку многопроцессорных систем и потоковую безопасность, обратную совместимости с OSS, а также пользовательскую библиотеку alsa-lib, делающую разработку приложений лёгкой. </para>
        </section>
        <section>
            <title>ALSA в Gentoo</title>
            <para>Одна из сильных сторон Gentoo заключается в предоставлении пользователю максимального контроля над тем, как система установлена/сконфигурирована. ALSA в Gentoo следует этому принципу. Существуют два способа, с помощью которых вы можете установить и запустить ALSA на вашей системе. Мы подробно рассмотрим их в следующей главе.</para>
        </section>
    </section>
    <section>
        <title>Установка ALSA</title>
        <section>
            <title>Варианты</title>
            <warning>
                <para>Способы, описываемые ниже, являются взаимно исключающими. Вы не можете одновременно собрать ALSA в ядре и установить <package>media-sound/alsa-driver</package>. Это не получится. </para>
            </warning>
            <para>Два варианта установки ALSA драйверов: </para>
            <orderedlist>
                <listitem>
                    <para>Использовать ALSA драйверы, предоставляемые вашим ядром. Этот метод предпочтительный и рекомендуемый. </para>
                </listitem>
                <listitem>
                    <para>Использовать пакет <package>media-sound/alsa-driver</package>. </para>
                </listitem>
            </orderedlist>
            <para>Драйверы, предоставляемые ядром, могут немного отличаться от предоставляемых пакетом <package>alsa-driver</package>; возможности и исправления одного могут оказаться всё ещё не включёнными в другой. Разработчики ALSA осознают ситуацию, но эти два драйвера по существу являются отдельными ветвями проекта ALSA; они не идентичны. Вы должны понимать, что они могут по-разному функционировать, поэтому если один из них у вас не работает, попробуйте другой! Мы бегло рассмотрим оба варианта перед принятием окончательного решения. </para>
            <para>Преимущества и недостатки использования ALSA драйверов, предоставляемых ядром: </para>
            <informaltable frame="none">
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="1*"/>
                    <colspec colname="c2" colnum="2" colwidth="4*"/>
                    <thead>
                        <row>
                            <entry>ALSA в ядре</entry>
                            <entry>за и против</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>+</entry>
                            <entry>Нет необходимости устанавливать ещё один пакет; драйверы включены в ядро</entry>
                        </row>
                        <row>
                            <entry>+</entry>
                            <entry>Единое решение, никаких повторных команд emerge</entry>
                        </row>
                        <row>
                            <entry>-</entry>
                            <entry>Может немного отличаться от <package>alsa-driver</package></entry>
                        </row>
                    </tbody>
                </tgroup>
            </informaltable>
            <para>А если вы выберете alsa-driver, то: </para>
            <informaltable frame="none">
                <tgroup cols="2">
                    <colspec colname="c1" colnum="1" colwidth="1*"/>
                    <colspec colname="c2" colnum="2" colwidth="4*"/>
                    <thead>
                        <row>
                            <entry>Драйверы ALSA</entry>
                            <entry>за и против</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>+</entry>
                            <entry>Самые свежие драйверы от проекта ALSA</entry>
                        </row>
                        <row>
                            <entry>+</entry>
                            <entry>Удобно, если вы собираетесь разрабатывать драйверы для аудио устройств</entry>
                        </row>
                        <row>
                            <entry>-</entry>
                            <entry>Каждая пересборка ядра требует повторной переустановки alsa-driver</entry>
                        </row>
                        <row>
                            <entry>-</entry>
                            <entry>Определённые параметры конфигурации ядра должны быть отключены</entry>
                        </row>
                    </tbody>
                </tgroup>
            </informaltable>
        </section>
        <section>
            <title>Итак...</title>
            <para>Как сказано выше, отличия между драйверами из пакета <package>alsa-driver</package> и ALSA драйверами, поставляемыми с ядром, очень незначительны. Так как между ними нет большой разницы, сначала попробуйте ALSA драйвера, поставляемые ядром, так как их проще использовать. Перед тем как сообщить о любой проблеме, связанной со звуком, в <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://bugs.gentoo.org/">Gentoo Bugzilla</link>, пожалуйста, попробуйте её воспроизвести, используя <package>alsa-driver</package>, и создайте запрос об ошибке вне зависимости от результата.</para>
        </section>
        <section xml:id="gentoo-alsa.lspci">
            <title>Перед тем как вы продолжите</title>
            <para>Вам надо определить какие драйверы использует ваша карта. В большинстве случаев звуковые карты (встроенные и подключаемые) основаны на PCI, и <command>lspci</command> поможет вам раскопать необходимую информацию. Пожалуйста, если вы ещё не установили <command>lspci</command>, установите командой <command>emerge sys-apps/pciutils</command>. Если у вас USB звуковая карта, вам может помочь <command>lsusb</command> из <package>sys-apps/usbutils</package>. Для карт ISA попробуйте <package>sys-apps/isapnptools</package>. Кроме того, следующие ресурсы могут помочь владельцам ISA звуковых карт: </para>
            <orderedlist>
                <listitem>
                    <para>
                        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.roestock.demon.co.uk/isapnptools/">Страница ISAPNPTOOLS</link>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www2.linuxjournal.com/article/3269">Статья о PnP в LinuxJournal</link>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.tldp.org/HOWTO/Sound-HOWTO/x320.html">TLDP Sound HOWTO</link>
                    </para>
                </listitem>
            </orderedlist>
            <note>
                <para>Ради простоты в оставшейся части руководства мы предположим, что у пользователя звуковая карта, основанная на PCI. </para>
            </note>
            <para>Теперь мы попробуем найти информацию о звуковой карте. </para>
            <example>
                <title>Информация о звуковой карте</title>
                <screen><prompt>#</prompt> <userinput>lspci -v | grep -i audio</userinput>
0000:00:0a.0 Multimedia audio controller: Creative Labs SB Live! EMU10k1 (rev 06)</screen>
            </example>
            <para>Теперь мы знаем, что звуковая карта, установленная в компьютере, — Sound Blaster Live!, а производителем является Creative Labs. Зайдём на страницу с <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://bugtrack.alsa-project.org/main/index.php/Matrix:Main">таблицой звуковых карт ALSA</link> и выберем Creative Labs из списка. В результате вы попадёте на страницу, содержащую таблицу продуктов Creative Labs, из которой вы можете узнать, что SB Live! использует модуль emu10k1. Эта та информация, которая нам и нужна. Если вам интересна более подробная информация, то вы можете перейти по ссылке «Details» на страницу, посвящённую emu10k1. </para>
            <para>Если вы намереваетесь использовать MIDI, то перед установкой любых пакетов ALSA необходимо добавить midi к USE-флагам в файле /etc/make.conf. Ниже в руководстве мы продемонстрируем, как <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.midi">настроить MIDI</link>. </para>
        </section>
        <section xml:id="gentoo-alsa.kernel-drivers">
            <title>Использование ALSA драйверов, предоставляемых ядром</title>
            <para>Если вам нравится идти по пути наименьшего сопротивления, то этот способ для вас.</para>
            <note>
                <para>Начиная с выпуска 2005.0, Gentoo Linux в качестве основного ядра использует ядра ветки 2.6. Пожалуйста, удостоверьтесь, что у вас ядро ветки 2.6. Этот способ не применим для ядер ветки 2.4. </para>
            </note>
            <para>А теперь давайте сконфигурируем ядро так, чтобы включить в нём ALSA.</para>
            <important>
                <para>Пользователи <package>genkernel</package> должны запустить <command>genkernel --menuconfig all</command> и следовать инструкциям из раздела <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.listing.kernel_params">Параметры ядра для ALSA</link>.</para>
            </important>
            <example>
                <title>Погружение в исходные коды</title>
                <screen><prompt>#</prompt> <userinput>cd /usr/src/linux</userinput>
<prompt>#</prompt> <userinput>make menuconfig</userinput></screen>
            </example>
            <note>
                <para>В только что приведённом примере предполагалось, что символическая ссылка /usr/src/linux указывает на исходные коды используемого вами ядра. Пожалуйста, перед тем как продолжить, проверьте, что у вас так оно и есть. </para>
            </note>
            <para>Теперь рассмотрим часть параметров конфигурации ядра 2.6, которые гарантируют работоспособность ALSA с нашей звуковой картой. </para>
            <para>Обратите внимание, что во всех примерах мы собираем ALSA модулями. Мы советуем вам поступать так же, так как в дальнейшем это позволит использовать <command>alsaconf</command>, упрощающую настройку звуковой карты. Пожалуйста, не пропустите раздел <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.configure">Настройка</link>. Если вы всё же решаете не использовать модули, удостоверьтесь, что вы соответствующим образом изменили вашу конфигурацию. </para>
            <example xml:id="gentoo-alsa.listing.kernel_params">
                <title>Параметры ядра для ALSA</title>
                <screen>Device Drivers  --->
   Sound  --->

<lineannotation>(Это необходимо включить)</lineannotation>
&lt;M> Sound card support

<lineannotation>(Убедитесь, что OSS отключена)</lineannotation>
Open Sound System   --->
   &lt; > Open Sound System (DEPRECATED)

<lineannotation>(Вернитесь на шаг назад и войдите в раздел ALSA)</lineannotation>
Advanced Linux Sound Architecture  --->
   &lt;M> Advanced Linux Sound Architecture
   (Выберите, если вам нужен MIDI sequencing и routing)
   &lt;M> Sequencer support
   (Поддержка старых /dev/mixer* и /dev/dsp*. Рекомендуется.)
   &lt;M> OSS Mixer API
   &lt;M> OSS PCM (digital audio) API

<lineannotation>(Теперь вы можете выбрать устройства, поддержка которых вам требуется.
Обычно в системе есть только одна звуковая карта. Если у вас их несколько,
включите поддержу для каждой.)</lineannotation>

<lineannotation>(Для тестирования и разработки, обычным пользователям они не требуются,
только если вы знаете, что делаете...)</lineannotation>
Generic devices  --->

<lineannotation>(Для звуковых карт ISA)</lineannotation>
ISA devices   --->
<lineannotation>(Если у вас Gravis, включите этот параметр)</lineannotation>
   &lt;M> Gravis UltraSound Extreme

<lineannotation>(Перейдите на один уровень назад и войдите в раздел PCI-устройств.
Большинство современных звуковых карт являются таковыми)</lineannotation>
PCI devices   --->
   <lineannotation>(Теперь выберем драйвер emu10k1 для нашей карты)</lineannotation>
   &lt;M> Emu10k1 (SB Live!, Audigy, E-mu APS)
   <lineannotation>(Или для карты Intel)</lineannotation>
   &lt;M> Intel/SiS/nVidia/AMD/ALi AC97 Controller
   <lineannotation>(А может у вас карта на чипсете VIA?)</lineannotation>
   &lt;M> VIA 82C686A/B, 8233/8235 AC97 Controller

<lineannotation>(Вернитесь на один уровень назад и, если у вас звуковая карта USB, включите)</lineannotation>
USB Devices   ---></screen>
            </example>
            <para>Теперь параметры вашего ядра установлены, и вы можете пересобрать ядро. Поддержка ALSA для вашей карты будет доступной сразу, после того как вы загрузитесь с новым ядром. Чтобы использовать новое ядро, не забудьте обновить конфигурацию вашего загрузчика. Теперь, чтобы проверить, что всё работает как должно, переходите к разделу <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.alsa-utils">Утилиты ALSA</link>.</para>
        </section>
        <section>
            <title>Использование пакета драйверов ALSA</title>
            <para>Итак, вы решили использовать пакет <package>alsa-driver</package>. Тогда начнём. Нужно выполнить несколько небольших действий для того, чтобы был скомпилирован только необходимый вашей аудио карте драйвер. Хотя это и не требуется, это сократит количество лишних драйверов, которые в противном случае были бы собраны. </para>
            <para>Если вы не знаете, какие драйверы для звуковой карты вам могут понадобиться, ознакомьтесь с разделом, посвящённым <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.lspci">lspci</link> этого руководства. Как только вы узнаете имя драйвера (emu10k1 в нашем примере), добавьте переменную ALSA_CARDS в файл <filename>/etc/make.conf</filename>.</para>
            <example>
                <title>Добавление ALSA_CARDS в <filename>make.conf</filename></title>
                <programlisting><lineannotation>(Для одной звуковой карты)</lineannotation>
ALSA_CARDS="emu10k1"
<lineannotation>(Для нескольких карт разделите имена пробелами)</lineannotation>
ALSA_CARDS="emu10k1 via82xx"</programlisting>
            </example>
            <para>Если вы уже собирали своё ядро и хотите использовать <package>alsa-driver</package>, пожалуйста, удостоверьтесь в следующем, перед тем как продолжить, иначе <package>alsa-driver</package>, скорее всего, не установится. Следующий перечень поможет вам провести проверку.</para>
            <note>
                <para>Пользователи <package>genkernel</package> могут продолжить с <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.listing.install-alsa-driver">установки alsa-driver</link>, так как конфигурация их обновлённого ядра по умолчанию соответствует нижеприведённой. </para>
            </note>
            <orderedlist>
                <listitem>
                    <para><varname>CONFIG_SOUND</varname> включён. (Общая поддержка звука включена)</para>
                </listitem>
                <listitem>
                    <para><varname>CONFIG_SOUND_PRIME</varname> выключен. (Встроенная поддержка OSS отключена) </para>
                </listitem>
                <listitem>
                    <para><varname>CONFIG_SND</varname> выключен. (Встроенная поддержка ALSA отключена) </para>
                </listitem>
                <listitem>
                    <para>Символическая ссылка /usr/src/linux указывает на то ядро, в котором ALSA будет работать. </para>
                </listitem>
            </orderedlist>
            <example>
                <title>Проверки в <filename>.config</filename></title>
                <screen><lineannotation>(Проверяем, что символическая ссылка указывает на нужное ядро.)</lineannotation>
<prompt>#</prompt> <userinput>cd /usr/src/linux</userinput>
<prompt>#</prompt> <userinput>grep SOUND .config</userinput>
<lineannotation>(Первый пункт выполнен)</lineannotation>
CONFIG_SOUND=y
<lineannotation>(Второй пункт выполнен)</lineannotation>
CONFIG_SOUND_PRIME is not set
<prompt>#</prompt> <userinput>grep SND .config</userinput>
<lineannotation>(Третий пункт выполнен)</lineannotation>
CONFIG_SND is not set</screen>
            </example>
            <para>Теперь всё, что вам нужно сделать, это набрать магические слова... нет, не абракадабру. </para>
            <example xml:id="gentoo-alsa.listing.install-alsa-driver">
                <title>Установка <package>alsa-driver</package></title>
                <screen><prompt>#</prompt> <userinput>emerge alsa-driver</userinput></screen>
            </example>
            <important>
                <para>Помните, что вам придётся выполнять emerge alsa-driver каждый раз после (пере)сборки ядра, так как предыдущие драйверы будут удалены. Чтобы упростить эту задачу, вы можете воспользоваться пакетом module-rebuild, который будет вести учёт всем пакетам с модулями ядра и по необходимости пересобирать их. Сначала, чтобы создать список пакетов, выполните module-rebuild populate, а затем после (пере)сборки ядра просто запускайте module-rebuild rebuild, и все внешние модули ядра будут пересобраны.</para>
            </important>
        </section>
    </section>
    <section>
        <title>Настройка/тестирование ALSA</title>
        <section xml:id="gentoo-alsa.alsa-utils">
            <title>Утилиты ALSA</title>
            <para>Пакет <package>alsa-utils</package> составляет неотъемлемую часть ALSA и содержит множество крайне полезных программ, в том числе и сценарий инициализации ALSA. Поэтому мы настоятельно советуем вам установить <package>alsa-utils</package>.</para>
            <example>
                <title>Установка <package>alsa-utils</package></title>
                <screen><prompt>#</prompt> <userinput>emerge alsa-utils</userinput></screen>
            </example>
            <note>
                <para>Eсли вы включили поддержку ALSA в вашем <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.kernel-drivers">ядре</link>, а не собрали её в качестве модулей, пожалуйста, перейдите в раздел <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.initscript">сценарий инициализации ALSA</link>. Всё, что осталось сделать всем остальным, это настроить ALSA. Сделать это очень просто благодаря утилите, входящей в состав <package>alsa-utils</package> — <command>alsaconf</command>.</para>
            </note>
        </section>
        <section xml:id="gentoo-alsa.configure">
            <title>Настройка</title>
            <para>Последние версии <package>udev</package> (&gt;=udev-103) в некоторой степени предоставляют автоматическое конфигурирование вашей аудио карты на уровне ядра. По возможности старайтесь полагаться на автоматическую настройку и позвольте ядру настроить вашу звуковую карту. В противном случае, чтобы настроить карту, используйте <command>alsaconf</command>, как это показано ниже.</para>
            <note>
                <para>Пожалуйста, завершите все программы, которые могут обратиться к звуковой карте во время работы <command>alsaconf</command>.</para>
            </note>
            <para>Чтобы настроить вашу звуковую карту просто наберите <command>alsaconf</command> в командной оболочке с правами root. </para>
            <example>
                <title>Запуск <command>alsaconf</command></title>
                <screen><prompt>#</prompt> <userinput>alsaconf</userinput></screen>
            </example>
            <para>Вы увидите изящный управляемый с помощью меню интерфейс программы, которая автоматически исследует ваши устройства и попробует найти вашу звуковую карту. Вас попросят выбрать вашу звуковую карту из списка. Как только это будет сделано, вас спросят разрешения автоматически сделать необходимые изменения в <filename>/etc/modules.d/alsa</filename>. После этого программа изменит настройки громкости на оптимальный уровень, выполнит <command>update-modules</command> и запустит службу <filename>/etc/init.d/alsasound</filename>. Как только <command>alsaconf</command> завершит работу, вы сможете продолжить с настройки сценария инициализации ALSA.</para>
        </section>
        <section xml:id="gentoo-alsa.initscript">
            <title>Сценарий инициализации ALSA</title>
            <para>Мы почти завершили настройку. Вне зависимости от выбранного вами способа установки ALSA, вам понадобится что-то, что будет загружать модули или инициализировать ALSA и восстанавливать настройки громкости при загрузке системы. Сценарий инициализации ALSA, называемый <command>alsasound</command>, сделает всё это для вас. Добавьте его в загрузочный уровень исполнения.</para>
            <example>
                <title>Добавление ALSA в загрузочный уровень исполнения</title>
                <screen><prompt>#</prompt> <userinput>rc-update add alsasound boot</userinput>
 * alsasound added to runlevel boot
 * rc-update complete.</screen>
            </example>
            <para>Теперь проверьте файл <filename>/etc/conf.d/alsasound</filename> и убедитесь, что переменная <varname>SAVE_ON_STOP</varname> установлена в значение yes, тогда ваши настройки звука при выключении системы будут сохраняться.</para>
        </section>
        <section>
            <title>Группа audio</title>
            <para>Перед тем как начать проверку звука, необходимо сделать одну последнюю важную вещь. Главное правило в операционных системах *nix гласит: «не запускай ничего с правами root, если этого не требуется». И в данной ситуации это правило тоже применимо ;) Каким образом? Пожалуй, большую часть времени вы будете работать под учётной записью пользователя, при этом слушать музыку или иметь доступ к звуковой карте. Чтобы вы могли это делать, вы должны быть в группе audio. Тут то мы и добавим пользователей в эту группу, чтобы у них не было проблем с доступом к аудио устройствам. Мы воспользуемся <command>gpasswd</command>, так что вы должны иметь права root, чтобы сделать это. </para>
            <example>
                <title>Добавление пользователей в группу audio</title>
                <screen><lineannotation>(Замените &lt;имя_пользователя> вашим именем)</lineannotation>
<prompt>#</prompt> <userinput>gpasswd -a <replaceable>&lt;имя_пользователя></replaceable> audio</userinput>
Adding user <replaceable>&lt;имя_пользователя></replaceable> to group audio</screen>
            </example>
        </section>
        <section>
            <title>Проверка громкости!</title>
            <para>Теперь все настройки и необходимые предпосылки выполнены, так что давайте заставим ALSA работать. Если вы запускали утилиту <command>alsaconf</command>, то можете пропустить этот шаг, так как <command>alsaconf</command> уже всё сделал за вас.</para>
            <example>
                <title>Запуск сервиса</title>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/alsasound start</userinput></screen>
            </example>
            <para>Теперь мы позаботились обо всём, что может быть необходимым, нам нужно проверить громкость, так как в определённых случаях звук выключен. Для этого мы воспользуемся <command>alsamixer</command>.</para>
            <example xml:id="gentoo-alsa.listing.alsamixer">
                <title>Запуск <command>alsamixer</command></title>
                <screen><lineannotation>(Откройте в терминале. Будут отображены только требуемые настройки)</lineannotation>
<prompt>#</prompt> <userinput>alsamixer</userinput></screen>
            </example>
            <important>
                <para>Если у вас проблемы с запуском <command>alsamixer</command> и вы получаете ошибки, подобные этой: «alsamixer: function snd_ctl_open failed for default: No such file or directory», то, скорее всего, проблема в том, как демон udev инициализировал устройства. Выполните <command>killall udevd; udevstart</command> для перезагрузки устройств в <filename>/dev</filename> и попробуйте снова <command>alsamixer</command>. Это должно решить проблему.</para>
            </important>
            <para>Вот так может выглядеть микшер ALSA при первом запуске. Обратите внимание, что уровни каналов Master и PCM занижены и что под ними буквы MM. Это означает, что они выключены. Если вы попробуете что-нибудь проиграть, в то время пока <command>alsamixer</command> в таком состоянии, то вы ничего не услышите из ваших динамиков.</para>
            <mediaobject>
                <imageobject role="html">
                    <imagedata fileref="images/alsa/alsa-mixermuted.png" format="PNG" width="100%"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata fileref="../../images/alsa/alsa-mixermuted.png" format="PNG" width="100%"/>
                </imageobject>
                <caption>
                    <para>Главное окно микшера ALSA, каналы выключены</para>
                </caption>
            </mediaobject>
            <para>Для начала включим каналы и установим необходимые уровни громкости.</para>
            <warning>
                <para>Оба канала Master и PCM должны быть включены и установлены в слышимый уровень громкости, если вы хотите услышать что-нибудь из ваших динамиков. </para>
            </warning>
            <orderedlist>
                <listitem>
                    <para>Для перемещения между каналами используйте клавиши влево и вправо. (<keycap>&lt;-</keycap> и <keycap>-&gt;</keycap>). </para>
                </listitem>
                <listitem>
                    <para>Для того чтобы выключить/включить канал, например Master, выберите его и нажмите клавишу <keycap>m</keycap>. </para>
                </listitem>
                <listitem>
                    <para>Чтобы увеличить или уменьшить уровень громкости, используйте клавиши вверх и вниз. </para>
                </listitem>
            </orderedlist>
            <note>
                <para>Будьте осторожны при установке значений для Bass и Treble. Обычно для обоих оптимально значение 50. Слишком высокие значения Bass могут вызвать дребезжание неспособных воспроизводить глубокие басы динамиков.</para>
            </note>
            <para>После того как вы всё сделаете, ваш микшер ALSA должен выглядеть, так, как это показано ниже. Заметьте, что вместо MM стоит 00 и уровни громкости в оптимальном значении.</para>
            <mediaobject>
                <imageobject role="html">
                    <imagedata fileref="images/alsa/alsa-mixerunmuted.png" format="PNG" width="100%"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata fileref="../../images/alsa/alsa-mixerunmuted.png" format="PNG" width="100%"/>
                </imageobject>
                <caption>
                    <para>Микшер ALSA готов зажигать</para>
                </caption>
            </mediaobject>
        </section>
        <section>
            <title>Проверка звука!</title>
            <para>Наконец-то. Какие-нибудь звуки. Если всё прошло успешно, то теперь вы сможете услышать музыку. Быстрый способ проверить — это воспользоваться консольной командой, наподобие <package>media-sound/madplay</package>. Вы также можете использовать что-нибудь более известное, например, <package>mpg123</package>. Если вы поклонник формата OGG, используйте программу <command>ogg123</command> из пакета <package>media-sound/vorbis-tools</package>. Используйте любой удобный для вас плеер. Как всегда, <command>emerge</command> — всё что вам нужно.</para>
            <example>
                <title>Установка программ</title>
                <screen><lineannotation>(Установка необходимых приложений)</lineannotation>
<prompt>#</prompt> <userinput>emerge madplay mpg123</userinput>
<lineannotation>(Для проигрывания ogg-файлов)</lineannotation>
<prompt>#</prompt> <userinput>emerge vorbis-tools</userinput></screen>
            </example>
            <para>А теперь проиграем ваш любимый саундтрек... </para>
            <example>
                <title>Проигрывание музыки</title>
                <screen><prompt>#</prompt> <userinput>madplay -v /mnt/shyam/Music/Paul\ Oakenfold\ -\ Dread\ Rock.mp3</userinput>
MPEG Audio Decoder 0.15.2 (beta) - Copyright (C) 2000-2004 Robert Leslie et al.
          Title: Dread Rock
         Artist: Paul Oakenfold
          Album: Matrix Reloaded
           Year: 2003
          Genre: Soundtrack
                 Soundtrack
 00:04:19 Layer III, 160 kbps, 44100 Hz, joint stereo (MS), no CRC

<prompt>#</prompt> <userinput>ogg123 Paul\ Oakenfold\ -\ Dread\ Rock.ogg</userinput>
Audio Device:   Advanced Linux Sound Architecture (ALSA) output

Playing: Paul Oakenfold - Dread Rock.ogg
Ogg Vorbis stream: 2 channel, 44100 Hz
Genre: Soundtrack
Transcoded: mp3;160
Title: Dread Rock
Artist: Paul Oakenfold
Date: 2003
Album: Matrix Reloaded
Time: 00:11.31 [04:28.75] of 04:40.06  (200.6 kbps)  Output Buffer  96.9%</screen>
            </example>
        </section>
        <section>
            <title>ALSA и USE</title>
            <para>Теперь, для того чтобы приложения, поддерживающие ALSA, были собраны с поддержкой оной, вам нужно добавить USE-флаг <code>alsa</code> в файл <filename>/etc/make.conf</filename>. Некоторые архитектуры, например, x86 и amd64, включают этот флаг по умолчанию.</para>
        </section>
        <section>
            <title>Проблемы?</title>
            <para>Если по каким-либо причинам вы не слышите звука, перво-наперво проверьте настройки <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.listing.alsamixer">alsamixer</link>. 80% всех проблем заключаются в выключенных каналах или низкой громкости. Кроме того, проверьте звуковой апплет вашего оконного менеджера и удостоверьтесь, что громкости каналов установлены на слышимом уровне. </para>
            <para><filename>/proc</filename> — ваш друг. В этом случае, <filename>/proc/asound</filename> — ваш лучший друг. Мы бегло просмотрим, сколько полезной информации доступно нам здесь. </para>
            <example>
                <title>Развлечение с <filename>/proc/asound</filename></title>
                <screen><lineannotation>(Прежде всего, если /proc/asound/cards отображает вашу карту, то ALSA
распознала вашу звуковую карту.)</lineannotation>
<prompt>#</prompt> <userinput>cat /proc/asound/cards</userinput>
0 [Live           ]: EMU10K1 - Sound Blaster Live!
                     Sound Blaster Live! (rev.6, serial:0x80271102) at 0xb800, irq 11

<lineannotation>(Следующая команда оторбразит текущую версию ALSA)</lineannotation>
<prompt>#</prompt> <userinput>cat /proc/asound/version</userinput>
Advanced Linux Sound Architecture Driver Version 1.0.8 (Thu Jan 13 09:39:32 2005 UTC).

<lineannotation>(Подробности эмуляции OSS в ALSA)</lineannotation>
<prompt>#</prompt> <userinput>cat /proc/asound/oss/sndstat</userinput>
Sound Driver:3.8.1a-980706 (ALSA v1.0.8 emulation code)
Kernel: Linux airwolf.zion 2.6.11ac1 #2 Wed May 4 00:35:08 IST 2005 i686
Config options: 0

Installed drivers:
Type 10: ALSA emulation

Card config:
Sound Blaster Live! (rev.6, serial:0x80271102) at 0xb800, irq 11

Audio devices:
0: EMU10K1 (DUPLEX)

Synth devices: NOT ENABLED IN CONFIG

Midi devices:
0: EMU10K1 MPU-401 (UART)

Timers:
7: system timer

Mixers:
0: SigmaTel STAC9721/23</screen>
            </example>
            <para>Другой очень распространённой проблемой среди пользователей является странная ошибка «Unknown symbol in module» («Неизвестный символ в модуле»). Пример её появления показан ниже.</para>
            <example>
                <title>Ошибка: неизвестный символ в модуле</title>
                <screen><prompt>#</prompt> <userinput>/etc/init.d/alsasound start</userinput>
 * Loading ALSA modules ...
 *   Loading: snd-card-0 ...                                              [ ok ]
 *   Loading: snd-pcm-oss ...
WARNING: Error inserting snd_mixer_oss
(/lib/modules/2.6.12-gentoo-r6/kernel/sound/core/oss/snd-mixer-oss.ko): Unknown
symbol in module, or unknown parameter (see dmesg) FATAL: Error inserting
snd_pcm_oss
(/lib/modules/2.6.12-gentoo-r6/kernel/sound/core/oss/snd-pcm-oss.ko): Unknown
symbol in module, or unknown parameter (see dmesg)
                                                                          [ !! ]
 *   Loading: snd-mixer-oss ...
FATAL: Error inserting snd_mixer_oss
(/lib/modules/2.6.12-gentoo-r6/kernel/sound/core/oss/snd-mixer-oss.ko): Unknown
symbol in module, or unknown parameter (see dmesg)
                                                                          [ !! ]
 *   Loading: snd-seq ...                                                 [ ok ]
 *   Loading: snd-emu10k1-synth ...                                       [ ok ]
 *   Loading: snd-seq-midi ...                                            [ ok ]
 * Restoring Mixer Levels ...                                             [ ok ]</screen>
            </example>
            <para>И если, как советуют, просмотреть вывод <command>dmesg</command>, то, скорее всего, можно увидеть следующее:</para>
            <example>
                <title>Вывод <command>dmesg</command></title>
                <screen><lineannotation>(Показаны только относящиеся к делу части вывода)</lineannotation>
<prompt>#</prompt> <userinput>dmesg | less</userinput>
ACPI: PCI Interrupt 0000:02:06.0[A] -> Link [APC3] -> GSI 18 (level, low) -> IRQ 209
snd_mixer_oss: Unknown symbol snd_unregister_oss_device
snd_mixer_oss: Unknown symbol snd_register_oss_device
snd_mixer_oss: Unknown symbol snd_mixer_oss_notify_callback
snd_mixer_oss: Unknown symbol snd_oss_info_register
snd_pcm_oss: Unknown symbol snd_unregister_oss_device
snd_pcm_oss: Unknown symbol snd_register_oss_device
snd_pcm_oss: Unknown symbol snd_mixer_oss_ioctl_card
snd_pcm_oss: Unknown symbol snd_oss_info_register
snd_mixer_oss: Unknown symbol snd_unregister_oss_device
snd_mixer_oss: Unknown symbol snd_register_oss_device
snd_mixer_oss: Unknown symbol snd_mixer_oss_notify_callback
snd_mixer_oss: Unknown symbol snd_oss_info_register</screen>
            </example>
            <para>Эта проблема вызвана переключением с <package>alsa-driver</package> на драйверы, предоставляемые ядром, потому что когда вы удаляете <package>alsa-driver</package>, то файлы модулей сохраняются системой защиты конфигурации. И поэтому, когда вы переходите на встроенные в ядро драйверы, попытка modprobe выдаст вам смесь модулей из <package>alsa-driver</package> и встоенных в ядро, вызывая приведённые выше ошибки. </para>
            <para>Решение очень простое. Удалите вызывающий проблемы каталог после удаления <package>alsa-driver</package>. Проверьте, что удаляете модули правильной, но не текущей версии ядра! </para>
            <example>
                <title>Удаление модулей alsa-driver</title>
                <screen><prompt>#</prompt> <userinput>rm -rf /lib/modules/$(uname -r)/alsa-driver</userinput></screen>
            </example>
            <para>Другой причиной подобных сообщений может являться файл в <filename>/etc/modules.d</filename>, содержащий параметр device_mode, в то время как он не требуется. Проверьте, так ли это, и выясните, какой файл является источником проблем.</para>
            <example>
                <title>Подтверждение проблемы и поиск device_mode</title>
                <screen><lineannotation>(Проверим вывод dmesg для идентификации проблемы)</lineannotation>
<prompt>#</prompt> <userinput>dmesg | grep device_mode</userinput>
snd: Unknown parameter `device_mode'
<lineannotation>(И теперь найдём источник проблемы)</lineannotation>
<prompt>#</prompt> <userinput>grep device_mode /etc/modules.d/*</userinput></screen>
            </example>
            <para>Обычно это файл с именем alsa, в котором присутствует строка options snd device_mode=0666. Удалите эту строку и перезапустите службу alsasound. Это должно решить проблему.</para>
        </section>
    </section>
    <section>
        <title>Другие возможности ALSA</title>
        <section xml:id="gentoo-alsa.midi">
            <title>Настройка поддержки MIDI</title>
            <para>Сначала проверьте, что у вас включён USE-флаг midi в файле /etc/make.conf. Если вы до сих пор этого не сделали, то сделайте это сейчас. Помимо этого вам потребуется пересобрать все пакеты ALSA, использующие флаг midi: alsa-lib, alsa-utils и alsa-driver. </para>
            <para>Если ваша карта имеет встроенный MIDI синтезатор и вы хотите слушать *.mid файлы, вам придётся установить пакет awesfx, содержащий основной набор программ для управления драйвером AWE32. Сначала вам надо установить его. Если у вас нет синтезатора, вы можете использовать виртуальный. Обратитесь к разделу <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.gentoo.org/doc/ru/alsa-guide.xml#vsynth">виртуальные синтезаторы</link> для дополнительной информации.</para>
            <example>
                <title>Установка awesfx</title>
                <screen><prompt>#</prompt> <userinput>emerge awesfx</userinput></screen>
            </example>
            <note>
                <para>Вам понадобится скопировать файлы банка звуков (SoundFont: SF2) с компакт-диска с драйверами для вашей звуковой карты или установленные в Windows в каталог <filename>/usr/share/sounds/sf2/</filename>. Например, файл банка звуков для карты Creative SBLive! может называться <filename>8MBGMSFX.SF2</filename>.</para>
            </note>
            <para>После копирования файлов банка звуков мы сможем проигрывать midi-файлы. Также, для того чтобы банк звуков загружался каждый раз при загрузке системы, вы можете добавить команду asfxload в <filename>/etc/conf.d/local.start</filename>.</para>
            <note>
                <para>Использованные ниже пути, начинающиеся с /<filename>mnt</filename>, не применимы для вашего компьютера. Они являются примерами. Пожалуйста, будьте осторожны при изменении путей на соответствующие вашей системе.</para>
            </note>
            <example>
                <title>Загрузка сэмплов</title>
                <screen><lineannotation>(Сначала копируем файл с банком звуков)</lineannotation>
<prompt>#</prompt> <userinput>cp /mnt/win2k/Program\ Files/CreativeSBLive2k/SFBank/8MBGMSFX.SF2 /usr/share/sounds/sf2/</userinput>
<lineannotation>(Или берём его с компакт-диска SoundBlaster)</lineannotation>
<prompt>#</prompt> <userinput>cp /mnt/cdrom/AUDIO/ENGLISH/SFBANK/8MBGMSFX.SF2 /usr/share/sounds/sf2/</userinput>
<lineannotation>(Загружаем определённый банк звуков)</lineannotation>
<prompt>#</prompt> <userinput>asfxload /usr/share/sounds/sf2/8MBGMSFX.SF2</userinput></screen>
            </example>
            <para>Теперь вы можете проигрывать midi-файлы, используя программу, подобную <command>aplaymidi</command>. Запустите <command>aplaymidi -l</command>, чтобы получить список доступных портов, а затем задействуйте один из них для проигрывания файла.</para>
            <example xml:id="gentoo-alsa.listing.play_midi">
                <title>Проигрывание MIDI</title>
                <screen><lineannotation>(Проверка открытых портов)</lineannotation>
<prompt>#</prompt> <userinput>aplaymidi -l</userinput>
 Port    Client name                      Port name
 64:0    EMU10K1 MPU-401 (UART)           EMU10K1 MPU-401 (UART)
 65:0    Emu10k1 WaveTable                Emu10k1 Port 0
 65:1    Emu10k1 WaveTable                Emu10k1 Port 1
 65:2    Emu10k1 WaveTable                Emu10k1 Port 2
 65:3    Emu10k1 WaveTable                Emu10k1 Port 3
<lineannotation>(Выбираем порт и проигрываем mid-файл)</lineannotation>
<prompt>#</prompt>  <userinput>aplaymidi --port=65:0 /mnt/shyam/music/midi/mi2.mid</userinput></screen>
            </example>
        </section>
        <section>
            <title>Виртуальные синтезаторы</title>
            <para>Если у вашей карты отсутствует встроенный синтезатор, вы можете использовать виртуальный, например, <package>timidity++</package>. Установка происходит на одном дыхании.</para>
            <example>
                <title>Установка <package>timidity++</package></title>
                <screen><prompt>#</prompt> <userinput>emerge timidity++</userinput></screen>
            </example>
            <para>Чтобы timidity воспроизводил звуки, ему нужен набор сэмплов (или банк звуков). К счастью, вместе с пакетом устанавливаются несколько банков звуков. Есть ещё несколько пакетов с банками звуков в Portage, например, <package>timidity-freepats</package> и <package>timidity-eawpatches</package>. Вы можете установить несколько банков звуков, а также можете разместить собственный банк звуков в каталог /usr/share/timidity/. Для переключения timidity между разными банками звуков используйте <command>eselect</command>.</para>
            <example>
                <title>Изменение конфигураций</title>
                <screen><prompt>#</prompt> <userinput>eselect timidity list</userinput>
<prompt>#</prompt> <userinput>eselect timidity set eawpatches</userinput></screen>
            </example>
            <para>Не забудьте добавить timidity в основной уровень исполнения.</para>
            <example>
                <title>Добавление timidity в основной уровень исполнения</title>
                <screen><prompt>#</prompt> <userinput>rc-update add timidity default</userinput>
<prompt>#</prompt> <userinput>/etc/init.d/timidity start</userinput></screen>
            </example>
            <para>Теперь вы можете попробовать <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#gentoo-alsa.listing.play_midi">проиграть MIDI</link> файлы.</para>
        </section>
        <section>
            <title>Утилиты и Firmware</title>
            <para>Для некоторых звуковых карт могут быть полезны утилиты из пакетов <package>alsa-tools</package> и <package>alsa-firmware</package>. Вы можете установить любой из этих пакетов, просто запустив <command>emerge</command>.</para>
            <example>
                <title>Установка утилит ALSA</title>
                <screen><prompt>#</prompt> <userinput>emerge alsa-tools</userinput></screen>
            </example>
        </section>
        <section>
            <title>Несколько звуковых карт</title>
            <para>Вы можете использовать больше одной звуковой карты, при условии что вы собрали ALSA как модули ядра (или из пакета <package>alsa-driver</package>). Сначала в файле <filename>/etc/modules.d/alsa</filename> вам следует лишь указать, какая из карт должна быть запущена первой. В этом файле карты идентифицируются по именам своих драйверов. 0 означает первую карту, 1 — вторую, и так далее. Вот пример для системы, в которой присутствуют две звуковые карты. </para>
            <example>
                <title>Две карты в файле <filename>/etc/modules.d/alsa</filename></title>
                <programlisting>options snd-emu10k1 index=0
options snd-via82xx index=1</programlisting>
            </example>
            <para>Или если у вас две карты, использующие один и тот же драйвер, то их следует указать на одной строке, разделяя цифры запятой. Ниже приведён пример системы, в которой установлено три звуковые карты, две из которых являются картами Intel High Definition Audio. </para>
            <example>
                <title>Несколько звуковых карт в <filename>/etc/modules.d/alsa</filename></title>
                <programlisting>options snd-ymfpci index=0
options snd-hda-intel index=1,2</programlisting>
            </example>
        </section>
        <section>
            <title>Модули расширения</title>
            <para>Для расширения возможностей ALSA вы можете установить дополнительные расширения. Пакет <package>alsa-plugins</package> является собранием полезных модулей расширения, который включает: модуль вывода PulseAudio, конвертер частоты дискретизации, jack (аудио сервер с малым временем задержки) и кодек, позволяющий вам выводить шестиканальный звук через цифровой S/PDIF-вывод (оптический или коаксиальный). Вы можете выбрать те расширения, которые вы хотите установить, добавив соответствующие USE-флаги в <filename>/etc/portage/package.use</filename>. </para>
            <example>
                <title>Установка alsa-plugins</title>
                <programlisting><prompt>#</prompt> <userinput>emerge -avt alsa-plugins</userinput></programlisting>
            </example>
        </section>
        <section>
            <title>Огромное спасибо вам всем...</title>
            <para>Всем, кто принимал участие в написании ранних версий руководства ALSA в Gentoo: Vincent Verleye, Grant Goodyear, Arcady Genkin, Jeremy Huddleston, John P. Davis, Sven Vermeulen, Benny Chuang, Tiemo Kieft и Erwin. А также Dr][aM за перевод ранней версии руководства на русский язык. </para>
        </section>
        <section>
            <title>Ссылки</title>
            <orderedlist>
                <listitem>
                    <para>
                        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.alsa-project.org/">Домашняя страница проекта ALSA</link>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://linux-sound.org/">Linux Sound/MIDI Software</link>
                    </para>
                </listitem>
            </orderedlist>
        </section>
    </section>
</article>
